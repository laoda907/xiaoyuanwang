<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- ğŸ”§ ä¿®å¤ï¼šæ·»åŠ  async defer é˜²æ­¢é˜»å¡ -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js" async defer></script>
    
    <!-- ğŸ”§ ä¿®å¤ï¼šåŠ è½½ä¿æŠ¤è„šæœ¬ -->
    <script>
    // é˜²æ­¢FirebaseåŠ è½½å¡æ­»é¡µé¢
    window._firebaseReady = false;
    window._pageLoaded = false;
    
    // é¡µé¢åŠ è½½å®Œæˆæ ‡è®°
    document.addEventListener('DOMContentLoaded', function() {
        window._pageLoaded = true;
        console.log('âœ… DOMåŠ è½½å®Œæˆ');
        
        // ç¡®ä¿æŒ‰é’®åˆå§‹çŠ¶æ€æ­£å¸¸
        setTimeout(function() {
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
                btn.style.cursor = 'pointer';
            });
        }, 500);
    });
    
    // ç›‘æ§FirebaseåŠ è½½çŠ¶æ€
    let firebaseCheckCount = 0;
    const checkFirebase = setInterval(function() {
        firebaseCheckCount++;
        
        if (typeof firebase !== 'undefined') {
            clearInterval(checkFirebase);
            window._firebaseReady = true;
            console.log('âœ… FirebaseåŠ è½½æˆåŠŸ');
            
            // åˆå§‹åŒ–Firebase
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
                        authDomain: "laoda907-22511.firebaseapp.com",
                        databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
                        projectId: "laoda907-22511",
                        storageBucket: "laoda907-22511.firebasestorage.app",
                        messagingSenderId: "176173610464",
                        appId: "1:176173610464:web:3ff86202f9b05f24b36785"
                    });
                    console.log('âœ… Firebaseåˆå§‹åŒ–æˆåŠŸ');
                }
            } catch(e) {
                console.warn('Firebaseåˆå§‹åŒ–è­¦å‘Š:', e);
            }
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            updateStatus('Firebaseå°±ç»ª');
            
        } else if (firebaseCheckCount > 30) { // 30ç§’åæ”¾å¼ƒ
            clearInterval(checkFirebase);
            console.warn('âš ï¸ FirebaseåŠ è½½è¶…æ—¶ï¼Œç»§ç»­ä½¿ç”¨é¡µé¢');
            updateStatus('FirebaseåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨åŸºç¡€åŠŸèƒ½');
            
            // å³ä½¿Firebaseæ²¡åŠ è½½ï¼Œä¹Ÿè¦ç¡®ä¿é¡µé¢å¯ç”¨
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
                btn.onclick = function() {
                    if (!window._firebaseReady) {
                        alert('ç½‘ç»œè¿æ¥è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ');
                        return false;
                    }
                };
            });
        }
    }, 1000);
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(text) {
        const statusEl = document.getElementById('statusText');
        if (statusEl) statusEl.textContent = text;
    }
    
    // å…¨å±€é”™è¯¯å¤„ç† - é˜²æ­¢å¡æ­»
    window.onerror = function(msg, url, line, col, error) {
        console.warn('âš ï¸ é¡µé¢é”™è¯¯ï¼ˆå·²æ•è·ï¼‰:', msg);
        return true; // é˜»æ­¢é»˜è®¤é”™è¯¯å¤„ç†
    };
    </script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="loginUser()" id="loginBtn">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="registerUser()" id="registerBtn">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
        
        <!-- ğŸ”§ ä¿®å¤ï¼šæ·»åŠ åŠ è½½çŠ¶æ€æç¤º -->
        <div id="loadingHint" style="
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            text-align: center;
            display: none;
        ">
            <span id="hintText">æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...</span>
            <button onclick="forceContinue()" style="
                margin-left: 10px;
                padding: 3px 8px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            ">è·³è¿‡ç­‰å¾…</button>
        </div>
    </div>

    <script>
        // ========== é…ç½®æ–‡ä»¶ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebasestorage.app",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // ğŸ”§ ä¿®å¤ï¼šå®‰å…¨çš„Firebaseåˆå§‹åŒ–
        let auth = null;
        let database = null;
        
        function initFirebase() {
            if (!window._firebaseReady) {
                showHint('ç­‰å¾…FirebaseåŠ è½½...');
                return false;
            }
            
            try {
                if (typeof firebase === 'undefined') {
                    showHint('FirebaseåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    return false;
                }
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                auth = firebase.auth();
                database = firebase.database();
                
                console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
                hideHint();
                return true;
                
            } catch (error) {
                console.warn("âš ï¸ Firebase åˆå§‹åŒ–è­¦å‘Š:", error);
                showHint('Firebaseåˆå§‹åŒ–ä¸­...');
                return false;
            }
        }
        
        // ğŸ”§ ä¿®å¤ï¼šä¼˜åŒ–IPè·å–ï¼Œé˜²æ­¢å¡æ­»
        async function getUserIP() {
            return new Promise((resolve) => {
                // 5ç§’è¶…æ—¶
                const timeout = setTimeout(() => {
                    resolve('local_ip_' + Date.now());
                }, 5000);
                
                // å°è¯•è·å–IPï¼Œä½†ä¸ä¼šé˜»å¡
                fetch('https://api.ipify.org?format=json')
                    .then(response => response.json())
                    .then(data => {
                        clearTimeout(timeout);
                        resolve(data.ip);
                    })
                    .catch(() => {
                        clearTimeout(timeout);
                        resolve('error_ip');
                    });
            });
        }

        // æ˜¾ç¤º/éšè—æç¤º
        function showHint(text) {
            const hint = document.getElementById('loadingHint');
            const textEl = document.getElementById('hintText');
            if (hint && textEl) {
                textEl.textContent = text;
                hint.style.display = 'block';
            }
        }
        
        function hideHint() {
            const hint = document.getElementById('loadingHint');
            if (hint) hint.style.display = 'none';
        }
        
        function forceContinue() {
            window._firebaseReady = true;
            hideHint();
            if (initFirebase()) {
                showMessage('å·²å¼ºåˆ¶ç»§ç»­ï¼ŒåŠŸèƒ½å¯èƒ½å—é™', 'error');
            }
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            if (!checkReady()) return;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        
        function showLogin() {
            if (!checkReady()) return;
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ£€æŸ¥æ˜¯å¦å°±ç»ª
        function checkReady() {
            if (!window._firebaseReady) {
                showMessage('ç³»ç»ŸåŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', 'error');
                showHint('ç­‰å¾…FirebaseåŠ è½½...');
                return false;
            }
            return true;
        }

        // æ˜¾ç¤º/æ¸…é™¤æ¶ˆæ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        function clearMessage() {
            showMessage('', '');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        async function registerUser() {
            if (!checkReady()) return;
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿Firebaseå·²åˆå§‹åŒ–
            if (!database) {
                if (!initFirebase()) {
                    showMessage('ç³»ç»Ÿæœªå°±ç»ªï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return;
                }
            }
            
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // éªŒè¯
            if (!name || name.length > 8) {
                showMessage('åå­—ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡8ä¸ªå­—', 'error');
                return;
            }
            if (!password || password.length < 6) {
                showMessage('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }
            
            // è·å–ç”¨æˆ·IP
            showMessage('æ³¨å†Œä¸­...', '');
            showHint('æ­£åœ¨è·å–IPåœ°å€...');
            
            try {
                const userIP = await getUserIP();
                hideHint();
                
                // æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
                const ipCheckSnapshot = await database.ref('ip_registrations/' + userIP).once('value');
                if (ipCheckSnapshot.exists()) {
                    showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·ä½¿ç”¨å·²æ³¨å†Œè´¦å·ç™»å½•', 'error');
                    return;
                }
                
                // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
                const encodedName = encodeURIComponent(name);
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const nameSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (nameSnapshot.exists()) {
                    showMessage('åå­—å·²è¢«ä½¿ç”¨', 'error');
                    return;
                }
                
                // ç”Ÿæˆç”¨æˆ·ID
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // åŠ å¯†å¯†ç 
                const passwordHash = btoa(password + '|' + Date.now()).split('').reverse().join('');
                
                // ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
                const sessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await database.ref('users/' + userId).set({
                    name: name,
                    encodedName: encodedName,
                    passwordHash: passwordHash,
                    sessionToken: sessionToken,
                    ipAddress: userIP,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                
                // è®°å½•ç”¨æˆ·å
                await database.ref('usernames/' + encodedName).set(userId);
                
                // è®°å½•IPæ³¨å†Œä¿¡æ¯
                await database.ref('ip_registrations/' + userIP).set({
                    userId: userId,
                    userName: name,
                    registeredAt: new Date().toISOString()
                });
                
                // å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: sessionToken,
                    ip: userIP,
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1500);
                
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showMessage('æ³¨å†Œå¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'), 'error');
                hideHint();
            }
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function loginUser() {
            if (!checkReady()) return;
            
            // ğŸ”§ ä¿®å¤ï¼šç¡®ä¿Firebaseå·²åˆå§‹åŒ–
            if (!database) {
                if (!initFirebase()) {
                    showMessage('ç³»ç»Ÿæœªå°±ç»ªï¼Œè¯·ç¨åé‡è¯•', 'error');
                    return;
                }
            }
            
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!name || !password) {
                showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
                return;
            }
            
            showMessage('ç™»å½•ä¸­...', '');
            
            // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
            const encodedName = encodeURIComponent(name);
            
            try {
                // æ‰¾ç”¨æˆ·ID
                const idSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (!idSnapshot.exists()) {
                    showMessage('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const userId = idSnapshot.val();
                
                // è·å–ç”¨æˆ·æ•°æ®
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    showMessage('ç”¨æˆ·æ•°æ®é”™è¯¯', 'error');
                    return;
                }
                
                // éªŒè¯å¯†ç 
                try {
                    const reversedHash = userData.passwordHash.split('').reverse().join('');
                    const decoded = atob(reversedHash);
                    const parts = decoded.split('|');
                    if (parts[0] !== password) {
                        throw new Error('å¯†ç ä¸åŒ¹é…');
                    }
                } catch {
                    showMessage('å¯†ç é”™è¯¯', 'error');
                    return;
                }
                
                // ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ
                const newSessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»¤ç‰Œ
                await database.ref('users/' + userId).update({
                    sessionToken: newSessionToken,
                    lastLogin: new Date().toISOString()
                });
                
                // å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: newSessionToken,
                    ip: userData.ipAddress || 'unknown',
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('âœ… ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
                
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('ç™»å½•å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'), 'error');
            }
        }

        // è‡ªåŠ¨è·³è½¬ï¼šå¦‚æœå·²ç»ç™»å½•
        function checkIfLoggedIn() {
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (sessionStr) {
                try {
                    const sessionData = JSON.parse(atob(sessionStr));
                    if (Date.now() < sessionData.expiry) {
                        // å·²ç™»å½•ï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
                        window.location.href = 'main.html';
                    }
                } catch (e) {
                    console.log('ä¼šè¯æ•°æ®æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€');
            
            // ğŸ”§ ä¿®å¤ï¼šå»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…é˜»å¡
            setTimeout(checkIfLoggedIn, 1000);
            
            // ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
            setTimeout(() => {
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
            }, 500);
            
            // æ˜¾ç¤ºåˆå§‹æç¤º
            showHint('æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...');
        });
    </script>
    
    <!-- ğŸ”§ ä¿®å¤ï¼šé¡µé¢çŠ¶æ€ç›‘æ§ -->
    <div id="pageMonitor" style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        z-index: 9999;
        display: none;
    ">
        <div>çŠ¶æ€: <span id="statusText">åŠ è½½ä¸­</span></div>
        <div style="font-size:10px;opacity:0.8;">åŒå‡»æ­¤åŒºåŸŸåˆ·æ–°</div>
    </div>
    
    <script>
    // ç›‘æ§é¡µé¢çŠ¶æ€
    setTimeout(() => {
        const monitor = document.getElementById('pageMonitor');
        if (monitor) {
            monitor.style.display = 'block';
            
            // åŒå‡»åˆ·æ–°
            monitor.addEventListener('dblclick', function() {
                if (confirm('åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                    location.reload();
                }
            });
            
            // æ›´æ–°çŠ¶æ€
            setInterval(() => {
                const status = window._firebaseReady ? 'å°±ç»ª' : 'åŠ è½½ä¸­';
                document.getElementById('statusText').textContent = status;
                monitor.style.background = window._firebaseReady ? 
                    'rgba(76, 175, 80, 0.7)' : 'rgba(255, 152, 0, 0.7)';
            }, 1000);
        }
    }, 2000);
    
    // é˜²æ­¢é¡µé¢å®Œå…¨å¡æ­» - æœ€åçš„å®‰å…¨ç½‘
    setTimeout(() => {
        console.log('å®‰å…¨ç½‘æ¿€æ´»ï¼šç¡®ä¿é¡µé¢å¯æ“ä½œ');
        document.querySelectorAll('button, input, a').forEach(el => {
            el.disabled = false;
            el.style.pointerEvents = 'auto';
        });
        
        // å¦‚æœFirebaseè¿˜æ²¡åŠ è½½ï¼Œæ˜¾ç¤ºæç¤º
        if (!window._firebaseReady) {
            const hint = document.getElementById('loadingHint');
            if (hint) {
                hint.style.display = 'block';
                document.getElementById('hintText').textContent = 
                    'ç½‘ç»œåŠ è½½è¾ƒæ…¢ï¼Œå¯ç‚¹å‡»"è·³è¿‡ç­‰å¾…"ç»§ç»­';
            }
        }
    }, 15000); // 15ç§’åæ¿€æ´»å®‰å…¨ç½‘
    </script>
</body>
</html>
