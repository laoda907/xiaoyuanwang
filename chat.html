<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ–°å‡çº§èŠå¤©å®¤</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 20px;
      font-weight: bold;
    }

    /* å¤šå¹¿åœºæŒ‰é’® */
    #forumBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      gap: 10px;
      font-size: 14px;
    }

    .forumBtn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #16213e;
      color: #fff;
      cursor: pointer;
    }

    .forumBtn.active {
      background: #3498db !important;
    }

    /* èƒŒæ™¯éŸ³ä¹æ  */
    #bgmBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }

    #bgmSelect {
      padding: 6px 10px;
      border-radius: 5px;
      background: #16213e;
      color: #fff;
      border: none;
    }

    /* èŠå¤©åŒº */
    #chatArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .msg {
      background: rgba(255,255,255,0.08);
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      max-width: 75%;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .me {
      background: rgba(52,152,219,0.3);
      margin-left: auto;
    }

    /* è¾“å…¥åŒº */
    #inputBar {
      display: flex;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    #msgInput {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 16px;
      resize: none;
      white-space: pre-wrap;
      outline: none;
    }

    #sendBtn {
      margin-left: 10px;
      padding: 12px 20px;
      background: #3498db;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      color: #fff;
    }
  </style>
</head>

<body>

  <header>ğŸ”¥ å…¨æ–°å‡çº§èŠå¤©å®¤</header>

  <!-- ä¸‰å¤§å¹¿åœº -->
  <div id="forumBar">
    <button class="forumBtn active" data-f="general">ç»¼åˆå¹¿åœº</button>
    <button class="forumBtn" data-f="study">å­¦ä¹ å¹¿åœº</button>
    <button class="forumBtn" data-f="fun">å¨±ä¹å¹¿åœº</button>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ -->
  <div id="bgmBar">
    èƒŒæ™¯éŸ³ä¹é€‰æ‹© â†’  
    <select id="bgmSelect">
      <option value="none">å…³é—­éŸ³ä¹</option>
      <option value="https://music.163.com/song/media/outer/url?id=28907016.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆåŸå£°ï¼‰</option>
      <option value="https://music.163.com/song/media/outer/url?id=22707000.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆé’¢ç´ï¼‰</option>
      <option value="https://music.163.com/song/media/outer/url?id=1387202414.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆæ²»æ„ˆç‰ˆï¼‰</option>
    </select>
  </div>

  <!-- æ’­æ”¾å™¨ -->
  <audio id="bgmPlayer" loop></audio>

  <div id="chatArea"></div>

  <div id="inputBar">
    <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
    <button id="sendBtn">å‘é€</button>
  </div>

  <!-- ==================== JavaScript ==================== -->
<script>
/* ---------------- Firebase åˆå§‹åŒ– ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
  authDomain: "laoda907-22511.firebaseapp.com",
  databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laoda907-22511",
  storageBucket: "laoda907-22511.appspot.com",
  messagingSenderId: "176173610464",
  appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- å…¨å±€å˜é‡ ---------------- */
let forum = "general"; // å½“å‰å¹¿åœº
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("msgInput");
const btn = document.getElementById("sendBtn");

const currentUserId = "user_" + Math.random().toString(36).slice(2, 9);

/* ---------------- èƒŒæ™¯éŸ³ä¹ ---------------- */
const bgmPlayer = document.getElementById("bgmPlayer");
const bgmSelect = document.getElementById("bgmSelect");

bgmSelect.onchange = () => {
  const url = bgmSelect.value;
  if (url === "none") {
    bgmPlayer.pause();
  } else {
    bgmPlayer.src = url;
    bgmPlayer.volume = 0.5;
    bgmPlayer.play();
  }
};

/* ---------------- æ˜¾ç¤ºæ¶ˆæ¯ ---------------- */
function addMsg(text, self = false) {
  const div = document.createElement("div");
  div.className = "msg" + (self ? " me" : "");
  div.textContent = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ---------------- åŠ è½½æ¶ˆæ¯ ---------------- */
function loadMessages() {
  chatArea.innerHTML = "";

  db.ref(`forums/${forum}/messages`)
    .limitToLast(200)
    .on("child_added", snap => {
      const msg = snap.val();
      addMsg(msg.text, msg.userId === currentUserId);
    });
}

/* ---------------- å‘é€æ¶ˆæ¯ ---------------- */
function sendMessage() {
  let text = input.value.trim();
  if (!text) return;

  db.ref(`forums/${forum}/messages`).push({
    userId: currentUserId,
    text,
    timestamp: Date.now()
  });

  input.value = "";
  addMsg(text, true);
}

/* ---------------- äº‹ä»¶ç»‘å®š ---------------- */
btn.onclick = sendMessage;

input.onkeydown = (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
};

/* ---------------- å¹¿åœºåˆ‡æ¢ ---------------- */
document.querySelectorAll(".forumBtn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".forumBtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    forum = btn.dataset.f;
    loadMessages();
  };
});

/* ---------------- åˆå§‹åŒ–åŠ è½½ ---------------- */
loadMessages();

</script>

</body>
</html>
