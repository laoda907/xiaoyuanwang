<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ–°å‡çº§èŠå¤©å®¤</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 20px;
      font-weight: bold;
      z-index: 3;
    }

    #forumBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      gap: 10px;
      font-size: 14px;
      z-index: 3;
    }

    .forumBtn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #16213e;
      color: #fff;
      cursor: pointer;
    }

    .forumBtn.active {
      background: #3498db !important;
    }

    #bgmBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 3;
    }

    #bgmSelect {
      padding: 6px 10px;
      border-radius: 5px;
      background: #16213e;
      color: #fff;
      border: none;
    }

    #chatArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      z-index: 3;
    }

    /* èŠå¤©å¸ƒå±€ */
    .msgWrapper {
      display: flex;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .msgWrapper.me {
      justify-content: flex-end;
    }

    /* ğŸŒˆ å¤´åƒåŠæ¸å˜å…‰åœˆ */
    .avatarWrapper {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      padding: 3px;
      background: conic-gradient(from 0deg, #8bd3ff, #b28bff, #ff8bd4, #8bd3ff);
      animation: rotateGlow 4s linear infinite;
      margin-right: 10px;
      flex-shrink: 0;
    }

    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .msgWrapper.me .avatarWrapper {
      margin-left: 10px;
      margin-right: 0;
    }

    .avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      user-select: none;
    }

    .msgBubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.08);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .msgWrapper.me .msgBubble {
      background: rgba(52,152,219,0.3);
    }

    .msgName {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 3px;
    }

    /* è¾“å…¥æ  */
    #inputBar {
      display: flex;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 3;
    }

    #msgInput {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 16px;
      resize: none;
      outline: none;
      white-space: pre-wrap;
    }

    #sendBtn {
      margin-left: 10px;
      padding: 12px 20px;
      background: #3498db;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      color: #fff;
    }

    /* Canvas é›ªèŠ±å±‚ */
    #snowCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>

<body>

<canvas id="snowCanvas"></canvas>

<header>ğŸ”¥ å…¨æ–°å‡çº§èŠå¤©å®¤</header>

<div id="forumBar">
  <button class="forumBtn active" data-f="general">ç»¼åˆå¹¿åœº</button>
  <button class="forumBtn" data-f="study">å­¦ä¹ å¹¿åœº</button>
  <button class="forumBtn" data-f="fun">å¨±ä¹å¹¿åœº</button>
</div>

<div id="bgmBar">
  <span>èƒŒæ™¯éŸ³ä¹ï¼š</span>
  <select id="bgmSelect">
    <option value="none">å…³é—­</option>
    <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20110423105222-NTk0NTM5.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆåŸç‰ˆï¼‰</option>
    <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20160709113245-MjU1ODA3.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆé’¢ç´ï¼‰</option>
  </select>

  <button id="snowToggle" style="
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 6px;
      border: none;
      background: #3498db;
      color: white;
      cursor: pointer;
  ">â„ ä¸‹é›ª</button>
</div>

<audio id="bgmPlayer" loop></audio>

<div id="chatArea"></div>

<div id="inputBar">
  <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
  <button id="sendBtn">å‘é€</button>
</div>

<script>
/* ========== ç”¨æˆ·ç™»å½•ä¿¡æ¯è¯»å– ========== */
function getUserSession() {
  const str = localStorage.getItem("xiaoyuan_session");
  if (!str) return null;

  try {
    const decoded = atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
    return JSON.parse(decodeURIComponent(decoded));
  } catch (e) { return null; }
}

const SESSION = getUserSession();
const USER_NAME = SESSION ? SESSION.userName : "åŒ¿åç”¨æˆ·";
const USER_ID = SESSION ? SESSION.userId : ("user_" + Math.random().toString(36).slice(2, 10));

/* ========== Firebase ========== */
const firebaseConfig = {
  apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
  authDomain: "laoda907-22511.firebaseapp.com",
  databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laoda907-22511",
  storageBucket: "laoda907-22511.appspot.com",
  messagingSenderId: "176173610464",
  appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== DOM ========== */
let forum = "general";
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const forumButtons = document.querySelectorAll(".forumBtn");

/* ========== æ¸…ç†æ§åˆ¶ç¬¦ ========== */
function cleanText(text) {
  return text.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "");
}

/* ========== å¤´åƒç³»ç»Ÿ ========== */
function getAvatarLetter(name) { return name[0]; }
function getAvatarColor(name) {
  const colors = ["#3498db","#9b59b6","#e67e22","#e91e63","#1abc9c","#f39c12"];
  let sum = 0; for (let i = 0; i < name.length; i++) sum += name.charCodeAt(i);
  return colors[sum % colors.length];
}

/* ========== æ˜¾ç¤ºæ¶ˆæ¯ ========== */
function addMsg(msg) {
  const isOwn = msg.userId === USER_ID;

  const wrapper = document.createElement("div");
  wrapper.className = "msgWrapper" + (isOwn ? " me" : "");

  const avatarW = document.createElement("div");
  avatarW.className = "avatarWrapper";

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.style.background = getAvatarColor(msg.userName);
  avatar.textContent = getAvatarLetter(msg.userName);

  avatarW.appendChild(avatar);

  const bubble = document.createElement("div");
  bubble.className = "msgBubble";

  const nameTag = document.createElement("div");
  nameTag.className = "msgName";
  nameTag.textContent = msg.userName;

  const textTag = document.createElement("div");
  textTag.textContent = msg.text;

  bubble.appendChild(nameTag);
  bubble.appendChild(textTag);

  if (isOwn) {
    wrapper.appendChild(bubble);
    wrapper.appendChild(avatarW);
  } else {
    wrapper.appendChild(avatarW);
    wrapper.appendChild(bubble);
  }

  chatArea.appendChild(wrapper);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ========== æ™ºèƒ½è¿‡æ»¤ï¼ˆä¸è¯¯ä¼¤å•å­—ï¼‰ ========== */
const SMART_BAD_WORD_PATTERNS = [
  /æ“ä½ å¦ˆ|è‰ä½ å¦ˆ|è‰¹ä½ å¦ˆ|æˆ‘æ“ä½ å¦ˆ/gi,
  /å‚»é€¼|æ²™æ¯”|ç…ç¬”|å‚»å±Œ|å‚»å¼/gi,
  /å¦ˆçš„|ä»–å¦ˆçš„/gi,
  /æ­»å¦ˆ|ä½ å¦ˆæ­»äº†/gi,
  /æ‚ç§|è´±äºº|å©Šå­/gi,
  /å‚»[\s\-\*_]+é€¼/gi,
  /\bsha[\s\.\-\*_]*bi\b/gi,
  /\bsb\b/gi,
  /\bs[\s\.\-\*_]*b\b/gi,
  /\bnm[\s\.\-\*_]*sl\b/gi,
  /\bnmsl\b/gi
];

function smartFilter(text) {
  SMART_BAD_WORD_PATTERNS.forEach(p => {
    text = text.replace(p, m => "*".repeat(m.length));
  });
  return text;
}

/* ========== åŠ è½½æ¶ˆæ¯ ========== */
let currentMessagesRef = null;

function attachMessagesListener() {
  chatArea.innerHTML = "";

  if (currentMessagesRef) currentMessagesRef.off();

  const ref = db.ref("forums/" + forum + "/messages");
  currentMessagesRef = ref;

  ref.limitToLast(200).on("child_added", snap => {
    const msg = snap.val();
    addMsg({
      userId: msg.userId,
      userName: msg.userName,
      text: cleanText(msg.text)
    });
  });
}

/* ========== å‘é€æ¶ˆæ¯ ========== */
function sendMessage() {
  let raw = input.value;
  let text = cleanText(raw.trim());
  if (!text) return;

  text = smartFilter(text);

  db.ref("forums/" + forum + "/messages").push({
    userId: USER_ID,
    userName: USER_NAME,
    text: text,
    timestamp: Date.now()
  });

  input.value = "";
  input.focus();
}

sendBtn.addEventListener("click", sendMessage);

/* ========== å¹¿åœºåˆ‡æ¢ ========== */
forumButtons.forEach(btn => {
  btn.onclick = () => {
    forumButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    forum = btn.getAttribute("data-f");
    attachMessagesListener();
  };
});

attachMessagesListener();

/* ========== èƒŒæ™¯éŸ³ä¹ ========== */
const bgmPlayer = document.getElementById("bgmPlayer");
document.getElementById("bgmSelect").onchange = () => {
  if (bgmSelect.value === "none") bgmPlayer.pause();
  else { bgmPlayer.src = bgmSelect.value; bgmPlayer.play(); }
};

/* ========== â„ Canvas GPU é›ªèŠ±ï¼ˆä¸å¡ç‰ˆæœ¬ï¼‰ ========== */
const canvas = document.getElementById("snowCanvas");
const ctx = canvas.getContext("2d");
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

window.onresize = () => {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
};

let snowEnabled = false;
let snowflakes = [];

function createSnowflake() {
  return {
    x: Math.random() * W,
    y: Math.random() * -50,
    r: Math.random() * 3 + 1,
    d: Math.random() * 1 + 0.5,
    drift: Math.random() * 2 - 1
  };
}

function drawSnow() {
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = "white";
  ctx.shadowBlur = 8;
  ctx.shadowColor = "white";

  snowflakes.forEach(f => {
    ctx.beginPath();
    ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
    ctx.fill();
  });
}

function updateSnow() {
  snowflakes.forEach(f => {
    f.y += f.d;
    f.x += f.drift * 0.3;

    if (f.y > H) {
      f.x = Math.random() * W;
      f.y = -10;
    }
  });
}

function snowLoop() {
  if (snowEnabled) {
    if (snowflakes.length < 200) snowflakes.push(createSnowflake());
    drawSnow();
    updateSnow();
  }
  requestAnimationFrame(snowLoop);
}

snowLoop();

document.getElementById("snowToggle").onclick = () => {
  snowEnabled = !snowEnabled;
  document.getElementById("snowToggle").textContent =
    snowEnabled ? "â„ å…³é—­ä¸‹é›ª" : "â„ ä¸‹é›ª";
};
</script>

</body>
</html>
