<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å…¨æ–°å‡çº§èŠå¤©å®¤</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

<style>
/* ======== å…¨å±€ UI ======== */
body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to bottom, #0b1d4a 0%, #000000 100%);
  color: #fff;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
header {
  padding: 15px 20px;
  background: rgba(255,255,255,0.05);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-size: 20px;
  font-weight: bold;
}

/* ======== å¹¿åœºæ  ======== */
#forumBar {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(255,255,255,0.05);
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.forumBtn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  background: #16213e;
  color: #fff;
  cursor: pointer;
}
.forumBtn.active { background: #3498db !important; }
#onlineCount {
  margin-left: auto;
  opacity: 0.85;
  font-size: 14px;
}

/* ======== éŸ³ä¹æ  ======== */
#bgmBar {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.03);
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
#bgmSelect {
  padding: 6px 10px;
  border-radius: 5px;
  background: #16213e;
  color: #fff;
  border: none;
}

/* ======== èŠå¤©åŒºåŸŸ ======== */
#chatArea {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

/* ======== æ¶ˆæ¯å¸ƒå±€ ======== */
.msgWrapper {
  display: flex;
  align-items: flex-start;
  margin-bottom: 14px;
}
.msgWrapper.me { justify-content: flex-end; }

/* ========== æ¸å˜å…‰åœˆå¤´åƒ ========== */
.avatarWrapper {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  padding: 3px;
  background: conic-gradient(from 0deg, #8bd3ff, #b28bff, #ff8bd4, #8bd3ff);
  animation: rotateGlow 4s linear infinite;
  margin-right: 10px;
  flex-shrink: 0;
}
@keyframes rotateGlow {
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
.msgWrapper.me .avatarWrapper {
  margin-left: 10px;
  margin-right: 0;
}
.avatar {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:bold;
  color:white;
}

/* ======== æ¶ˆæ¯æ°”æ³¡ ======== */
.msgBubble {
  max-width: 70%;
  padding: 10px 14px;
  border-radius: 10px;
  white-space: pre-wrap;
  word-break: break-word;
  background: rgba(255,255,255,0.08);
}
.msgWrapper.me .msgBubble {
  background: rgba(52,152,219,0.3);
}
.msgName {
  font-size: 12px;
  opacity: 0.7;
  margin-bottom: 3px;
}

/* ======== è¾“å…¥æ  ======== */
#inputBar {
  display: flex;
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-top: 1px solid rgba(255,255,255,0.1);
}
#msgInput {
  flex:1;
  padding:12px;
  background:rgba(255,255,255,0.15);
  border:none;
  border-radius:8px;
  color:white;
  font-size:16px;
  outline:none;
}
#sendBtn {
  margin-left:10px;
  padding:12px 20px;
  background:#3498db;
  border:none;
  border-radius:8px;
  cursor:pointer;
  color:white;
}

/* ========== DOM é›ªèŠ±ï¼ˆäº®æ™¶æ™¶ä¸å¡ï¼‰ ========== */
.snowflake {
  position: fixed;
  top: -10px;
  color: white;
  font-size: 12px;
  opacity: 0.9;
  pointer-events: none;
  z-index: 9999;
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.9));
  animation: fallSnow linear forwards, flicker 2s ease-in-out infinite;
}
@keyframes fallSnow {
  0% { transform: translateY(0) rotate(0deg);}
  100% { transform: translateY(110vh) rotate(360deg);}
}
@keyframes flicker {
  0%,100%{opacity:0.9;}
  50%{opacity:0.6;}
}

/* ======== æ˜Ÿç©ºå‘å…‰å±‚ ======== */
.stars {
  width: 2px;
  height: 2px;
  background: white;
  position: absolute;
  top: 0;
  border-radius: 50%;
  animation: twinkle 2s infinite ease-in-out;
  opacity: 0.8;
}
@keyframes twinkle {
  0% { opacity: 0.2; box-shadow: 0 0 2px white; }
  50% { opacity: 1; box-shadow: 0 0 6px white; }
  100% { opacity: 0.2; box-shadow: 0 0 2px white; }
}

</style>
</head>

<body>

<!-- æ˜Ÿç©ºç”Ÿæˆ -->
<script>
for (let i = 0; i < 60; i++) {
    const s = document.createElement("div");
    s.className = "stars";
    s.style.left = Math.random() * window.innerWidth + "px";
    s.style.top = Math.random() * 120 + "px";
    s.style.transform = "scale(" + (Math.random() * 1.5 + 0.5) + ")";
    s.style.animationDelay = Math.random() * 2 + "s";
    document.body.appendChild(s);
}
</script>


<header>ğŸ”¥ å…¨æ–°å‡çº§èŠå¤©å®¤</header>

<!-- ======== å¹¿åœºæŒ‰é’® + åœ¨çº¿äººæ•° A1 ======== -->
<div id="forumBar">
  <button class="forumBtn active" data-f="general">ç»¼åˆå¹¿åœº</button>
  <button class="forumBtn" data-f="study">å­¦ä¹ å¹¿åœº</button>
  <button class="forumBtn" data-f="fun">å¨±ä¹å¹¿åœº</button>

  <!-- åœ¨çº¿äººæ•° A1 -->
  <div id="onlineCount">ğŸ‘¥ åœ¨çº¿ï¼š0 äºº</div>
</div>

<!-- ======== èƒŒæ™¯éŸ³ä¹ + ä¸‹é›ª ======== -->
<div id="bgmBar">
  <span>èƒŒæ™¯éŸ³ä¹ï¼š</span>
  <select id="bgmSelect">
    <option value="none">å…³é—­</option>
    <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20110423105222-NTk0NTM5.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆåŸç‰ˆï¼‰</option>
    <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20160709113245-MjU1ODA3.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆé’¢ç´ï¼‰</option>
  </select>

  <button id="snowToggle" style="
      padding:6px 12px;
      margin-left:10px;
      border:none;
      border-radius:6px;
      background:#3498db;
      color:white;
      cursor:pointer;
  ">â„ ä¸‹é›ª</button>
</div>

<audio id="bgmPlayer" loop></audio>

<div id="chatArea"></div>

<div id="inputBar">
  <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
  <button id="sendBtn">å‘é€</button>
</div>

<script>
/* ========= ç”¨æˆ·ç™»å½•è§£æ ========= */
function getUserSession(){
  const str = localStorage.getItem("xiaoyuan_session");
  if(!str) return null;
  try{
    const dec = atob(str).split('')
      .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
    return JSON.parse(decodeURIComponent(dec));
  }catch(e){ return null;}
}
const SESSION = getUserSession();
const USER_NAME = SESSION ? SESSION.userName : "åŒ¿åç”¨æˆ·";
const USER_ID = SESSION ? SESSION.userId : ("user_"+Math.random().toString(36).slice(2,10));

/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey:"AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
  authDomain:"laoda907-22511.firebaseapp.com",
  databaseURL:"https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"laoda907-22511",
  storageBucket:"laoda907-22511.appspot.com",
  messagingSenderId:"176173610464",
  appId:"1:176173610464:web:3ff86202f9b05f24b36785"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========= DOM ========= */
let forum = "general";
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const onlineCount = document.getElementById("onlineCount");

function cleanText(t){
  return t.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,"");
}

/* ========== å¤´åƒç”Ÿæˆ ========== */
function getAvatarLetter(name){ return name[0]; }
function getAvatarColor(name){
  const c=["#3498db","#9b59b6","#e67e22","#e91e63","#1abc9c","#f39c12"];
  let s=0; for(let i=0;i<name.length;i++) s+=name.charCodeAt(i);
  return c[s % c.length];
}

/* ========== æ˜¾ç¤ºæ¶ˆæ¯ ========== */
function addMsg(msg){
  const isOwn = msg.userId === USER_ID;

  const wrap = document.createElement("div");
  wrap.className = "msgWrapper" + (isOwn ? " me":"");

  const avW = document.createElement("div");
  avW.className = "avatarWrapper";
  const av = document.createElement("div");
  av.className = "avatar";
  av.style.background = getAvatarColor(msg.userName);
  av.textContent = getAvatarLetter(msg.userName);
  avW.appendChild(av);

  const bubble = document.createElement("div");
  bubble.className = "msgBubble";
  const name = document.createElement("div");
  name.className = "msgName";
  name.textContent = msg.userName;
  const text = document.createElement("div");
  text.textContent = msg.text;
  bubble.appendChild(name);
  bubble.appendChild(text);

  if(isOwn){
    wrap.appendChild(bubble);
    wrap.appendChild(avW);
  } else {
    wrap.appendChild(avW);
    wrap.appendChild(bubble);
  }

  chatArea.appendChild(wrap);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ========== æ•æ„Ÿè¯è¿‡æ»¤ ========== */
const SMART_BAD = [
  /æ“ä½ å¦ˆ|è‰ä½ å¦ˆ|è‰¹ä½ å¦ˆ|æˆ‘æ“ä½ å¦ˆ/gi,
  /å‚»é€¼|æ²™æ¯”|ç…ç¬”|å‚»å±Œ|å‚»å¼/gi,
  /å¦ˆçš„|ä»–å¦ˆçš„/gi,
  /æ­»å¦ˆ|ä½ å¦ˆæ­»äº†/gi,
  /æ‚ç§|è´±äºº|å©Šå­/gi,
  /å‚»[\s\-\*_]+é€¼/gi,
  /\bsha[\s\.\-\*_]*bi\b/gi,
  /\bsb\b/gi,
  /\bs[\s\.\-\*_]*b\b/gi,
  /\bnm[\s\.\-\*_]*sl\b/gi,
  /\bnmsl\b/gi
];
function smartFilter(t){
  SMART_BAD.forEach(p=>{
    t=t.replace(p,m=>"*".repeat(m.length));
  });
  return t;
}

/* ========== åŠ è½½æ¶ˆæ¯ ========== */
let msgRef = null;
function loadForum(){
  chatArea.innerHTML="";
  if(msgRef) msgRef.off();

  msgRef = db.ref("forums/"+forum+"/messages");
  msgRef.limitToLast(200).on("child_added",snap=>{
    const m = snap.val();
    addMsg({
      userId:m.userId,
      userName:m.userName,
      text:cleanText(m.text)
    });
  });
}

/* ========== å‘é€ ========== */

/* ========= æœ¬åœ° AI å®¡æ ¸ï¼ˆé‡åº¦ï¼‰ ========= */
function localAIModerate(text){
    let t = text.toLowerCase();

    const badWords = [
      "æ“ä½ ","è‰¹ä½ ","è‰ä½ ","nmsl","ä½ å¦ˆæ­»","æ­»å¦ˆ","å¼±æ™º","æ™ºéšœ","å»æ­»","æ»š",
      "å¼ºå¥¸","è¿·å¥¸","æ€§ä¾µ","å¼ºæš´","çº¦ç‚®","æ€§äº¤","å£äº¤","hç‰‡","è£¸ç…§","é»„ç‰‡",
      "å–æ·«","å«–å¨¼","èµŒåš","è¯ˆéª—","æ´—é’±","æ¯’å“","å†°æ¯’","kç²‰","æªæ”¯","çˆ†ç‚¸","ææ€–è¢­å‡»",
      "ä¹ è¿‘å¹³","æ”¿åºœ","å½“å±€","æ”¿æ²»","ååŠ¨","å›å›½","ç¤ºå¨","æŠ—è®®","å›½å®¶æœºå¯†"
    ];
    for(let w of badWords){
        if(t.includes(w)) return false;
    }
    return true;
}

sendBtn.onclick = sendMessage;
function sendMessage(){
  
let t = cleanText(input.value.trim());
if(!localAIModerate(t)){
    alert("âŒ å†…å®¹æ¶‰å«Œè¿è§„ï¼ˆAIé‡åº¦å®¡æ ¸æ‹¦æˆªï¼‰");
    return;
}

  if(!t) return;

  t = smartFilter(t);

  db.ref("forums/"+forum+"/messages").push({
    userId:USER_ID,
    userName:USER_NAME,
    text:t,
    timestamp:Date.now()
  });

  input.value="";
}

/* ========== åˆ‡æ¢å¹¿åœº ========== */
document.querySelectorAll(".forumBtn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".forumBtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    forum = btn.getAttribute("data-f");
    updatePresence();
    loadForum();
  };
});

loadForum();

/* ========== èƒŒæ™¯éŸ³ä¹ ========== */
const bgmPlayer = document.getElementById("bgmPlayer");
document.getElementById("bgmSelect").onchange = ()=>{
  let v = bgmSelect.value;
  if(v==="none") bgmPlayer.pause();
  else{ bgmPlayer.src=v; bgmPlayer.play(); bgmPlayer.loop=true; }
};

/* ========== DOM é›ªèŠ±ï¼ˆä¸å¡ï¼‰ ========== */
let snowEnabled=false;
let snowTimer=null;
let snowCount=0;
const SNOW_MAX=35;

document.getElementById("snowToggle").onclick = ()=>{
  snowEnabled=!snowEnabled;
  snowToggle.textContent = snowEnabled?"â„ å…³é—­ä¸‹é›ª":"â„ ä¸‹é›ª";
  if(snowEnabled) startSnow();
  else stopSnow();
};

function createSnow(){
  if(!snowEnabled || snowCount>=SNOW_MAX) return;

  const s=document.createElement("div");
  s.className="snowflake";
  s.textContent="â„";

  const size=Math.random()*12+8;
  s.style.fontSize=size+"px";
  s.style.left=Math.random()*100+"vw";
  const dur=Math.random()*5+6;
  s.style.animationDuration=dur+"s";

  document.body.appendChild(s);
  snowCount++;

  setTimeout(()=>{
    s.remove();
    snowCount--;
  },dur*1000);
}
function startSnow(){
  if(snowTimer) return;
  snowTimer=setInterval(createSnow,300);
}
function stopSnow(){
  clearInterval(snowTimer);
  snowTimer=null;
}

/* ========== åœ¨çº¿äººæ•°ï¼ˆæ–¹æ¡ˆB + æ˜¾ç¤ºæ–¹å¼A1ï¼‰ ========== */
let presenceRef = null;

function updatePresence(){
  if(presenceRef) presenceRef.remove();

  const userPath = "presence/"+forum+"/"+USER_ID;
  presenceRef = db.ref(userPath);

  presenceRef.onDisconnect().remove();
  presenceRef.set(true);

  db.ref("presence/"+forum).on("value",snap=>{
    const count = snap.numChildren();
    onlineCount.textContent = "ğŸ‘¥ åœ¨çº¿ï¼š"+count+" äºº";
  });
}

updatePresence();
</script>

</body>
</html>
