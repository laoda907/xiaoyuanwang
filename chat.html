<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - èŠå¤©å®¤</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <style>
        /* ========== ç»ˆæä¿®å¤ï¼šæ ¹å±‚CSS ========== */
        html, body {
            height: auto;
            min-height: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%; /* é˜²æ­¢iOSå­—ä½“ç¼©æ”¾ */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top, #2c3e50 0%, #000000 55%, #000000 100%);
            color: #fff;
            overflow-y: auto;
        }

        /* ========== å¸ƒå±€åŸºç¡€ ========== */
        .chat-wrapper {
            min-height: 100vh; /* å…³é”®ï¼šæ•´é¡µé«˜åº¦ */
            display: flex;
            flex-direction: column;
        }

        .chat-layout {
            flex: 1;
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            display: grid;
            grid-template-columns: 260px minmax(0, 1.8fr) 260px;
            gap: 15px;
        }

        /* ========== å¡ç‰‡åŸºç¡€ ========== */
        .chat-card {
            background: rgba(15, 15, 20, 0.98);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
            position: relative;
            overflow: hidden;
        }

        .card-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ========== å·¦ä¾§ï¼šè®ºå›åˆ—è¡¨ ========== */
        .forums-card {
            display: flex;
            flex-direction: column;
        }

        .forums-list {
            padding: 10px 12px 14px;
        }

        .forum-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .forum-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-1px);
        }

        .forum-item.active {
            border-color: #4f8bff;
            background: radial-gradient(circle at top left, rgba(79, 139, 255, 0.35), rgba(10, 10, 20, 0.95));
        }

        .forum-name {
            font-size: 14px;
            font-weight: 600;
        }

        .forum-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.65);
            margin-top: 2px;
        }

        .forum-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.85);
            margin-top: 6px;
        }

        /* ========== ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ ========== */
        .chat-card-main {
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .chat-header {
            padding: 15px 25px;
            background: white;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .forum-title {
            font-size: 18px;
            color: #1f2933;
            font-weight: 600;
        }

        .forum-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 1px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
        }

        .online-text {
            font-size: 12px;
            color: #4b5563;
        }

        /* ========== æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ ========== */
        .messages-area {
            flex: 1;
            padding: 18px 18px 10px;
            background: radial-gradient(circle at top left, #111827 0%, #020617 45%, #020617 100%);
            overflow-y: auto;  /* å…è®¸å†…å®¹åŒºæ»šåŠ¨ */
            position: relative;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-group {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 80%;
        }

        .message-header-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .message-username {
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .message-meta {
            font-size: 11px;
            color: rgba(156, 163, 175, 0.9);
        }

        .message-bubble {
            margin-top: 3px;
            padding: 8px 11px;
            border-radius: 12px;
            background: rgba(17, 24, 39, 0.94);
            color: #f9fafb;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid rgba(55, 65, 81, 0.9);
            word-break: break-word;
        }

        .message-bubble.me {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-color: transparent;
        }

        .message-actions {
            margin-top: 4px;
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: rgba(148, 163, 184, 0.9);
        }

        .message-action-btn {
            cursor: pointer;
            opacity: 0.75;
            transition: opacity 0.15s ease;
        }

        .message-action-btn:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* ========== è¾“å…¥åŒºåŸŸ ========== */
        .chat-input-area {
            padding: 10px 16px 12px;
            background: rgba(15, 23, 42, 0.98);
            border-top: 1px solid rgba(148, 163, 184, 0.25);
        }

        .chat-input-inner {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 38px;
            max-height: 120px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            padding: 8px 14px;
            font-size: 14px;
            resize: none;
            outline: none;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            line-height: 1.5;
        }

        .chat-input::placeholder {
            color: rgba(148, 163, 184, 0.8);
        }

        .chat-send-btn {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.45);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(34, 197, 94, 0.55);
        }

        /* ========== å³ä¾§ï¼šåœ¨çº¿ç”¨æˆ· / æ´»åŠ¨ ========== */
        .sidebar-card {
            display: flex;
            flex-direction: column;
        }

        .users-list {
            padding: 10px 12px;
            max-height: 220px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 8px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.85);
            margin-bottom: 6px;
        }

        .user-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(135deg, #f97316, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .user-name {
            font-size: 13px;
        }

        .user-tag {
            font-size: 11px;
            color: rgba(148, 163, 184, 0.95);
        }

        .user-status-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px 12px 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 11px;
            color: rgba(148, 163, 184, 0.95);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
        }

        /* ========== é¡¶éƒ¨æ¡ ========== */
        .top-bar {
            max-width: 1200px;
            margin: 10px auto 0;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: rgba(209, 213, 219, 0.9);
            font-size: 13px;
        }

        .top-left {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }

        .back-link {
            color: rgba(196, 181, 253, 0.95);
            text-decoration: none;
            font-size: 12px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* ========== å“åº”å¼ ========== */
        @media (max-width: 1024px) {
            .chat-layout {
                grid-template-columns: minmax(0, 1.8fr) 260px;
                grid-template-rows: auto auto;
            }

            .forums-card {
                grid-column: 1 / -1;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .chat-layout {
                grid-template-columns: minmax(0, 1fr);
            }

            .sidebar-card {
                display: none;
            }

            .forums-card {
                order: -1;
            }

            .chat-card-main {
                min-height: 420px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="top-bar">
            <div class="top-left">
                <span style="opacity: 0.85;">ğŸŒŒ æ ¡å›­ç½‘ Â· æš—å¤œèŠå¤©å®¤</span>
            </div>
            <div class="top-right">
                <a href="main.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
                <span id="currentUserNameTop"></span>
            </div>
        </div>

        <div class="chat-layout">
            <!-- å·¦ä¾§ï¼šè®ºå›åˆ—è¡¨ -->
            <div class="chat-card forums-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">ç‰ˆå—å¹¿åœº</div>
                        <div class="card-subtitle">é€‰æ‹©ä½ æƒ³æ½œæ°´çš„è§’è½</div>
                    </div>
                </div>
                <div class="forums-list" id="forumsList"></div>
            </div>

            <!-- ä¸­é—´ï¼šèŠå¤© -->
            <div class="chat-card chat-card-main">
                <div class="chat-header">
                    <div>
                        <div class="forum-title" id="forumTitle">å¹¿åœºå¤§å…</div>
                        <div class="forum-subtitle" id="forumSubtitle">æ‰€æœ‰è¯é¢˜çš„äº¤æ±‡ç‚¹</div>
                    </div>
                    <div class="chat-header-right">
                        <div class="online-dot"></div>
                        <div class="online-text">
                            åœ¨çº¿äººæ•°ï¼š<span id="onlineCountHeader">0</span>
                        </div>
                    </div>
                </div>

                <div class="messages-area" id="messagesArea">
                    <div class="messages-list" id="messagesList"></div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-inner">
                        <textarea id="messageInput" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§â€¦â€¦ (æŒ‰ Enter å‘é€, Shift + Enter æ¢è¡Œ)"></textarea>
                        <button class="chat-send-btn" id="sendButton">
                            <span>å‘é€</span>
                            <span style="font-size: 16px;">â¤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šåœ¨çº¿ç”¨æˆ· -->
            <div class="chat-card sidebar-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">åœ¨çº¿ç”¨æˆ·</div>
                        <div class="card-subtitle">å½“å‰æ´»è·ƒ Â· <span id="userCount">0</span> äºº</div>
                    </div>
                </div>
                <div class="users-list" id="usersList"></div>
                <div class="sidebar-footer">
                    <div class="stat-line">
                        <span>å½“å‰è®ºå›</span>
                        <span id="forumNameStat">å¹¿åœºå¤§å…</span>
                    </div>
                    <div class="stat-line">
                        <span>ä½ çš„æ˜µç§°</span>
                        <span id="currentUserNameSide">-</span>
                    </div>
                    <div class="stat-line">
                        <span>çŠ¶æ€</span>
                        <span id="statusText">è¿æ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase é…ç½® ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",   // âœ… ä¿®æ­£è¿™é‡Œ
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // å…¨å±€å˜é‡
        let database;
        let currentUser = null;
        let currentForum = 'general';
        let messagesRef = null;
        let statusRef = null;

        // è®ºå›æ˜ å°„
        const forumNames = {
            general: {
                title: 'å¹¿åœºå¤§å…',
                subtitle: 'æ‰€æœ‰è¯é¢˜çš„äº¤æ±‡ç‚¹',
                desc: 'éšä¾¿èŠèŠ Â· åæ§½æ—¥å¸¸ Â· å‘å‘ç–¯'
            },
            study: {
                title: 'å­¦ä¹ è§’',
                subtitle: 'ä½œä¸šã€è€ƒè¯•ã€ä¿ç ”ã€å‡ºå›½',
                desc: 'æŠ„ä½œä¸š / æ±‚èµ„æ–™ / é—®ä¸“ä¸šé—®é¢˜'
            },
            emotion: {
                title: 'æ ‘æ´ Â· æƒ…æ„Ÿ',
                subtitle: 'æ— äººçŸ¥æ™“çš„å¿ƒäº‹',
                desc: 'æš—æ‹ / å¤±æ‹ / å®¶åº­ / è¿·èŒ«'
            },
            gossip: {
                title: 'åƒç“œä¸“åŒº',
                subtitle: 'ç“œæ°¸è¿œåƒä¸å®Œ',
                desc: 'æ ¡å›­è§é—» / å…«å¦ / å¥‡è‘©æ•…äº‹'
            }
        };

        // ========== åˆå§‹åŒ– ==========

        function safeAtob(str) {
            try {
                return decodeURIComponent(
                    atob(str)
                        .split('')
                        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                        .join('')
                );
            } catch (e) {
                console.warn('safeAtob è§£ç å¤±è´¥', e);
                return null;
            }
        }

        function initFirebase() {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            database = firebase.database();
        }

        function getCurrentUser() {
            try {
                const userDataStr = localStorage.getItem('userData');
                if (!userDataStr) return null;
                const decoded = safeAtob(userDataStr);
                if (!decoded) return null;
                return JSON.parse(decoded);
            } catch (error) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        function updateUserUI() {
            const nameTop = document.getElementById('currentUserNameTop');
            const nameSide = document.getElementById('currentUserNameSide');

            if (currentUser) {
                nameTop.textContent = `ğŸ‘¤ ${currentUser.userName}`;
                nameSide.textContent = currentUser.userName;
            } else {
                nameTop.textContent = 'æœªç™»å½•';
                nameSide.textContent = '-';
            }
        }

        // ========== åŠ è½½è®ºå›åˆ—è¡¨ ==========

        function renderForums() {
            const forumsList = document.getElementById('forumsList');
            forumsList.innerHTML = '';

            Object.keys(forumNames).forEach(key => {
                const info = forumNames[key];
                const div = document.createElement('div');
                div.className = 'forum-item' + (key === currentForum ? ' active' : '');
                div.dataset.forum = key;

                div.innerHTML = `
                    <div class="forum-name">${info.title}</div>
                    <div class="forum-desc">${info.desc}</div>
                    <div class="forum-badge">
                        <span>â€¢</span>
                        <span>${info.subtitle}</span>
                    </div>
                `;

                div.addEventListener('click', () => switchForum(key));
                forumsList.appendChild(div);
            });
        }

        function switchForum(forumKey) {
            if (forumKey === currentForum) return;

            currentForum = forumKey;

            // æ›´æ–°å·¦ä¾§é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.forum-item').forEach(el => {
                el.classList.toggle('active', el.dataset.forum === forumKey);
            });

            // æ›´æ–°ä¸­é—´æ ‡é¢˜
            const info = forumNames[forumKey] || forumNames['general'];
            document.getElementById('forumTitle').textContent = info.title;
            document.getElementById('forumSubtitle').textContent = info.subtitle;
            document.getElementById('forumNameStat').textContent = info.title;

            // é‡æ–°ç»‘å®šæ¶ˆæ¯ç›‘å¬
            bindMessagesListener();
        }

        // ========== æ¶ˆæ¯ç›¸å…³ ==========

        function formatTime(ts) {
            try {
                const d = new Date(ts);
                if (isNaN(d.getTime())) return '';
                const h = d.getHours().toString().padStart(2, '0');
                const m = d.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            } catch {
                return '';
            }
        }

        function renderMessage(key, msg, isMe) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-group';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = msg.userName ? msg.userName[0] : '?';

            const content = document.createElement('div');
            content.className = 'message-content';

            const header = document.createElement('div');
            header.className = 'message-header-row';

            const username = document.createElement('div');
            username.className = 'message-username';
            username.textContent = msg.userName || 'åŒ¿å';

            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = formatTime(msg.timestamp);

            header.appendChild(username);
            header.appendChild(meta);

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble' + (isMe ? ' me' : '');
            bubble.textContent = msg.text || '';

            const actions = document.createElement('div');
            actions.className = 'message-actions';

            const fromForum = document.createElement('span');
            fromForum.textContent = forumNames[msg.forum]?.title || 'å¹¿åœº';
            actions.appendChild(fromForum);

            content.appendChild(header);
            content.appendChild(bubble);
            content.appendChild(actions);

            wrapper.appendChild(avatar);
            wrapper.appendChild(content);

            return wrapper;
        }

        function bindMessagesListener() {
            const messagesList = document.getElementById('messagesList');
            const messagesArea = document.getElementById('messagesArea');

            messagesList.innerHTML = '';

            if (messagesRef) {
                messagesRef.off();
            }

            messagesRef = database.ref('forums/' + currentForum + '/messages');

            messagesRef.limitToLast(100).on('value', snapshot => {
                messagesList.innerHTML = '';

                snapshot.forEach(child => {
                    const msg = child.val();
                    const isMe = currentUser && msg.userId === currentUser.userId;
                    const el = renderMessage(child.key, msg, isMe);
                    messagesList.appendChild(el);
                });

                // æ»šåŠ¨åˆ°åº•éƒ¨
                messagesArea.scrollTop = messagesArea.scrollHeight;
            });
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                input.focus();
                return;
            }

            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'index.html';
                return;
            }

            console.log('å‘é€æ¶ˆæ¯:', text);

            try {
                const messageRef = database.ref('forums/' + currentForum + '/messages').push();

                await messageRef.set({
                    userId: currentUser.userId,
                    userName: currentUser.userName,
                    text: text,
                    timestamp: new Date().toISOString(),
                    forum: currentForum
                });

                console.log('æ¶ˆæ¯å‘é€æˆåŠŸ');

                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';

                // é‡æ–°èšç„¦
                setTimeout(() => {
                    input.focus();
                }, 50);

                // æ›´æ–°ç”¨æˆ·æœ€åæ´»åŠ¨
                await updateUserStatus(true);

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥: ' + error.message);
            }
        }

        // ========== åœ¨çº¿çŠ¶æ€ç›¸å…³ ==========

        async function updateUserStatus(isActive) {
            if (!currentUser) return;

            try {
                const statusRef = database.ref('status/' + currentUser.userId);
                await statusRef.update({
                    userName: currentUser.userName,
                    isOnline: !!isActive,
                    lastActive: new Date().toISOString(),
                    forum: currentForum
                });
            } catch (error) {
                console.warn('æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', error);
            }
        }

        function loadUsers() {
            const usersList = document.getElementById('usersList');
            const userCountEl = document.getElementById('userCount');
            const onlineCountEl = document.getElementById('onlineCountHeader');

            usersList.innerHTML = '';

            const usersRef = database.ref('status');

            usersRef.on('value', snapshot => {
                const users = [];
                snapshot.forEach(child => {
                    const val = child.val();
                    users.push({
                        id: child.key,
                        ...val
                    });
                });

                users.sort((a, b) => new Date(b.lastActive) - new Date(a.lastActive));

                usersList.innerHTML = '';
                let onlineCount = 0;

                users.forEach(user => {
                    const row = document.createElement('div');
                    row.className = 'user-item';

                    const main = document.createElement('div');
                    main.className = 'user-main';

                    const av = document.createElement('div');
                    av.className = 'user-avatar';
                    av.textContent = user.userName ? user.userName[0] : '?';

                    const textBox = document.createElement('div');
                    const name = document.createElement('div');
                    name.className = 'user-name';
                    name.textContent = user.userName || 'åŒ¿å';

                    const tag = document.createElement('div');
                    tag.className = 'user-tag';
                    tag.textContent = forumNames[user.forum]?.title || 'æœªçŸ¥ç‰ˆå—';

                    textBox.appendChild(name);
                    textBox.appendChild(tag);

                    main.appendChild(av);
                    main.appendChild(textBox);

                    const dot = document.createElement('div');
                    dot.className = 'user-status-dot';
                    if (!user.isOnline) {
                        dot.style.opacity = 0.35;
                        dot.style.boxShadow = 'none';
                    } else {
                        onlineCount++;
                    }

                    row.appendChild(main);
                    row.appendChild(dot);

                    usersList.appendChild(row);
                });

                userCountEl.textContent = users.length;
                onlineCountEl.textContent = onlineCount;
                document.getElementById('statusText').textContent = 'å®æ—¶æ›´æ–°ä¸­';
            });
        }

        // ========== äº‹ä»¶ç»‘å®š ==========

        function bindEvents() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            sendButton.addEventListener('click', sendMessage);

            input.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            window.addEventListener('beforeunload', () => {
                updateUserStatus(false);
            });
        }

        // ========== å¯åŠ¨ ==========

        window.addEventListener('load', () => {
            initFirebase();
            currentUser = getCurrentUser();

            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'index.html';
                return;
            }

            updateUserUI();
            renderForums();
            bindMessagesListener();
            loadUsers();
            bindEvents();
            updateUserStatus(true);
        });
    </script>
</body>
</html>
