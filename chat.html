<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - èŠå¤©å®¤</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <style>
        /* ========== æ–°ç‰ˆUIæ ·å¼ ========== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            margin: 0;
            padding: 20px;
            color: #fff;
            min-height: 100vh;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .top-bar h1 {
            font-size: 24px;
            margin: 0;
            color: #fff;
        }
        
        .back-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        
        .chat-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .sidebar-card {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .chat-card {
            background: #16213e;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .chat-card-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }
        
        .chat-card-header h2 {
            margin: 0;
            font-size: 20px;
            color: #fff;
        }
        
        .online-badge {
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 400px;
            max-height: 600px;
        }
        
        .message-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }
        
        .message-item.own {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #2ecc71;
        }
        
        .message-user {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .message-time {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-left: 10px;
        }
        
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }
        
        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .chat-send-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .chat-send-btn:hover {
            background: #2980b9;
        }
        
        .forum-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .forum-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .forum-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .forum-item.active {
            background: rgba(52, 152, 219, 0.3);
            border-left: 3px solid #3498db;
        }
        
        .user-list-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-name {
            flex: 1;
        }
        
        .user-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2ecc71;
        }
        
        .user-status.offline {
            background: #e74c3c;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .chat-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar-card {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- æ–°ç‰ˆUIï¼ˆéœ€è¦ä¿ç•™ï¼‰ -->
    <div class="top-bar">
        <h1>æ ¡å›­ç½‘ Â· æš—å¤œèŠå¤©å®¤</h1>
        <a href="main.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
    </div>
    
    <div class="chat-layout">
        <!-- å·¦ä¾§è®ºå›åˆ—è¡¨ -->
        <div class="sidebar-card">
            <h3 style="margin-top: 0; margin-bottom: 15px;">è®ºå›é€‰æ‹©</h3>
            <ul class="forum-list">
                <li class="forum-item active" data-forum="general" onclick="switchForum('general')">ğŸ’¬ ç»¼åˆè®¨è®ºåŒº</li>
                <li class="forum-item" data-forum="study" onclick="switchForum('study')">ğŸ“š å­¦ä¹ äº¤æµ</li>
                <li class="forum-item" data-forum="fun" onclick="switchForum('fun')">ğŸ® ä¼‘é—²å¨±ä¹</li>
            </ul>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px;">åœ¨çº¿ç”¨æˆ·</h3>
            <div id="usersList" class="users-list">
                <!-- ç”¨æˆ·åˆ—è¡¨åŠ¨æ€åŠ è½½ -->
                <div class="user-list-item">
                    <div class="user-avatar">U</div>
                    <div class="user-name">åŠ è½½ä¸­...</div>
                    <div class="user-status"></div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´èŠå¤©åŒº -->
        <div class="chat-card">
            <div class="chat-card-header">
                <h2 id="currentForumTitle">ç»¼åˆè®¨è®ºåŒº <span class="online-badge" id="onlineCount">0äººåœ¨çº¿</span></h2>
            </div>
            
            <div class="messages-area" id="messagesContainer">
                <!-- æ¶ˆæ¯åŠ¨æ€åŠ è½½ -->
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                    <p>ğŸ’¬ è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªå‘è¨€å§ï¼</p>
                </div>
            </div>
            
            <div class="chat-input-area">
                <div class="input-row">
                    <input type="text" id="messageInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
                    <!-- ä¿®å¤1ï¼šåˆ é™¤onclickå±æ€§ï¼Œé˜²æ­¢é‡å¤å‘é€ -->
                    <button id="sendButton" class="chat-send-btn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center;">
            <div class="user-avatar" id="userAvatar">U</div>
            <div style="margin-left: 10px;">
                <div style="font-weight: bold;" id="currentUserName">ç”¨æˆ·</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.7);">çŠ¶æ€: <span id="userStatus">åœ¨çº¿</span></div>
            </div>
        </div>
        <button onclick="logout()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">é€€å‡ºç™»å½•</button>
    </div>

    <script>
// ========= å®‰å…¨IPç¼–ç  =========
function encodeIPForFirebase(ip) {
    return ip.replace(/\./g, "_");
}

// ========= UTF-8 å®‰å…¨çš„ Base64 è§£ç ï¼ˆä¸index.html/main.htmlç»Ÿä¸€ï¼‰=========
function safeAtob(str) {
    try {
        return decodeURIComponent(
            atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
        );
    } catch (e) {
        console.error('è§£ç å¤±è´¥:', e);
        return null;
    }
}

// ========== Firebase é…ç½® ==========
const firebaseConfig = {
    apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
    authDomain: "laoda907-22511.firebasestorage.app",
    databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "laoda907-22511",
    storageBucket: "laoda907-22511.firebasestorage.app",
    messagingSenderId: "176173610464",
    appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

// å…¨å±€å˜é‡
let database;
let currentUser = null;
let currentForum = 'general';
let messagesRef = null;

// è®ºå›æ˜ å°„
const forumNames = {
    'general': 'ç»¼åˆè®¨è®ºåŒº',
    'study': 'å­¦ä¹ äº¤æµ',
    'fun': 'ä¼‘é—²å¨±ä¹'
};

// ========== å·¥å…·å‡½æ•° ==========
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// æ£€æŸ¥ç™»å½•çŠ¶æ€ - ä¿®å¤ç‰ˆæœ¬
function checkLogin() {
    const sessionStr = localStorage.getItem('xiaoyuan_session');
    if (!sessionStr) {
        console.log('æœªæ‰¾åˆ°sessionï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
        window.location.href = 'index.html';
        return false;
    }
    
    try {
        // ä½¿ç”¨å®‰å…¨çš„Base64è§£ç 
        const decodedStr = safeAtob(sessionStr);
        if (!decodedStr) {
            console.error('sessionè§£ç å¤±è´¥');
            localStorage.removeItem('xiaoyuan_session');
            window.location.href = 'index.html';
            return false;
        }
        
        const sessionData = JSON.parse(decodedStr);
        if (Date.now() > sessionData.expiry) {
            console.log('sessionå·²è¿‡æœŸ');
            localStorage.removeItem('xiaoyuan_session');
            window.location.href = 'index.html';
            return false;
        }
        
        currentUser = sessionData;
        console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.userName);
        return true;
        
    } catch (error) {
        console.error('ä¼šè¯éªŒè¯å¤±è´¥:', error);
        localStorage.removeItem('xiaoyuan_session');
        window.location.href = 'index.html';
        return false;
    }
}

// åˆå§‹åŒ–èŠå¤©
async function initChat() {
    try {
        // åˆå§‹åŒ–Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        database = firebase.database();
        console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        document.getElementById('currentUserName').textContent = currentUser.userName;
        document.getElementById('userAvatar').textContent = currentUser.userName.charAt(0).toUpperCase();
        
        // è®¾ç½®ç”¨æˆ·çŠ¶æ€ä¸ºåœ¨çº¿
        await updateUserStatus(true);
        
        // è®¾ç½®è®ºå›
        switchForum('general');
        
        // åŠ è½½åœ¨çº¿ç”¨æˆ·
        loadUsers();
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        setupEventListeners();
        
        // ç¡®ä¿è¾“å…¥æ¡†å¯ä»¥è¾“å…¥
        const input = document.getElementById('messageInput');
        input.disabled = false;
        
        // å»¶è¿Ÿèšç„¦ï¼Œç¡®ä¿å¸ƒå±€ç¨³å®š
        setTimeout(() => {
            input.focus();
        }, 300);
        
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢: ' + error.message);
    }
}

// æ›´æ–°ç”¨æˆ·çŠ¶æ€
async function updateUserStatus(online) {
    try {
        if (!currentUser) return;
        
        const statusRef = database.ref('status/' + currentUser.userId);
        const userData = {
            userId: currentUser.userId,
            userName: currentUser.userName,
            online: online,
            forum: currentForum,
            lastSeen: new Date().toISOString()
        };
        
        if (online) {
            await statusRef.set(userData);
        } else {
            await statusRef.update({ 
                online: false,
                lastSeen: new Date().toISOString() 
            });
        }
        
        document.getElementById('userStatus').textContent = online ? 'åœ¨çº¿' : 'ç¦»çº¿';
        console.log('æ›´æ–°ç”¨æˆ·çŠ¶æ€:', online ? 'åœ¨çº¿' : 'ç¦»çº¿');
    } catch (error) {
        console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
    }
}

// åˆ‡æ¢è®ºå›
function switchForum(forumId) {
    console.log('åˆ‡æ¢è®ºå›åˆ°:', forumId);
    
    currentForum = forumId;
    
    // æ›´æ–°UI
    document.querySelectorAll('.forum-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`.forum-item[data-forum="${forumId}"]`).classList.add('active');
    document.getElementById('currentForumTitle').innerHTML = `${forumNames[forumId]} <span class="online-badge" id="onlineCount">0äººåœ¨çº¿</span>`;
    
    // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);"><p>ğŸ’¬ åŠ è½½æ¶ˆæ¯ä¸­...</p></div>';
    
    if (messagesRef) {
        messagesRef.off();
    }
    
    loadMessages();
    
    if (currentUser) {
        updateUserStatus(true);
    }
    
    loadUsers();
}

// åŠ è½½æ¶ˆæ¯
function loadMessages() {
    const container = document.getElementById('messagesContainer');
    
    messagesRef = database.ref('forums/' + currentForum + '/messages');
    
    // åªä¿ç•™ on('child_added') ç›‘å¬
    messagesRef.limitToLast(50).on('child_added', snapshot => {
        const message = snapshot.val();
        
        // ç§»é™¤ç©ºçŠ¶æ€æç¤º
        const emptyState = container.querySelector('div[style*="text-align: center"]');
        if (emptyState) {
            emptyState.remove();
        }
        
        addMessageToUI(message, snapshot.key);
    });
    
    messagesRef.on('child_removed', snapshot => {
        removeMessageFromUI(snapshot.key);
    });
}

// æ·»åŠ æ¶ˆæ¯åˆ°UI - ç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬ï¼Œä¸åšä»»ä½•å¤„ç†
function addMessageToUI(message, messageId) {
    const container = document.getElementById('messagesContainer');
    
    const isOwn = message.userId === currentUser.userId;
    
    const messageEl = document.createElement('div');
    messageEl.className = `message-item ${isOwn ? 'own' : ''}`;
    messageEl.id = `msg_${messageId}`;
    
    const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit' 
    }) : 'åˆšåˆš';
    
    // ç›´æ¥ä½¿ç”¨åŸå§‹æ–‡æœ¬ï¼Œä¸åšä»»ä½•ç¼–ç /è§£ç å¤„ç†
    const messageText = message.text || '';
    
    // ğŸ”§ ä¿®å¤2ï¼šå›ºå®šæ¸²æŸ“æ–¹å‘ï¼Œé˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨è°ƒæ¢æ–‡å­—é¡ºåº
    messageEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <div class="message-user">${escapeHtml(message.userName || 'åŒ¿åç”¨æˆ·')}</div>
            <div class="message-time">${time}</div>
        </div>
        <div style="unicode-bidi: plaintext; direction: ltr;">
            ${escapeHtml(messageText)}
        </div>
    `;
    
    container.appendChild(messageEl);
    container.scrollTop = container.scrollHeight;
}

// åˆ é™¤æ¶ˆæ¯ä»UI
function removeMessageFromUI(messageId) {
    const messageEl = document.getElementById(`msg_${messageId}`);
    if (messageEl) {
        messageEl.remove();
    }
}

// å‘é€æ¶ˆæ¯ - ç›´æ¥å­˜å‚¨åŸå§‹æ–‡æœ¬
async function sendMessage() {
    console.log('sendMessage è¢«è°ƒç”¨');
    
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    let text = input.value.trim();
    
    // ğŸ”§ ä¿®å¤1ï¼šæ¸…ç† Unicode åŒå‘æ§åˆ¶ç¬¦ï¼Œé˜²æ­¢ä¸­æ–‡é¡ºåºè¢«æ‰“ä¹±
    text = text.replace(/[\u202A-\u202E\u2066-\u2069]/g, '');
    
    if (!text) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
        input.focus();
        return;
    }
    
    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (!currentUser || !currentUser.userId) {
        console.log('currentUser ä¸å­˜åœ¨ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨æ¢å¤');
        const sessionStr = localStorage.getItem('xiaoyuan_session');
        if (sessionStr) {
            try {
                const decodedStr = safeAtob(sessionStr);
                if (decodedStr) {
                    currentUser = JSON.parse(decodedStr);
                    console.log('ä»å­˜å‚¨æ¢å¤ç”¨æˆ·:', currentUser.userName);
                }
            } catch (error) {
                console.error('æ¢å¤ç”¨æˆ·å¤±è´¥:', error);
            }
        }
        
        if (!currentUser) {
            alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = 'index.html';
            return;
        }
    }
    
    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤å‘é€
    sendButton.disabled = true;
    sendButton.textContent = 'å‘é€ä¸­...';
    
    console.log('å‡†å¤‡å‘é€æ¶ˆæ¯:', {
        ç”¨æˆ·: currentUser.userName,
        è®ºå›: currentForum,
        å†…å®¹: text
    });
    
    try {
        // ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–
        if (!database) {
            console.log('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œé‡æ–°åˆå§‹åŒ–...');
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        }
        
        // ç›´æ¥å­˜å‚¨åŸå§‹æ–‡æœ¬ï¼Œä¸è¿›è¡Œä»»ä½•ç¼–ç 
        const messageData = {
            userId: currentUser.userId,
            userName: currentUser.userName,
            text: text, // ç›´æ¥å­˜å‚¨åŸå§‹æ–‡æœ¬ï¼ˆå·²æ¸…ç†æ§åˆ¶ç¬¦ï¼‰
            timestamp: new Date().toISOString(),
            forum: currentForum
        };
        
        // å‘é€åˆ°Firebase
        const messageRef = database.ref(`forums/${currentForum}/messages`).push();
        await messageRef.set(messageData);
        
        console.log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸï¼ŒID:', messageRef.key);
        
        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡æ–°èšç„¦
        input.value = '';
        sendButton.disabled = false;
        sendButton.textContent = 'å‘é€';
        
        setTimeout(() => {
            input.focus();
        }, 50);
        
        // æ›´æ–°ç”¨æˆ·çŠ¶æ€
        await updateUserStatus(true);
        
    } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        alert('å‘é€å¤±è´¥: ' + error.message);
        sendButton.disabled = false;
        sendButton.textContent = 'å‘é€';
    }
}

// åŠ è½½åœ¨çº¿ç”¨æˆ·
function loadUsers() {
    const usersList = document.getElementById('usersList');
    const onlineCountEl = document.getElementById('onlineCount');
    
    const usersRef = database.ref('status');
    
    usersRef.on('value', snapshot => {
        const users = [];
        snapshot.forEach(childSnapshot => {
            const user = childSnapshot.val();
            if (user.online && user.forum === currentForum) {
                users.push(user);
            }
        });
        
        // æ›´æ–°åœ¨çº¿äººæ•°
        if (onlineCountEl) {
            onlineCountEl.textContent = `${users.length}äººåœ¨çº¿`;
        }
        
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        if (users.length === 0) {
            usersList.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 10px;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
        } else {
            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-list-item">
                        <div class="user-avatar">${user.userName ? user.userName.charAt(0).toUpperCase() : '?'}</div>
                        <div class="user-name">${escapeHtml(user.userName || 'æœªçŸ¥ç”¨æˆ·')}</div>
                        <div class="user-status"></div>
                    </div>
                `;
            });
            usersList.innerHTML = html;
        }
    });
}

// è®¾ç½®äº‹ä»¶ç›‘å¬ - ä¿®å¤ï¼šåªç»‘å®šä¸€æ¬¡äº‹ä»¶
function setupEventListeners() {
    console.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
    
    const input = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    if (!input) {
        console.error('âŒ è¾“å…¥æ¡†å…ƒç´ æœªæ‰¾åˆ°ï¼');
        return;
    }
    
    if (!sendButton) {
        console.error('âŒ å‘é€æŒ‰é’®æœªæ‰¾åˆ°ï¼');
        return;
    }
    
    console.log('æ‰¾åˆ°è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®');
    
    // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sendButton.addEventListener('click', function(e) {
        console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡»');
        e.preventDefault(); // é˜²æ­¢é‡å¤è§¦å‘
        sendMessage();
    });
    
    // è¾“å…¥æ¡†å›è½¦å‘é€
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // é¡µé¢å…³é—­æ—¶æ›´æ–°çŠ¶æ€
    window.addEventListener('beforeunload', function() {
        updateUserStatus(false);
    });
    
    // é¡µé¢å¯è§æ€§å˜åŒ–
    document.addEventListener('visibilitychange', function() {
        updateUserStatus(!document.hidden);
    });
}

// é€€å‡ºç™»å½•
function logout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        updateUserStatus(false).then(() => {
            localStorage.removeItem('xiaoyuan_session');
            window.location.href = 'index.html';
        });
    }
}

// ğŸ”§ ä¿®æ”¹åçš„é¡µé¢åŠ è½½æµç¨‹
document.addEventListener('DOMContentLoaded', function() {
    console.log('èŠå¤©é¡µé¢åŠ è½½');
    
    // 1. å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆä½¿ç”¨localStorageï¼‰
    if (!checkLogin()) {
        // checkLoginå†…éƒ¨å·²ç»å¤„ç†è·³è½¬
        return;
    }
    
    // 2. å¦‚æœç™»å½•æ£€æŸ¥é€šè¿‡ï¼Œåˆå§‹åŒ–èŠå¤©
    initChat();
});
    </script>
</body>
</html>
