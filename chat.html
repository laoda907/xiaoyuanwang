<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - èŠå¤©å®¤</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <style>
        /* ========== ç»ˆæä¿®å¤ï¼šæ ¹å±‚CSS ========== */
        html, body {
            height: auto;
            min-height: 100%;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%; /* é˜²æ­¢iOSå­—ä½“ç¼©æ”¾ */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            background: radial-gradient(circle at top, #2c3e50 0%, #000000 55%, #000000 100%);
            color: #fff;
            overflow-y: auto;
        }

        /* ========== å¸ƒå±€åŸºç¡€ ========== */
        .chat-wrapper {
            min-height: 100vh; /* å…³é”®ï¼šæ•´é¡µé«˜åº¦ */
            display: flex;
            flex-direction: column;
        }

        .chat-layout {
            flex: 1;
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            display: grid;
            grid-template-columns: 260px minmax(0, 1.8fr) 260px;
            gap: 15px;
        }

        /* ========== å¡ç‰‡åŸºç¡€ ========== */
        .chat-card {
            background: rgba(15, 15, 20, 0.98);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
            position: relative;
            overflow: hidden;
        }

        .card-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ========== å·¦ä¾§ï¼šè®ºå›åˆ—è¡¨ ========== */
        .forums-card {
            display: flex;
            flex-direction: column;
        }

        .forums-list {
            padding: 10px 12px 14px;
        }

        .forum-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .forum-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-1px);
        }

        .forum-item.active {
            border-color: #4f8bff;
            background: radial-gradient(circle at top left, rgba(79, 139, 255, 0.35), rgba(10, 10, 20, 0.95));
        }

        .forum-name {
            font-size: 14px;
            font-weight: 600;
        }

        .forum-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.65);
            margin-top: 2px;
        }

        .forum-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.85);
            margin-top: 6px;
        }

        /* ========== ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ ========== */
        .chat-card-main {
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .chat-header {
            padding: 15px 25px;
            background: white;
            border-bottom: 1px solid #e1e1e1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .forum-title {
            font-size: 18px;
            color: #1f2933;
            font-weight: 600;
        }

        .forum-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 1px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
        }

        .online-text {
            font-size: 12px;
            color: #4b5563;
        }

        /* ========== æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ ========== */
        .messages-area {
            flex: 1;
            padding: 18px 18px 10px;
            background: radial-gradient(circle at top left, #111827 0%, #020617 45%, #020617 100%);
            overflow-y: auto;  /* å…è®¸å†…å®¹åŒºæ»šåŠ¨ */
            position: relative;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message-group {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 80%;
        }

        .message-header-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .message-username {
            font-size: 13px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .message-meta {
            font-size: 11px;
            color: rgba(156, 163, 175, 0.9);
        }

        .message-bubble {
            margin-top: 3px;
            padding: 8px 11px;
            border-radius: 12px;
            background: rgba(17, 24, 39, 0.94);
            color: #f9fafb;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid rgba(55, 65, 81, 0.9);
            word-break: break-word;
        }

        .message-bubble.me {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-color: transparent;
        }

        .message-actions {
            margin-top: 4px;
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: rgba(148, 163, 184, 0.9);
        }

        .message-action-btn {
            cursor: pointer;
            opacity: 0.75;
            transition: opacity 0.15s ease;
        }

        .message-action-btn:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* ========== è¾“å…¥åŒºåŸŸ ========== */
        .chat-input-area {
            padding: 10px 16px 12px;
            background: rgba(15, 23, 42, 0.98);
            border-top: 1px solid rgba(148, 163, 184, 0.25);
        }

        .chat-input-inner {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 38px;
            max-height: 120px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            padding: 8px 14px;
            font-size: 14px;
            resize: none;
            outline: none;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            line-height: 1.5;
        }

        .chat-input::placeholder {
            color: rgba(148, 163, 184, 0.8);
        }

        .chat-send-btn {
            padding: 8px 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.45);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(34, 197, 94, 0.55);
        }

        /* ========== å³ä¾§ï¼šåœ¨çº¿ç”¨æˆ· / æ´»åŠ¨ ========== */
        .sidebar-card {
            display: flex;
            flex-direction: column;
        }

        .users-list {
            padding: 10px 12px;
            max-height: 220px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 8px;
            border-radius: 8px;
            background: rgba(15, 23, 42, 0.85);
            margin-bottom: 6px;
        }

        .user-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(135deg, #f97316, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .user-name {
            font-size: 13px;
        }

        .user-tag {
            font-size: 11px;
            color: rgba(148, 163, 184, 0.95);
        }

        .user-status-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 10px 12px 12px;
            border-top: 1px solid rgba(148, 163, 184, 0.25);
            font-size: 11px;
            color: rgba(148, 163, 184, 0.95);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
        }

        /* ========== é¡¶éƒ¨æ¡ ========== */
        .top-bar {
            max-width: 1200px;
            margin: 10px auto 0;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: rgba(209, 213, 219, 0.9);
            font-size: 13px;
        }

        .top-left {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }

        .back-link {
            color: rgba(196, 181, 253, 0.95);
            text-decoration: none;
            font-size: 12px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* ========== å“åº”å¼ ========== */
        @media (max-width: 1024px) {
            .chat-layout {
                grid-template-columns: minmax(0, 1.8fr) 260px;
                grid-template-rows: auto auto;
            }

            .forums-card {
                grid-column: 1 / -1;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .chat-layout {
                grid-template-columns: minmax(0, 1fr);
            }

            .sidebar-card {
                display: none;
            }

            .forums-card {
                order: -1;
            }

            .chat-card-main {
                min-height: 420px;
            }
        }

        /* ä½ çš„åŸæœ‰æ ·å¼ï¼ˆæ¶ˆæ¯åˆ—è¡¨ã€è¾“å…¥æ¡†ç­‰ï¼‰æˆ‘éƒ½å°½é‡ä¿æŒä¸å˜ï¼Œè¿™é‡Œå°±ä¸å…¨éƒ¨å±•å¼€äº† */
        .chat-container {
            max-width: 1000px;
            margin: 20px auto 30px;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            display: flex;
        }
        
        .sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            border-radius: 15px;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            flex-shrink: 0;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .username {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .user-status {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }
        
        .menu {
            width: 100%;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-item {
            padding: 12px 20px;
            text-align: left;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .menu-item.active {
            background: rgba(255,255,255,0.2);
        }
        
        .chat-main {
            flex: 1;
            background: #f5f7fb;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header2 {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e1e1;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .forum-title2 {
            font-size: 18px;
            font-weight: bold;
        }
        
        .forum-desc2 {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .chat-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message-box {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .message-box.own {
            margin-left: auto;
            background: #d1eaff;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-user {
            font-weight: 600;
        }
        
        .message-time {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        /* ========== è¾“å…¥æ¡†åŒºåŸŸ - å…³é”®ä¿®å¤ ========== */
        .input-area {
            padding: 20px;
            border-top: 1px solid #e1e1e1;
            background: white;
            flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        #messageInput {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            border-radius: 20px;
            border: 1px solid #d1d5db;
            padding: 10px 14px;
            resize: none;
            font-size: 14px;
            outline: none;
            line-height: 1.5;
        }
        
        #messageInput:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 1px rgba(99,102,241,0.2);
        }
        
        .send-btn {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .send-btn:hover {
            opacity: 0.95;
        }
        
        .online-users {
            margin-top: 15px;
            font-size: 13px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 10px;
                padding: 10px;
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
                flex-direction: row;
                padding: 10px;
            }
            
            .avatar {
                width: 50px;
                height: 50px;
                font-size: 24px;
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .menu {
                display: none;
            }
            
            .chat-main {
                min-height: 400px;
            }
            
            .input-area {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="top-bar">
            <div class="top-left">
                <span style="opacity: 0.85;">ğŸŒŒ æ ¡å›­ç½‘ Â· æš—å¤œèŠå¤©å®¤</span>
            </div>
            <div class="top-right">
                <a href="main.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
                <span id="currentUserNameTop"></span>
            </div>
        </div>

        <div class="chat-layout">
            <!-- å·¦ä¾§ï¼šè®ºå›åˆ—è¡¨ -->
            <div class="chat-card forums-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">ç‰ˆå—å¹¿åœº</div>
                        <div class="card-subtitle">é€‰æ‹©ä½ æƒ³æ½œæ°´çš„è§’è½</div>
                    </div>
                </div>
                <div class="forums-list" id="forumsList"></div>
            </div>

            <!-- ä¸­é—´ï¼šèŠå¤© -->
            <div class="chat-card chat-card-main">
                <div class="chat-header">
                    <div>
                        <div class="forum-title" id="forumTitle">å¹¿åœºå¤§å…</div>
                        <div class="forum-subtitle" id="forumSubtitle">æ‰€æœ‰è¯é¢˜çš„äº¤æ±‡ç‚¹</div>
                    </div>
                    <div class="chat-header-right">
                        <div class="online-dot"></div>
                        <div class="online-text">
                            åœ¨çº¿äººæ•°ï¼š<span id="onlineCountHeader">0</span>
                        </div>
                    </div>
                </div>

                <div class="messages-area">
                    <div class="messages-list" id="messagesContainer">
                        <div id="emptyMessages" style="text-align:center;color:#9ca3af;margin-top:30px;">
                            è¿˜æ²¡æœ‰äººå‘è¨€ï¼Œæ¥åšç¬¬ä¸€ä¸ªè¯´è¯çš„äººå§ï½
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-inner">
                        <textarea id="messageInput" class="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§â€¦â€¦ (æŒ‰ Enter å‘é€, Shift + Enter æ¢è¡Œ)" disabled></textarea>
                        <button class="chat-send-btn" id="sendButton">
                            <span>å‘é€</span>
                            <span style="font-size: 16px;">â¤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šåœ¨çº¿ç”¨æˆ· -->
            <div class="chat-card sidebar-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">åœ¨çº¿ç”¨æˆ·</div>
                        <div class="card-subtitle">å½“å‰æ´»è·ƒ Â· <span id="userCount">0</span> äºº</div>
                    </div>
                </div>
                <div class="users-list" id="usersList"></div>
                <div class="sidebar-footer">
                    <div class="stat-line">
                        <span>å½“å‰è®ºå›</span>
                        <span id="forumNameStat">å¹¿åœºå¤§å…</span>
                    </div>
                    <div class="stat-line">
                        <span>ä½ çš„æ˜µç§°</span>
                        <span id="currentUserNameSide">-</span>
                    </div>
                    <div class="stat-line">
                        <span>çŠ¶æ€</span>
                        <span id="statusText">è¿æ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========= å®‰å…¨IPç¼–ç  =========
        function encodeIPForFirebase(ip) {
            return ip.replace(/\./g, "_");
        }

        // ========== Firebase é…ç½® ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",   // âœ… ä¿®æ­£ä¸º firebaseapp.com
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // å…¨å±€å˜é‡
        let database;
        let currentUser = null;
        let currentForum = 'general';
        let messagesRef = null;
        let statusRef = null;
        
        // è®ºå›æ˜ å°„
        const forumNames = {
            'general': 'ç»¼åˆè®¨è®ºåŒº',
            'study': 'å­¦ä¹ äº¤æµ',
            'fun': 'ä¼‘é—²å¨±ä¹'
        };

        // ========== å·¥å…·å‡½æ•° ==========
        function safeAtob(str) {
            try {
                return decodeURIComponent(
                    atob(str).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join('')
                );
            } catch (e) {
                console.error('è§£ç å¤±è´¥:', e);
                return null;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('èŠå¤©é¡µé¢åŠ è½½');
            checkLogin();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆè¿›å…¥é¡µé¢æ—¶è°ƒç”¨ï¼‰
        function checkLogin() {
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (!sessionStr) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const decodedStr = safeAtob(sessionStr);
                if (!decodedStr) {
                    throw new Error('è§£ç å¤±è´¥');
                }
                
                const sessionData = JSON.parse(decodedStr);
                if (Date.now() > sessionData.expiry) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('xiaoyuan_session');
                    window.location.href = 'index.html';
                    return;
                }
                
                currentUser = sessionData;
                console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.userName);
                initChat();
                
            } catch (error) {
                console.error('ä¼šè¯éªŒè¯å¤±è´¥:', error);
                localStorage.removeItem('xiaoyuan_session');
                alert('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = 'index.html';
            }
        }

        // å†æ¬¡æ ¡éªŒå½“å‰ç”¨æˆ·ï¼ˆå‘é€æ¶ˆæ¯å‰è°ƒç”¨ï¼Œé˜²æ­¢ currentUser ä¸¢å¤±ï¼‰
        function ensureCurrentUser() {
            if (currentUser && currentUser.userId && currentUser.userName) {
                return true;
            }
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (!sessionStr) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = 'index.html';
                return false;
            }
            try {
                const decodedStr = safeAtob(sessionStr);
                if (!decodedStr) {
                    throw new Error('è§£ç å¤±è´¥');
                }
                const sessionData = JSON.parse(decodedStr);
                if (Date.now() > sessionData.expiry) {
                    alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    localStorage.removeItem('xiaoyuan_session');
                    window.location.href = 'index.html';
                    return false;
                }
                currentUser = sessionData;
                return true;
            } catch (e) {
                console.error('ä¼šè¯è§£æå¤±è´¥:', e);
                alert('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
                localStorage.removeItem('xiaoyuan_session');
                window.location.href = 'index.html';
                return false;
            }
        }
        
        // åˆå§‹åŒ–èŠå¤©
        async function initChat() {
            try {
                // åˆå§‹åŒ–Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                document.getElementById('currentUserNameTop').textContent = 'ğŸ‘¤ ' + currentUser.userName;
                document.getElementById('currentUserNameSide').textContent = currentUser.userName;
                
                // åˆå§‹åŒ–è®ºå›åˆ—è¡¨
                initForums();
                
                // åŠ è½½é»˜è®¤æ¿å—
                const savedForum = sessionStorage.getItem('selectedForum');
                if (savedForum && ['general', 'study', 'fun'].includes(savedForum)) {
                    switchForum(savedForum);
                } else {
                    switchForum('general');
                }
                
                // åŠ è½½åœ¨çº¿ç”¨æˆ·
                loadUsers();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                setupEventListeners();
                
                // ç¡®ä¿è¾“å…¥æ¡†å¯ç”¨
                const input = document.getElementById('messageInput');
                input.disabled = false;
                setTimeout(() => input.focus(), 300);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢: ' + error.message);
            }
        }

        // åˆå§‹åŒ–è®ºå›åˆ—è¡¨
        function initForums() {
            const forumsList = document.getElementById('forumsList');
            forumsList.innerHTML = '';
            
            Object.keys(forumNames).forEach(key => {
                const item = document.createElement('div');
                item.className = 'forum-item' + (key === currentForum ? ' active' : '');
                item.dataset.forum = key;
                item.innerHTML = `
                    <div class="forum-name">${forumNames[key]}</div>
                    <div class="forum-desc">${key === 'general' ? 'éšä¾¿èŠèŠ Â· åæ§½æ—¥å¸¸ Â· å‘å‘ç–¯' : key === 'study' ? 'å­¦ä¹ é—®é¢˜äº’å¸®äº’åŠ©' : 'å¨±ä¹ã€æ¸¸æˆã€éŸ³ä¹ã€ç”µå½±'} </div>
                    <div class="forum-badge">
                        <span>â—</span>
                        <span>${key === 'general' ? 'å¹¿åœºå¤§å…' : key === 'study' ? 'å­¦ä¹ è§’' : 'æ”¾æ¾ä¸€ä¸‹'}</span>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    switchForum(key);
                });
                
                forumsList.appendChild(item);
            });
        }

        // åˆ‡æ¢è®ºå›
        function switchForum(forumId) {
            if (currentForum === forumId) return;
            
            currentForum = forumId;
            sessionStorage.setItem('selectedForum', forumId);
            
            // æ›´æ–°UI
            document.getElementById('forumTitle').textContent = forumNames[forumId] || 'æœªçŸ¥æ¿å—';
            document.getElementById('forumSubtitle').textContent = forumId === 'general' ? 'æ‰€æœ‰è¯é¢˜çš„äº¤æ±‡ç‚¹' : (forumId === 'study' ? 'è€ƒè¯•ã€ä½œä¸šã€ä¿ç ”ã€å‡ºå›½' : 'èŠç‚¹è½»æ¾çš„');
            document.getElementById('forumNameStat').textContent = forumNames[forumId] || 'æœªçŸ¥æ¿å—';
            
            // æ›´æ–°å·¦ä¾§é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.forum-item').forEach(item => {
                item.classList.toggle('active', item.dataset.forum === forumId);
            });
            
            // é‡æ–°åŠ è½½è¯¥æ¿å—çš„æ¶ˆæ¯
            loadMessages();
            
            // æ›´æ–°åœ¨çº¿çŠ¶æ€
            updateUserStatus(true);
        }

        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            const emptyEl = document.getElementById('emptyMessages');
            container.innerHTML = '';
            emptyEl.style.display = 'block';
            
            if (messagesRef) {
                messagesRef.off();
            }
            
            messagesRef = database.ref('forums/' + currentForum + '/messages');
            messagesRef.limitToLast(100).on('value', snapshot => {
                container.innerHTML = '';
                if (!snapshot.exists()) {
                    emptyEl.style.display = 'block';
                    return;
                }
                
                snapshot.forEach(child => {
                    const message = child.val();
                    addMessageToUI(message, child.key);
                });
                
                emptyEl.style.display = 'none';
                const messagesArea = document.querySelector('.messages-area');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°UI
        function addMessageToUI(message, messageId) {
            const container = document.getElementById('messagesContainer');
            const emptyEl = document.getElementById('emptyMessages');
            
            emptyEl.style.display = 'none';
            
            const isOwn = currentUser && message.userId === currentUser.userId;
            
            const messageEl = document.createElement('div');
            messageEl.className = `message-box ${isOwn ? 'own' : ''}`;
            messageEl.id = `msg_${messageId}`;
            messageEl.dataset.messageId = messageId;
            
            const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            }) : 'åˆšåˆš';
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${escapeHtml(message.userName)}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(message.text)}</div>
            `;
            
            container.appendChild(messageEl);
            
            // æ»šåŠ¨åˆ°æœ€æ–°
            const messagesArea = document.querySelector('.messages-area');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                input.focus();
                return;
            }
            
            // è¿™é‡Œæ”¹æˆè°ƒç”¨ ensureCurrentUserï¼Œæ›´ç¨³ï¼Œä¸ä¼šè«åå…¶å¦™è¯´â€œè¯·å…ˆç™»å½•â€
            if (!ensureCurrentUser()) {
                return;
            }
            
            console.log('å‘é€æ¶ˆæ¯:', text);
            
            try {
                const messageRef = database.ref('forums/' + currentForum + '/messages').push();
                
                await messageRef.set({
                    userId: currentUser.userId,
                    userName: currentUser.userName,
                    text: text,
                    timestamp: new Date().toISOString()
                });
                
                input.value = '';
                input.focus();
                
                // æ›´æ–°ç”¨æˆ·æ´»åŠ¨çŠ¶æ€
                await updateUserStatus(true);
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
            }
        }

        // æ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€
        async function updateUserStatus(isOnline) {
            if (!currentUser) return;
            
            try {
                const statusRef = database.ref('status/' + currentUser.userId);
                await statusRef.set({
                    userName: currentUser.userName,
                    isOnline: isOnline,
                    lastActive: new Date().toISOString(),
                    forum: currentForum
                });
                
                document.getElementById('statusText').textContent = isOnline ? 'åœ¨çº¿' : 'å·²ç¦»çº¿';
            } catch (error) {
                console.error('æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function loadUsers() {
            const usersList = document.getElementById('usersList');
            const userCountEl = document.getElementById('userCount');
            const onlineCountEl = document.getElementById('onlineCountHeader');
            
            usersList.innerHTML = '';
            
            const statusRef = database.ref('status');
            statusRef.on('value', snapshot => {
                usersList.innerHTML = '';
                let total = 0;
                let online = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const user = child.val();
                        total++;
                        if (user.isOnline) online++;
                        
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <div class="user-main">
                                <div class="user-avatar">${user.userName ? user.userName.charAt(0).toUpperCase() : '?'}</div>
                                <div>
                                    <div class="user-name">${escapeHtml(user.userName || 'åŒ¿å')}</div>
                                    <div class="user-tag">${forumNames[user.forum] || 'æœªçŸ¥æ¿å—'}</div>
                                </div>
                            </div>
                            <div class="user-status-dot" style="opacity:${user.isOnline ? 1 : 0.35};box-shadow:${user.isOnline ? '' : 'none'}"></div>
                        `;
                        usersList.appendChild(userItem);
                    });
                }
                
                userCountEl.textContent = total;
                onlineCountEl.textContent = online;
                
                if (total === 0) {
                    usersList.innerHTML = '<div class="empty-state"><p>æš‚æ— åœ¨çº¿ç”¨æˆ·</p></div>';
                }
            });
        }

        // äº‹ä»¶ç»‘å®š
        function setupEventListeners() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            sendButton.addEventListener('click', sendMessage);
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            window.addEventListener('beforeunload', function() {
                updateUserStatus(false);
            });
        }
    </script>
</body>
</html>
