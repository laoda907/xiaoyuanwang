<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ–°å‡çº§èŠå¤©å®¤</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 20px;
      font-weight: bold;
    }

    /* å¹¿åœºæŒ‰é’®æ  */
    #forumBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      gap: 10px;
      font-size: 14px;
    }

    .forumBtn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #16213e;
      color: #fff;
      cursor: pointer;
    }

    .forumBtn.active {
      background: #3498db !important;
    }

    /* éŸ³ä¹æ  & ä¸‹é›ªæŒ‰é’® */
    #bgmBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #bgmSelect {
      padding: 6px 10px;
      border-radius: 5px;
      background: #16213e;
      color: #fff;
      border: none;
    }

    /* èŠå¤©åŒºåŸŸ */
    #chatArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* æ¶ˆæ¯æ€»å¸ƒå±€ */
    .msgWrapper {
      display: flex;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .msgWrapper.me {
      justify-content: flex-end;
    }

    /* ğŸŒˆ å¤´åƒåŠæ¸å˜å…‰åœˆ */
    .avatarWrapper {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      padding: 3px;
      background: conic-gradient(from 0deg, #8bd3ff, #b28bff, #ff8bd4, #8bd3ff);
      animation: rotateGlow 4s linear infinite;
      margin-right: 10px;
      flex-shrink: 0;
    }

    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: #3498db;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      user-select: none;
    }

    .msgWrapper.me .avatarWrapper {
      margin-left: 10px;
      margin-right: 0;
    }

    .msgBubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.08);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .msgWrapper.me .msgBubble {
      background: rgba(52,152,219,0.3);
    }

    .msgName {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 3px;
    }

    /* è¾“å…¥æ  */
    #inputBar {
      display: flex;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    #msgInput {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 16px;
      resize: none;
      outline: none;
      white-space: pre-wrap;
    }

    #sendBtn {
      margin-left: 10px;
      padding: 12px 20px;
      background: #3498db;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: #fff;
    }

    /* â„ é›ªèŠ± */
    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 10px;
      opacity: 0.8;
      pointer-events: none;
      z-index: 9999;
      filter: drop-shadow(0 0 4px white);
      animation: fall linear forwards;
    }

    @keyframes fall {
      0% { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(110vh) rotate(360deg); }
    }

  </style>
</head>

<body>

  <header>ğŸ”¥ å…¨æ–°å‡çº§èŠå¤©å®¤</header>

  <!-- å¹¿åœºæ  -->
  <div id="forumBar">
    <button class="forumBtn active" data-f="general">ç»¼åˆå¹¿åœº</button>
    <button class="forumBtn" data-f="study">å­¦ä¹ å¹¿åœº</button>
    <button class="forumBtn" data-f="fun">å¨±ä¹å¹¿åœº</button>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ + ä¸‹é›ª -->
  <div id="bgmBar">
    <span>èƒŒæ™¯éŸ³ä¹ï¼š</span>
    <select id="bgmSelect">
      <option value="none">å…³é—­</option>
      <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20110423105222-NTk0NTM5.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆåŸç‰ˆï¼‰</option>
      <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/music/20160709113245-MjU1ODA3.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆé’¢ç´ï¼‰</option>
    </select>

    <!-- ä¸‹é›ªæŒ‰é’® -->
    <button id="snowToggle" style="
        padding: 6px 12px;
        margin-left: 10px;
        border-radius: 6px;
        border: none;
        background: #3498db;
        color: white;
        cursor: pointer;
    "> â„ ä¸‹é›ª </button>
  </div>

  <audio id="bgmPlayer" loop></audio>

  <!-- èŠå¤©å†…å®¹ -->
  <div id="chatArea"></div>

  <!-- è¾“å…¥æ  -->
  <div id="inputBar">
    <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
    <button id="sendBtn">å‘é€</button>
  </div>

<script>
/* ======= è¯»å–ç”¨æˆ·ç™»å½•ä¿¡æ¯ ======= */
function getUserSession() {
  const str = localStorage.getItem("xiaoyuan_session");
  if (!str) return null;

  try {
    const decoded = atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
    return JSON.parse(decodeURIComponent(decoded));
  } catch (e) {
    return null;
  }
}

const SESSION = getUserSession();
const USER_NAME = SESSION ? SESSION.userName : "åŒ¿åç”¨æˆ·";
const USER_ID = SESSION ? SESSION.userId : "user_" + Math.random().toString(36).slice(2, 10);

/* ---------------- Firebase åˆå§‹åŒ– ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
  authDomain: "laoda907-22511.firebaseapp.com",
  databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laoda907-22511",
  storageBucket: "laoda907-22511.appspot.com",
  messagingSenderId: "176173610464",
  appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- å…¨å±€å˜é‡ ---------------- */
let forum = "general";
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const forumButtons = document.querySelectorAll(".forumBtn");
const currentUserId = USER_ID;
let currentMessagesRef = null;

/* ---------------- è¿‡æ»¤æ§åˆ¶ç¬¦ ---------------- */
function cleanText(text) {
  return text.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "");
}

/* ==== è‡ªåŠ¨ç”Ÿæˆå¤´åƒ ==== */
function getAvatarLetter(name) {
  return name ? name[0] : "ç”¨";
}

function getAvatarColor(name) {
  const colors = ["#3498db","#9b59b6","#e67e22","#e91e63","#1abc9c","#f39c12"];
  let sum = 0;
  for (let i = 0; i < name.length; i++) sum += name.charCodeAt(i);
  return colors[sum % colors.length];
}

/* ==== æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå«å¤´åƒ+å…‰åœˆï¼‰ ==== */
function addMsg(msg) {
  const isOwn = msg.userId === currentUserId;

  const wrapper = document.createElement("div");
  wrapper.className = "msgWrapper" + (isOwn ? " me" : "");

  const avatarWrapper = document.createElement("div");
  avatarWrapper.className = "avatarWrapper";

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.style.background = getAvatarColor(msg.userName);
  avatar.textContent = getAvatarLetter(msg.userName);

  avatarWrapper.appendChild(avatar);

  const bubble = document.createElement("div");
  bubble.className = "msgBubble";

  const nameTag = document.createElement("div");
  nameTag.className = "msgName";
  nameTag.textContent = msg.userName;

  const textTag = document.createElement("div");
  textTag.textContent = msg.text;

  bubble.appendChild(nameTag);
  bubble.appendChild(textTag);

  if (isOwn) {
    wrapper.appendChild(bubble);
    wrapper.appendChild(avatarWrapper);
  } else {
    wrapper.appendChild(avatarWrapper);
    wrapper.appendChild(bubble);
  }

  chatArea.appendChild(wrapper);
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ---------------- æ™ºèƒ½è¿‡æ»¤ç³»ç»Ÿï¼ˆä¸è¯¯ä¼¤å•å­—ï¼‰ ---------------- */
const SMART_BAD_WORD_PATTERNS = [
  /æ“ä½ å¦ˆ|è‰ä½ å¦ˆ|è‰¹ä½ å¦ˆ|æˆ‘æ“ä½ å¦ˆ/gi,
  /å‚»é€¼|æ²™æ¯”|ç…ç¬”|å‚»å±Œ|å‚»å¼/gi,
  /å¦ˆçš„|ä»–å¦ˆçš„/gi,
  /æ­»å¦ˆ|ä½ å¦ˆæ­»äº†/gi,
  /æ‚ç§|è´±äºº|å©Šå­/gi,
  /å‚»[\s\-\*_]+é€¼/gi,
  /\bsha[\s\.\-\*_]*bi\b/gi,
  /\bsb\b/gi,
  /\bs[\s\.\-\*_]*b\b/gi,
  /\bnm[\s\.\-\*_]*sl\b/gi,
  /\bnmsl\b/gi
];

function smartFilter(text) {
  SMART_BAD_WORD_PATTERNS.forEach(pattern => {
    text = text.replace(pattern, m => "*".repeat(m.length));
  });
  return text;
}

/* ---------------- ç›‘å¬æ¶ˆæ¯ ---------------- */
function attachMessagesListener() {
  chatArea.innerHTML = "";

  if (currentMessagesRef) currentMessagesRef.off();

  const ref = db.ref("forums/" + forum + "/messages");
  currentMessagesRef = ref;

  ref.limitToLast(200).on("child_added", snapshot => {
    const msg = snapshot.val();
    if (!msg) return;

    addMsg({
      userId: msg.userId,
      userName: msg.userName || "ç”¨æˆ·",
      text: cleanText(msg.text)
    });
  });
}

/* ---------------- å‘é€æ¶ˆæ¯ ---------------- */
function sendMessage() {
  let raw = input.value;
  let text = cleanText(raw.trim());
  if (!text) return;

  text = smartFilter(text);

  const ref = db.ref("forums/" + forum + "/messages");
  ref.push({
    userId: currentUserId,
    userName: USER_NAME,
    text: text,
    timestamp: Date.now()
  });

  input.value = "";
  input.focus();
}

sendBtn.addEventListener("click", sendMessage);

/* ---------------- åˆ‡æ¢å¹¿åœº ---------------- */
forumButtons.forEach(btn => {
  btn.onclick = () => {
    forumButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    forum = btn.getAttribute("data-f");
    attachMessagesListener();
  };
});

attachMessagesListener();

/* ---------------- èƒŒæ™¯éŸ³ä¹ ---------------- */
const bgmPlayer = document.getElementById("bgmPlayer");
const bgmSelect = document.getElementById("bgmSelect");

bgmSelect.onchange = () => {
  if (bgmSelect.value === "none") {
    bgmPlayer.pause();
  } else {
    bgmPlayer.src = bgmSelect.value;
    bgmPlayer.play();
  }
};

/* ---------------- â„ ä¸‹é›ªç³»ç»Ÿ ---------------- */
let snowInterval = null;
let snowEnabled = false;

document.getElementById("snowToggle").onclick = function () {
  snowEnabled = !snowEnabled;

  if (snowEnabled) {
    this.textContent = "â„ å…³é—­ä¸‹é›ª";
    startSnow();
  } else {
    this.textContent = "â„ ä¸‹é›ª";
    stopSnow();
  }
};

function createSnowflake() {
  const snow = document.createElement("div");
  snow.className = "snowflake";
  snow.textContent = "â„";

  const size = Math.random() * 10 + 8;
  snow.style.fontSize = size + "px";

  snow.style.left = Math.random() * 100 + "vw";

  const duration = Math.random() * 7 + 8;
  snow.style.animationDuration = duration + "s";

  document.body.appendChild(snow);

  setTimeout(() => snow.remove(), duration * 1000);
}

function startSnow() {
  if (snowInterval) return;
  snowInterval = setInterval(createSnowflake, 200);
}

function stopSnow() {
  clearInterval(snowInterval);
  snowInterval = null;
}
</script>

</body>
</html>
