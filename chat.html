<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨æ–°å‡çº§èŠå¤©å®¤</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a2e;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 20px;
      font-weight: bold;
    }

    /* å¤šå¹¿åœºæŒ‰é’®æ  */
    #forumBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      gap: 10px;
      font-size: 14px;
    }

    .forumBtn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #16213e;
      color: #fff;
      cursor: pointer;
    }

    .forumBtn.active {
      background: #3498db !important;
    }

    /* èƒŒæ™¯éŸ³ä¹æ  */
    #bgmBar {
      padding: 12px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #bgmSelect {
      padding: 6px 10px;
      border-radius: 5px;
      background: #16213e;
      color: #fff;
      border: none;
    }

    /* èŠå¤©åŒº */
    #chatArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .msg {
      background: rgba(255,255,255,0.08);
      padding: 10px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      max-width: 75%;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .me {
      background: rgba(52,152,219,0.3);
      margin-left: auto;
    }

    /* è¾“å…¥åŒº */
    #inputBar {
      display: flex;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    #msgInput {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 16px;
      resize: none;
      white-space: pre-wrap;
      outline: none;
    }

    #sendBtn {
      margin-left: 10px;
      padding: 12px 20px;
      background: #3498db;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      color: #fff;
    }
  </style>
</head>

<body>

  <header>ğŸ”¥ å…¨æ–°å‡çº§èŠå¤©å®¤</header>

  <!-- ä¸‰å¤§å¹¿åœº -->
  <div id="forumBar">
    <button class="forumBtn active" data-f="general">ç»¼åˆå¹¿åœº</button>
    <button class="forumBtn" data-f="study">å­¦ä¹ å¹¿åœº</button>
    <button class="forumBtn" data-f="fun">å¨±ä¹å¹¿åœº</button>
  </div>

  <!-- èƒŒæ™¯éŸ³ä¹ -->
  <div id="bgmBar">
    <span>èƒŒæ™¯éŸ³ä¹ï¼š</span>
    <select id="bgmSelect">
      <option value="none">å…³é—­</option>

      <!-- ğŸ‘‡ğŸ‘‡ğŸ‘‡ ç‰¢å¤§åœ¨è¿™é‡Œæ›¿æ¢æˆä½ è‡ªå·±çš„ mp3 é“¾æ¥ ğŸ‘‡ğŸ‘‡ğŸ‘‡ -->
      <option value="https://raw.githubusercontent.com/laoda907/xiaoyuanwang/main/20110423105222-NTk0NTM5.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆåŸç‰ˆï¼‰</option>
      <option value="ä½ çš„é’¢ç´ç‰ˆé“¾æ¥2.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆé’¢ç´ï¼‰</option>
      <option value="ä½ çš„æ²»æ„ˆç‰ˆé“¾æ¥3.mp3">ç©¿è¶Šæ—¶ç©ºçš„æ€å¿µï¼ˆæ²»æ„ˆç‰ˆï¼‰</option>
      <!-- ä»¥ä¸Š URL ä½ å¯ä»¥æ¢æˆä½ è‡ªå·±æœåŠ¡å™¨çš„ / å¤–é“¾ mp3 -->
    </select>
  </div>

  <!-- æ’­æ”¾å™¨ -->
  <audio id="bgmPlayer" loop></audio>

  <!-- èŠå¤©å†…å®¹ -->
  <div id="chatArea"></div>

  <!-- è¾“å…¥åŒº -->
  <div id="inputBar">
    <textarea id="msgInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
    <button id="sendBtn">å‘é€</button>
  </div>

  <!-- ==================== JavaScript ==================== -->
  <script>
    /* ---------------- Firebase åˆå§‹åŒ– ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
      authDomain: "laoda907-22511.firebaseapp.com",
      databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "laoda907-22511",
      storageBucket: "laoda907-22511.appspot.com",
      messagingSenderId: "176173610464",
      appId: "1:176173610464:web:3ff86202f9b05f24b36785"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ---------------- å…¨å±€å˜é‡ ---------------- */
    let forum = "general"; // å½“å‰å¹¿åœºï¼šgeneral / study / fun
    const chatArea = document.getElementById("chatArea");
    const input = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const forumButtons = document.querySelectorAll(".forumBtn");

    const currentUserId = "user_" + Math.random().toString(36).slice(2, 10);

    // å½“å‰çš„ Firebase æ¶ˆæ¯ç›‘å¬å¼•ç”¨ï¼ˆç”¨äº off é˜²é‡ï¼‰
    let currentMessagesRef = null;

    /* ---------------- æ–‡æœ¬æ¸…ç†ï¼ˆé˜²æ­¢æ§åˆ¶å­—ç¬¦ç­‰ï¼‰ ---------------- */
    function cleanText(text) {
      if (typeof text !== "string") return "";
      // å»æ‰å¥‡æ€ªçš„åŒå‘æ§åˆ¶ç¬¦ï¼Œé˜²æ­¢å†æ¬¡å‡ºç°ä¹±åº
      return text.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g, "");
    }

    /* ---------------- æ˜¾ç¤ºæ¶ˆæ¯ ---------------- */
    function addMsg(text, isOwn) {
      const div = document.createElement("div");
      div.className = "msg" + (isOwn ? " me" : "");
      div.textContent = text;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    /* ---------------- åŠ è½½å¹¶ç›‘å¬æ¶ˆæ¯ï¼ˆæ ¸å¿ƒï¼‰ ---------------- */
    function attachMessagesListener() {
      // æ¸…ç©ºå½“å‰ UI
      chatArea.innerHTML = "";

      // â—å…ˆè§£é™¤ä¹‹å‰çš„ç›‘å¬ï¼Œé˜²æ­¢å åŠ 
      if (currentMessagesRef) {
        currentMessagesRef.off();
      }

      // æ–°çš„æ¶ˆæ¯è·¯å¾„
      const ref = db.ref("forums/" + forum + "/messages");
      currentMessagesRef = ref;

      // åªç›‘å¬æœ€è¿‘ 200 æ¡
      ref.limitToLast(200).on("child_added", function (snapshot) {
        const msg = snapshot.val() || {};
        const text = cleanText(msg.text || "");
        const isOwn = msg.userId === currentUserId;
        addMsg(text, isOwn);
      });
    }

    /* ---------------- å‘é€æ¶ˆæ¯ ---------------- */
    function sendMessage() {
      let raw = input.value;
      let text = cleanText(raw.trim());
      if (!text) return;

      // âœ åªå†™å…¥æ•°æ®åº“ï¼Œä¸å†æ‰‹åŠ¨ addMsgï¼Œé¿å…é‡å¤
      const ref = db.ref("forums/" + forum + "/messages");
      ref.push({
        userId: currentUserId,
        text: text,
        timestamp: Date.now()
      });

      input.value = "";
      input.focus();
    }

    /* ---------------- äº‹ä»¶ç»‘å®šï¼šå‘é€ ---------------- */
    sendBtn.addEventListener("click", function () {
      sendMessage();
    });

    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    /* ---------------- äº‹ä»¶ç»‘å®šï¼šå¹¿åœºåˆ‡æ¢ ---------------- */
    forumButtons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        forumButtons.forEach(function (b) {
          b.classList.remove("active");
        });
        btn.classList.add("active");

        forum = btn.getAttribute("data-f");
        attachMessagesListener();
      });
    });

    /* ---------------- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ ---------------- */
    const bgmPlayer = document.getElementById("bgmPlayer");
    const bgmSelect = document.getElementById("bgmSelect");

    bgmSelect.addEventListener("change", function () {
      const url = bgmSelect.value;
      if (!url || url === "none") {
        bgmPlayer.pause();
        bgmPlayer.removeAttribute("src");
      } else {
        bgmPlayer.src = url;
        bgmPlayer.volume = 0.5;
        bgmPlayer.play().catch(function (e) {
          console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æµè§ˆå™¨é™åˆ¶è‡ªåŠ¨æ’­æ”¾ï¼‰:", e);
        });
      }
    });

    /* ---------------- åˆå§‹åŒ– ---------------- */
    attachMessagesListener();
  </script>
</body>
</html>
