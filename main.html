<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - èŠå¤©å¹³å°</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ Firebase 7.24.0 ç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="navbar">
        <div class="logo">
            <h2>ğŸ« æ ¡å›­ç½‘èŠå¤©å¹³å°</h2>
        </div>
        <div class="user-info">
            <span id="userName">åŠ è½½ä¸­...</span>
            <button onclick="logout()" class="logout-btn">é€€å‡º</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container">
        <!-- å·¦ä¾§è®ºå›é€‰æ‹© -->
        <div class="sidebar">
            <div class="forum-list">
                <h3>ğŸ“š æ ¡å›­è®ºå›</h3>
                <div class="forum-item active" data-forum="general" onclick="switchForum('general')">
                    <span class="forum-icon">ğŸ’¬</span>
                    <span class="forum-name">ç»¼åˆè®¨è®ºåŒº</span>
                    <span class="unread-count" id="unread-general">0</span>
                </div>
                <div class="forum-item" data-forum="study" onclick="switchForum('study')">
                    <span class="forum-icon">ğŸ“–</span>
                    <span class="forum-name">å­¦ä¹ äº¤æµ</span>
                    <span class="unread-count" id="unread-study">0</span>
                </div>
                <div class="forum-item" data-forum="fun" onclick="switchForum('fun')">
                    <span class="forum-icon">ğŸ®</span>
                    <span class="forum-name">ä¼‘é—²å¨±ä¹</span>
                    <span class="unread-count" id="unread-fun">0</span>
                </div>
            </div>
            
            <div class="online-users">
                <h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ· (<span id="onlineCount">0</span>)</h3>
                <div id="onlineList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§èŠå¤©åŒº -->
        <div class="chat-area">
            <!-- å½“å‰è®ºå›æ ‡é¢˜ -->
            <div class="chat-header">
                <h2 id="currentForum">ç»¼åˆè®¨è®ºåŒº</h2>
                <div class="forum-stats">
                    <span>ğŸ“ <span id="messageCount">0</span> æ¡æ¶ˆæ¯</span>
                    <span>ğŸ‘¥ <span id="forumOnlineCount">0</span> äººåœ¨çº¿</span>
                </div>
            </div>

            <!-- æ¶ˆæ¯å±•ç¤ºåŒº -->
            <div class="messages-container" id="messagesContainer">
                <div class="welcome-message">
                    <p>ğŸ‘‹ æ¬¢è¿æ¥åˆ°æ ¡å›­ç½‘èŠå¤©å¹³å°ï¼</p>
                    <p>é€‰æ‹©ä¸€ä¸ªè®ºå›å¼€å§‹èŠå¤©å§ï½</p>
                </div>
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>

            <!-- æ¶ˆæ¯è¾“å…¥åŒº -->
            <div class="message-input">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="åœ¨è¿™é‡Œè¾“å…¥æ¶ˆæ¯... (æŒ‰ Enter å‘é€)"
                    maxlength="500"
                    onkeypress="if(event.keyCode===13) sendMessage()"
                >
                <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
                <button onclick="clearChat()" class="clear-btn">æ¸…ç©ºèŠå¤©</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>åŠ è½½ä¸­...</p>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        // ========== Firebase é…ç½®ï¼ˆä¸ index.html ä¸€è‡´ï¼‰==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };
        
        // å…¨å±€å˜é‡
        let auth, database;
        let currentUser = null;
        let currentForum = 'general';
        let messagesRef = null;
        let onlineRef = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        async function initApp() {
            showLoading(true);
            
            try {
                // åˆå§‹åŒ– Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                database = firebase.database();
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserInfo();
                        setupChat();
                        updateOnlineStatus();
                    } else {
                        // æœªç™»å½•ï¼Œè·³å›é¦–é¡µ
                        window.location.href = 'index.html';
                    }
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                showLoading(false);
            }
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const userRef = database.ref('users/' + currentUser.uid);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('userName').textContent = userData.name || 'æœªçŸ¥ç”¨æˆ·';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }
        
        // è®¾ç½®èŠå¤©åŠŸèƒ½
        function setupChat() {
            // é»˜è®¤è¿›å…¥ç»¼åˆè®¨è®ºåŒº
            switchForum('general');
            showLoading(false);
        }
        
        // åˆ‡æ¢è®ºå›
        function switchForum(forumId) {
            // æ›´æ–°UI
            document.querySelectorAll('.forum-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-forum="${forumId}"]`).classList.add('active');
            
            // æ›´æ–°å½“å‰è®ºå›
            currentForum = forumId;
            
            // æ›´æ–°æ ‡é¢˜
            const forumNames = {
                'general': 'ç»¼åˆè®¨è®ºåŒº',
                'study': 'å­¦ä¹ äº¤æµ',
                'fun': 'ä¼‘é—²å¨±ä¹'
            };
            document.getElementById('currentForum').textContent = forumNames[forumId];
            
            // æ¸…ç©ºæœªè¯»è®¡æ•°
            document.getElementById(`unread-${forumId}`).textContent = '0';
            
            // åŠ è½½è¯¥è®ºå›çš„æ¶ˆæ¯
            loadMessages();
            
            // æ›´æ–°è®ºå›åœ¨çº¿äººæ•°
            updateForumOnlineCount();
        }
        
        // åŠ è½½æ¶ˆæ¯
        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div class="loading">åŠ è½½æ¶ˆæ¯ä¸­...</div>';
            
            // æ¸…é™¤ä¹‹å‰çš„ç›‘å¬
            if (messagesRef) {
                messagesRef.off();
            }
            
            // ç›‘å¬æ–°æ¶ˆæ¯
            messagesRef = database.ref(`forums/${currentForum}/messages`);
            messagesRef.limitToLast(50).on('value', (snapshot) => {
                const messages = [];
                snapshot.forEach((childSnapshot) => {
                    messages.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                displayMessages(messages);
                updateMessageCount(messages.length);
            });
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <p>ğŸ“­ è¿™ä¸ªè®ºå›è¿˜æ²¡æœ‰æ¶ˆæ¯</p>
                        <p>å¿«æ¥å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            messages.forEach(msg => {
                const isOwn = msg.userId === currentUser.uid;
                const time = new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="message ${isOwn ? 'own' : 'other'}">
                        <div class="message-header">
                            <span class="sender">${msg.userName}</span>
                            <span class="time">${time}</span>
                        </div>
                        <div class="message-content">
                            ${escapeHtml(msg.text)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            const btn = document.getElementById('sendBtn');
            
            if (!text) return;
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤å‘é€
            btn.disabled = true;
            btn.textContent = 'å‘é€ä¸­...';
            
            try {
                // è·å–ç”¨æˆ·å
                const userRef = database.ref('users/' + currentUser.uid);
                const snapshot = await userRef.once('value');
                const userName = snapshot.val()?.name || 'åŒ¿åç”¨æˆ·';
                
                // åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
                const message = {
                    text: text,
                    userId: currentUser.uid,
                    userName: userName,
                    timestamp: new Date().toISOString(),
                    forum: currentForum
                };
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await database.ref(`forums/${currentForum}/messages`).push(message);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                input.focus();
                
                showToast('æ¶ˆæ¯å·²å‘é€', 'success');
                
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showToast('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'å‘é€';
            }
        }
        
        // æ›´æ–°åœ¨çº¿çŠ¶æ€
        function updateOnlineStatus() {
            const userStatusRef = database.ref(`status/${currentUser.uid}`);
            const userInfoRef = database.ref(`users/${currentUser.uid}`);
            
            // è®¾ç½®åœ¨çº¿
            userStatusRef.set({
                online: true,
                lastSeen: new Date().toISOString(),
                forum: currentForum
            });
            
            // æ–­å¼€è¿æ¥æ—¶è®¾ç½®ä¸ºç¦»çº¿
            userStatusRef.onDisconnect().set({
                online: false,
                lastSeen: new Date().toISOString()
            });
            
            // ç›‘å¬åœ¨çº¿ç”¨æˆ·
            onlineRef = database.ref('status');
            onlineRef.on('value', (snapshot) => {
                const users = [];
                let onlineCount = 0;
                
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data.online) {
                        onlineCount++;
                        users.push({
                            id: childSnapshot.key,
                            ...data
                        });
                    }
                });
                
                updateOnlineList(users);
                document.getElementById('onlineCount').textContent = onlineCount;
            });
        }
        
        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        async function updateOnlineList(users) {
            const container = document.getElementById('onlineList');
            let html = '';
            
            for (const user of users) {
                try {
                    // è·å–ç”¨æˆ·å
                    const userInfo = await database.ref('users/' + user.id).once('value');
                    const userName = userInfo.val()?.name || 'åŒ¿åç”¨æˆ·';
                    
                    html += `
                        <div class="online-user">
                            <span class="online-dot">â—</span>
                            <span class="online-name">${userName}</span>
                            <span class="online-forum">${getForumName(user.forum)}</span>
                        </div>
                    `;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                }
            }
            
            container.innerHTML = html || '<div class="no-users">æš‚æ— å…¶ä»–åœ¨çº¿ç”¨æˆ·</div>';
        }
        
        // æ›´æ–°è®ºå›åœ¨çº¿äººæ•°
        function updateForumOnlineCount() {
            if (!onlineRef) return;
            
            onlineRef.once('value').then((snapshot) => {
                let count = 0;
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data.online && data.forum === currentForum) {
                        count++;
                    }
                });
                document.getElementById('forumOnlineCount').textContent = count;
            });
        }
        
        // æ¸…ç©ºèŠå¤©
        async function clearChat() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰è®ºå›çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                showLoading(true);
                await database.ref(`forums/${currentForum}/messages`).remove();
                showToast('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
            } catch (error) {
                console.error('æ¸…ç©ºèŠå¤©å¤±è´¥:', error);
                showToast('æ¸…ç©ºå¤±è´¥', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                showLoading(true);
                
                // æ›´æ–°åœ¨çº¿çŠ¶æ€ä¸ºç¦»çº¿
                if (currentUser) {
                    await database.ref(`status/${currentUser.uid}`).set({
                        online: false,
                        lastSeen: new Date().toISOString()
                    });
                }
                
                // Firebase ç™»å‡º
                await auth.signOut();
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.clear();
                sessionStorage.clear();
                
                // è·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥:', error);
                showToast('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                showLoading(false);
            }
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæç¤º
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // å·¥å…·å‡½æ•°ï¼šè·å–è®ºå›åç§°
        function getForumName(forumId) {
            const names = {
                'general': 'ç»¼åˆ',
                'study': 'å­¦ä¹ ',
                'fun': 'å¨±ä¹'
            };
            return names[forumId] || 'æœªçŸ¥';
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°æ¶ˆæ¯è®¡æ•°
        function updateMessageCount(count) {
            document.getElementById('messageCount').textContent = count;
        }
        
    </script>
</body>
  </html>
