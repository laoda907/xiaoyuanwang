<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <!-- åŠ è½½ä¿®å¤è„šæœ¬ -->
    <script src="fix.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="registerUser()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== é…ç½®æ–‡ä»¶ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // åˆå§‹åŒ– Firebase - ä¿®å¤ç‰ˆï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
        let auth, database;
        try {
            // ğŸ”¥ ä¿®å¤ï¼šå…ˆæ£€æŸ¥Firebaseæ˜¯å¦å·²åŠ è½½
            if (typeof firebase === 'undefined') {
                console.warn('FirebaseæœªåŠ è½½ï¼Œç­‰å¾…é‡è¯•');
                setTimeout(() => {
                    if (typeof firebase !== 'undefined') {
                        initFirebase();
                    }
                }, 1000);
            } else {
                initFirebase();
            }
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            showMessage("ç³»ç»Ÿåˆå§‹åŒ–ä¸­ï¼Œè¯·ç¨å€™...", "");
        }
        
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                database = firebase.database();
                console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
                window.firebaseReady = true;
            } catch (error) {
                console.error("Firebaseåˆå§‹åŒ–é”™è¯¯:", error);
            }
        }

        // ğŸ”¥ ä¿®å¤ç‰ˆï¼šè·å–ç”¨æˆ·IPåœ°å€ï¼ˆæ·»åŠ å¤šä¸ªå¤‡ç”¨APIå’Œè¶…æ—¶ï¼‰
        async function getUserIP() {
            return new Promise((resolve) => {
                const timeout = setTimeout(() => {
                    console.log('IPè·å–è¶…æ—¶ï¼Œä½¿ç”¨å®‰å…¨å€¼');
                    resolve('safe_ip_' + Date.now());
                }, 8000);
                
                const tryAPIs = [
                    () => fetch('https://api.ipify.org?format=json').then(r => r.json()),
                    () => fetch('https://api64.ipify.org?format=json').then(r => r.json()),
                    () => fetch('https://icanhazip.com/').then(r => r.text().then(t => ({ip: t.trim()}))),
                    () => Promise.resolve({ip: 'local_' + Date.now()})
                ];
                
                let currentTry = 0;
                
                function attempt() {
                    if (currentTry >= tryAPIs.length) {
                        clearTimeout(timeout);
                        resolve('fallback_ip_' + Math.random().toString(36).substr(2, 8));
                        return;
                    }
                    
                    tryAPIs[currentTry]()
                        .then(data => {
                            clearTimeout(timeout);
                            resolve(data.ip || String(data).trim() || 'unknown');
                        })
                        .catch(err => {
                            console.log(`API ${currentTry} å¤±è´¥:`, err);
                            currentTry++;
                            setTimeout(attempt, 500);
                        });
                }
                
                attempt();
            });
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ˜¾ç¤º/æ¸…é™¤æ¶ˆæ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        function clearMessage() {
            showMessage('', '');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        async function registerUser() {
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // éªŒè¯
            if (!name || name.length > 8) {
                showMessage('åå­—ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡8ä¸ªå­—', 'error');
                return;
            }
            if (!password || password.length < 6) {
                showMessage('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }
            
            // ğŸ”¥ ä¿®å¤ï¼šç­‰å¾…Firebaseå°±ç»ª
            if (!window.firebaseReady) {
                showMessage('ç³»ç»ŸåŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', '');
                setTimeout(() => registerUser(), 500);
                return;
            }
            
            // è·å–ç”¨æˆ·IP
            showMessage('æ­£åœ¨æ³¨å†Œï¼Œè¯·ç¨å€™...', '');
            
            try {
                const userIP = await getUserIP();
                
                // æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
                const ipCheckSnapshot = await database.ref('ip_registrations/' + userIP).once('value');
                if (ipCheckSnapshot.exists()) {
                    showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·ä½¿ç”¨å·²æ³¨å†Œè´¦å·ç™»å½•', 'error');
                    return;
                }
                
                // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
                const encodedName = encodeURIComponent(name);
                
                // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const nameSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (nameSnapshot.exists()) {
                    showMessage('åå­—å·²è¢«ä½¿ç”¨', 'error');
                    return;
                }
                
                // ç”Ÿæˆç”¨æˆ·ID
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // åŠ å¯†å¯†ç 
                const passwordHash = btoa(password + '|' + Date.now()).split('').reverse().join('');
                
                // ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
                const sessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await database.ref('users/' + userId).set({
                    name: name,
                    encodedName: encodedName,
                    passwordHash: passwordHash,
                    sessionToken: sessionToken,
                    ipAddress: userIP,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                
                // è®°å½•ç”¨æˆ·å
                await database.ref('usernames/' + encodedName).set(userId);
                
                // è®°å½•IPæ³¨å†Œä¿¡æ¯
                await database.ref('ip_registrations/' + userIP).set({
                    userId: userId,
                    userName: name,
                    registeredAt: new Date().toISOString()
                });
                
                // å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: sessionToken,
                    ip: userIP,
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1500);
            } catch (error) {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function loginUser() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!name || !password) {
                showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
                return;
            }
            
            // ğŸ”¥ ä¿®å¤ï¼šç­‰å¾…Firebaseå°±ç»ª
            if (!window.firebaseReady) {
                showMessage('ç³»ç»ŸåŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', '');
                setTimeout(() => loginUser(), 500);
                return;
            }
            
            showMessage('æ­£åœ¨ç™»å½•ï¼Œè¯·ç¨å€™...', '');
            
            // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
            const encodedName = encodeURIComponent(name);
            
            try {
                // æ‰¾ç”¨æˆ·ID
                const idSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (!idSnapshot.exists()) {
                    showMessage('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const userId = idSnapshot.val();
                
                // è·å–ç”¨æˆ·æ•°æ®
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    showMessage('ç”¨æˆ·æ•°æ®é”™è¯¯', 'error');
                    return;
                }
                
                // éªŒè¯å¯†ç 
                try {
                    const reversedHash = userData.passwordHash.split('').reverse().join('');
                    const decoded = atob(reversedHash);
                    const parts = decoded.split('|');
                    if (parts[0] !== password) {
                        throw new Error('å¯†ç ä¸åŒ¹é…');
                    }
                } catch {
                    showMessage('å¯†ç é”™è¯¯', 'error');
                    return;
                }
                
                // ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ
                const newSessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»¤ç‰Œ
                await database.ref('users/' + userId).update({
                    sessionToken: newSessionToken,
                    lastLogin: new Date().toISOString()
                });
                
                // å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: newSessionToken,
                    ip: userData.ipAddress || 'unknown',
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('âœ… ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // è‡ªåŠ¨è·³è½¬ï¼šå¦‚æœå·²ç»ç™»å½•
        function checkIfLoggedIn() {
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (sessionStr) {
                try {
                    const sessionData = JSON.parse(atob(sessionStr));
                    if (Date.now() < sessionData.expiry) {
                        // å·²ç™»å½•ï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
                        window.location.href = 'main.html';
                    }
                } catch (e) {
                    console.log('ä¼šè¯æ•°æ®æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            // ğŸ”¥ ä¿®å¤ï¼šå»¶è¿Ÿæ£€æŸ¥ï¼Œé¿å…é˜»å¡
            setTimeout(checkIfLoggedIn, 500);
            
            // ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
            setTimeout(() => {
                document.querySelectorAll('button').forEach(btn => {
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                });
            }, 1000);
        });
        
        // ğŸ”¥ ä¿®å¤ï¼šæ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('é¡µé¢é”™è¯¯:', e.error);
            // ä¸é˜»æ­¢é¡µé¢è¿è¡Œ
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            // ä¸é˜»æ­¢é¡µé¢è¿è¡Œ
        });
    </script>
    
    <!-- ç´§æ€¥æ¢å¤é¢æ¿ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
    <div id="emergency-panel" style="
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9998;
        font-size: 12px;
        border: 1px solid #e0e0e0;
        max-width: 200px;
    ">
        <div style="font-weight: bold; color: #333; margin-bottom: 5px;">ğŸ”§ é¡µé¢æ§åˆ¶</div>
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <button onclick="location.reload()" style="
                padding: 4px 8px;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
            ">åˆ·æ–°é¡µé¢</button>
            <button onclick="localStorage.clear(); sessionStorage.clear(); location.reload()" style="
                padding: 4px 8px;
                background: #FF9800;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
            ">æ¸…é™¤æ•°æ®</button>
            <button onclick="document.getElementById('emergency-panel').style.display='none'" style="
                padding: 4px 8px;
                background: #9E9E9E;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
            ">éšè—</button>
        </div>
    </div>
</body>
</html>
