<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="registerUser()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== é…ç½®æ–‡ä»¶ ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // åˆå§‹åŒ– Firebase
        let auth, database;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            showMessage("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
        }

        // è·å–ç”¨æˆ·IPåœ°å€
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('è·å–IPå¤±è´¥:', error);
                return 'unknown_ip_' + Date.now();
            }
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ˜¾ç¤º/æ¸…é™¤æ¶ˆæ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        function clearMessage() {
            showMessage('', '');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        async function registerUser() {
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // éªŒè¯
            if (!name || name.length > 8) {
                showMessage('åå­—ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡8ä¸ªå­—', 'error');
                return;
            }
            if (!password || password.length < 6) {
                showMessage('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }
            
            // è·å–ç”¨æˆ·IP
            const userIP = await getUserIP();
            
            // æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
            const ipCheckSnapshot = await database.ref('ip_registrations/' + userIP).once('value');
            if (ipCheckSnapshot.exists()) {
                showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·ä½¿ç”¨å·²æ³¨å†Œè´¦å·ç™»å½•', 'error');
                return;
            }
            
            // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
            const encodedName = encodeURIComponent(name);
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const nameSnapshot = await database.ref('usernames/' + encodedName).once('value');
            if (nameSnapshot.exists()) {
                showMessage('åå­—å·²è¢«ä½¿ç”¨', 'error');
                return;
            }
            
            // ç”Ÿæˆç”¨æˆ·ID
            const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // åŠ å¯†å¯†ç 
            const passwordHash = btoa(password + '|' + Date.now()).split('').reverse().join('');
            
            // ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
            const sessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            await database.ref('users/' + userId).set({
                name: name,
                encodedName: encodedName,
                passwordHash: passwordHash,
                sessionToken: sessionToken,
                ipAddress: userIP,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            });
            
            // è®°å½•ç”¨æˆ·å
            await database.ref('usernames/' + encodedName).set(userId);
            
            // è®°å½•IPæ³¨å†Œä¿¡æ¯
            await database.ref('ip_registrations/' + userIP).set({
                userId: userId,
                userName: name,
                registeredAt: new Date().toISOString()
            });
            
            // å®‰å…¨ä¿å­˜ä¼šè¯
            const sessionData = {
                userId: userId,
                userName: name,
                token: sessionToken,
                ip: userIP,
                expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
            };
            localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
            
            showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
            setTimeout(() => {
                window.location.href = 'chat.html';
            }, 1500);
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function loginUser() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!name || !password) {
                showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
                return;
            }
            
            // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
            const encodedName = encodeURIComponent(name);
            
            // æ‰¾ç”¨æˆ·ID
            const idSnapshot = await database.ref('usernames/' + encodedName).once('value');
            if (!idSnapshot.exists()) {
                showMessage('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            const userId = idSnapshot.val();
            
            // è·å–ç”¨æˆ·æ•°æ®
            const userSnapshot = await database.ref('users/' + userId).once('value');
            const userData = userSnapshot.val();
            
            if (!userData) {
                showMessage('ç”¨æˆ·æ•°æ®é”™è¯¯', 'error');
                return;
            }
            
            // éªŒè¯å¯†ç 
            try {
                const reversedHash = userData.passwordHash.split('').reverse().join('');
                const decoded = atob(reversedHash);
                const parts = decoded.split('|');
                if (parts[0] !== password) {
                    throw new Error('å¯†ç ä¸åŒ¹é…');
                }
            } catch {
                showMessage('å¯†ç é”™è¯¯', 'error');
                return;
            }
            
            // ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ
            const newSessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
            
            // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»¤ç‰Œ
            await database.ref('users/' + userId).update({
                sessionToken: newSessionToken,
                lastLogin: new Date().toISOString()
            });
            
            // å®‰å…¨ä¿å­˜ä¼šè¯
            const sessionData = {
                userId: userId,
                userName: name,
                token: newSessionToken,
                ip: userData.ipAddress || 'unknown',
                expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
            };
            localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
            
            showMessage('âœ… ç™»å½•æˆåŠŸï¼', 'success');
            setTimeout(() => {
                window.location.href = 'main.html';
            }, 1000);
        }

        // è‡ªåŠ¨è·³è½¬ï¼šå¦‚æœå·²ç»ç™»å½•
        function checkIfLoggedIn() {
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (sessionStr) {
                try {
                    const sessionData = JSON.parse(atob(sessionStr));
                    if (Date.now() < sessionData.expiry) {
                        // å·²ç™»å½•ï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
                        window.location.href = 'main.html';
                    }
                } catch (e) {
                    console.log('ä¼šè¯æ•°æ®æ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkIfLoggedIn();
        });
    </script>
</body>
</html>
