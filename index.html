<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园网 - 登录</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
<div class="auth-container">
    <h1>🏫 校园网</h1>
    <p class="subtitle">连接每一个校园角落</p>

    <div class="form-container" id="loginForm">
        <h2>登录</h2>
        <input type="text" id="loginName" placeholder="你的名字" maxlength="8">
        <input type="password" id="loginPassword" placeholder="密码">
        <button onclick="loginUser()">进入校园</button>
        <p class="switch-text">还没有账号？ <a href="#" onclick="showRegister()">点此注册</a></p>
    </div>

    <div class="form-container" id="registerForm" style="display:none;">
        <h2>注册新账号</h2>
        <input type="text" id="registerName" placeholder="取个名字（最多8字）" maxlength="8">
        <input type="password" id="registerPassword" placeholder="设置密码">
        <button onclick="registerUser()">注册</button>
        <p class="switch-text">已有账号？ <a href="#" onclick="showLogin()">点此登录</a></p>
    </div>

    <div id="message" class="message"></div>
</div>

<script>
/* ========= 安全Base64函数 ========= */
function safeBtoa(str) {
    return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (_, p1) {
            return String.fromCharCode('0x' + p1);
        })
    );
}

function safeAtob(str) {
    try {
        return decodeURIComponent(
            atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
        );
    } catch (e) {
        console.error('解码失败:', e);
        return null;
    }
}

/* ========= Firebase 配置 ========= */
const firebaseConfig = {
    apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
    authDomain: "laoda907-22511.firebaseapp.com",
    databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "laoda907-22511",
    storageBucket: "laoda907-22511.firebasestorage.app",
    messagingSenderId: "176173610464",
    appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

let database;
firebase.initializeApp(firebaseConfig);
database = firebase.database();

/* ========= 获取用户IP ========= */
async function getUserIP() {
    try {
        // 先尝试使用ipify.org
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        try {
            // 备用API
            const response = await fetch('https://api64.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error2) {
            console.error('获取IP失败:', error2);
            // 生成一个随机ID作为备用
            return 'ip_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
    }
}

/* ========= 工具函数 ========= */
function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
}
function showRegister() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    showMessage('', '');
}
function showLogin() {
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    showMessage('', '');
}

/* ========= 清理数据库（临时函数，成功后可以删除）========= */
function cleanDatabase() {
    if (confirm('确定要清空数据库吗？这将删除所有用户数据！')) {
        database.ref().remove()
            .then(() => {
                alert('数据库已清空，现在可以正常注册了！');
                location.reload();
            })
            .catch(error => {
                console.error('清空数据库失败:', error);
                alert('清空失败: ' + error.message);
            });
    }
}

// 添加清理按钮（测试完成后可以删除）
document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.auth-container');
    const cleanBtn = document.createElement('button');
    cleanBtn.textContent = '🧹 清空数据库（调试用）';
    cleanBtn.style.marginTop = '10px';
    cleanBtn.style.padding = '5px 10px';
    cleanBtn.style.background = '#ff6b6b';
    cleanBtn.style.color = 'white';
    cleanBtn.style.border = 'none';
    cleanBtn.style.borderRadius = '5px';
    cleanBtn.style.cursor = 'pointer';
    cleanBtn.onclick = cleanDatabase;
    container.appendChild(cleanBtn);
});

/* ========= 检查用户名是否存在（新版）========= */
async function checkUsernameExists(name) {
    try {
        // 查询所有用户
        const usersRef = database.ref('users');
        const snapshot = await usersRef.once('value');
        
        if (!snapshot.exists()) {
            console.log('数据库中没有用户，用户名可用');
            return false;
        }
        
        const users = snapshot.val();
        let exists = false;
        
        // 遍历所有用户，检查用户名
        for (let userId in users) {
            if (users[userId].name === name) {
                console.log('找到重复用户名:', name);
                exists = true;
                break;
            }
        }
        
        return exists;
    } catch (error) {
        console.error('检查用户名失败:', error);
        // 出错时返回false，让注册继续
        return false;
    }
}

/* ========= 注册 ========= */
async function registerUser() {
    const name = registerName.value.trim();
    const password = registerPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    if (name.length > 8) {
        alert('用户名不能超过8个字符');
        return;
    }

    showMessage('正在检查用户名...', 'success');

    // 检查用户名是否存在
    const usernameExists = await checkUsernameExists(name);
    if (usernameExists) {
        alert('用户名 "' + name + '" 已存在，请换一个名字');
        showMessage('', '');
        registerName.focus();
        registerName.select();
        return;
    }

    showMessage('正在获取IP地址...', 'success');
    
    // 获取用户IP
    const userIP = await getUserIP();
    console.log('用户IP:', userIP);
    
    // 检查IP是否已注册
    try {
        const ipRef = database.ref('ip_registrations/' + userIP);
        const ipSnap = await ipRef.once('value');
        
        if (ipSnap.exists()) {
            alert('该IP地址已注册过账号，每个IP只能注册一个账号！');
            showMessage('', '');
            return;
        }
    } catch (error) {
        console.error('检查IP失败:', error);
    }

    showMessage('正在创建账号...', 'success');

    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    const passwordHash = safeBtoa(password + '|' + Date.now()).split('').reverse().join('');

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: userIP
    };

    try {
        // 存储用户信息
        await database.ref('users/' + userId).set({
            name: name,
            passwordHash: passwordHash,
            createdAt: new Date().toISOString(),
            userIP: userIP,
            lastLogin: new Date().toISOString()
        });
        
        // 记录IP注册信息
        await database.ref('ip_registrations/' + userIP).set({
            userId: userId,
            registeredAt: new Date().toISOString(),
            userName: name
        });

        localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

        showMessage('🎉 注册成功，正在跳转...', 'success');
        setTimeout(() => location.href = 'main.html', 1200);
        
    } catch (error) {
        console.error('注册失败:', error);
        alert('注册失败: ' + error.message);
        showMessage('', '');
    }
}

/* ========= 登录 ========= */
async function loginUser() {
    const name = loginName.value.trim();
    const password = loginPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    showMessage('正在登录...', 'success');

    // 查询所有用户，找到匹配的用户名
    let userId = null;
    let userData = null;
    
    try {
        const usersRef = database.ref('users');
        const snapshot = await usersRef.once('value');
        
        if (!snapshot.exists()) {
            alert('用户不存在');
            return;
        }
        
        const users = snapshot.val();
        let found = false;
        
        for (let id in users) {
            if (users[id].name === name) {
                userId = id;
                userData = users[id];
                found = true;
                break;
            }
        }
        
        if (!found) {
            alert('用户不存在');
            return;
        }
        
    } catch (error) {
        console.error('查询用户失败:', error);
        alert('登录失败: ' + error.message);
        return;
    }

    // 验证密码
    try {
        const decoded = safeAtob(userData.passwordHash.split('').reverse().join(''));
        if (!decoded || !decoded.startsWith(password)) {
            alert('密码错误');
            return;
        }
    } catch (error) {
        console.error('密码验证失败:', error);
        alert('密码验证失败');
        return;
    }

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: userData.userIP || 'unknown'
    };

    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    // 更新最后登录时间
    try {
        await database.ref('users/' + userId).update({
            lastLogin: new Date().toISOString()
        });
    } catch (error) {
        console.error('更新登录时间失败:', error);
    }

    showMessage('登录成功，跳转中...', 'success');
    setTimeout(() => location.href = 'main.html', 800);
}
</script>
</body>
</html>
