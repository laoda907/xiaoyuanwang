<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园网 - 登录</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
<div class="auth-container">
    <h1>🏫 校园网</h1>
    <p class="subtitle">连接每一个校园角落</p>

    <div class="form-container" id="loginForm">
        <h2>登录</h2>
        <input type="text" id="loginName" placeholder="你的名字" maxlength="8">
        <input type="password" id="loginPassword" placeholder="密码">
        <button onclick="loginUser()">进入校园</button>
        <p class="switch-text">还没有账号？ <a href="#" onclick="showRegister()">点此注册</a></p>
    </div>

    <div class="form-container" id="registerForm" style="display:none;">
        <h2>注册新账号</h2>
        <input type="text" id="registerName" placeholder="取个名字（最多8字）" maxlength="8">
        <input type="password" id="registerPassword" placeholder="设置密码">
        <button onclick="registerUser()">注册</button>
        <p class="switch-text">已有账号？ <a href="#" onclick="showLogin()">点此登录</a></p>
    </div>

    <div id="message" class="message"></div>
</div>

<script>
/* ========= 中文安全 Base64（核心修复）========= */
function safeBtoa(str) {
    return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (_, p1) {
            return String.fromCharCode('0x' + p1);
        })
    );
}

/* ========= Firebase 配置 ========= */
const firebaseConfig = {
    apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
    authDomain: "laoda907-22511.firebaseapp.com",
    databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "laoda907-22511",
    storageBucket: "laoda907-22511.firebasestorage.app",
    messagingSenderId: "176173610464",
    appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

let database;
firebase.initializeApp(firebaseConfig);
database = firebase.database();

/* ========= 工具函数 ========= */
function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
}
function showRegister() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    showMessage('', '');
}
function showLogin() {
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    showMessage('', '');
}

/* ========= 注册 ========= */
async function registerUser() {
    const name = registerName.value.trim();
    const password = registerPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    showMessage('正在注册...', 'success');

    const encodedName = encodeURIComponent(name);
    const nameSnap = await database.ref('usernames/' + encodedName).once('value');
    if (nameSnap.exists()) {
        alert('用户名已存在');
        return;
    }

    const userId = 'user_' + Date.now();

    const passwordHash = safeBtoa(password + '|' + Date.now()).split('').reverse().join('');

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
    };

    await database.ref('users/' + userId).set({
        name,
        passwordHash,
        createdAt: new Date().toISOString()
    });
    await database.ref('usernames/' + encodedName).set(userId);

    /* 🔥 关键修复点：不用 btoa，用 safeBtoa */
    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    showMessage('🎉 注册成功，正在跳转...', 'success');
    setTimeout(() => location.href = 'main.html', 1200);
}

/* ========= 登录 ========= */
async function loginUser() {
    const name = loginName.value.trim();
    const password = loginPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    const encodedName = encodeURIComponent(name);
    const idSnap = await database.ref('usernames/' + encodedName).once('value');
    if (!idSnap.exists()) {
        alert('用户不存在');
        return;
    }

    const userId = idSnap.val();
    const userSnap = await database.ref('users/' + userId).once('value');
    const user = userSnap.val();

    const decoded = atob(user.passwordHash.split('').reverse().join(''));
    if (!decoded.startsWith(password)) {
        alert('密码错误');
        return;
    }

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
    };

    /* 🔥 同样修复 */
    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    showMessage('登录成功，跳转中...', 'success');
    setTimeout(() => location.href = 'main.html', 800);
}
</script>
</body>
</html>
