<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- å¼•å…¥ Firebase å…¼å®¹ç‰ˆ SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="login()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="register()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== Firebase é…ç½®ï¼ˆå·²å¡«å…¥ä½ çš„é¡¹ç›®ä¿¡æ¯ï¼‰==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };
        // ========== é…ç½®ç»“æŸ ==========

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('message').textContent = '';
        }
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('message').textContent = '';
        }

        // æ³¨å†Œå‡½æ•°
        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (name.length < 1 || name.length > 8) {
                showMessage('åå­—é•¿åº¦éœ€ä¸º1-8ä¸ªå­—ï¼', 'error');
                return;
            }
            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½ï¼', 'error');
                return;
            }

            // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            const nameSnapshot = await database.ref('usernames').child(name).once('value');
            if (nameSnapshot.exists()) {
                showMessage('è¿™ä¸ªåå­—å·²ç»è¢«ä½¿ç”¨äº†ï¼Œè¯·æ¢ä¸€ä¸ªå§ï¼', 'error');
                return;
            }

            // 2. ç”¨â€œåå­—@xiaoyuanwang.comâ€æ¨¡æ‹Ÿé‚®ç®±è¿›è¡Œæ³¨å†Œ
            const email = name + '@xiaoyuanwang.com';
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 3. åœ¨æ•°æ®åº“è®°å½•æ­¤ç”¨æˆ·åå·²è¢«å ç”¨
                await database.ref('usernames').child(name).set(user.uid);
                // 4. å­˜å‚¨ç”¨æˆ·ä¸ªäººä¿¡æ¯
                await database.ref('users').child(user.uid).set({
                    name: name,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });

                showMessage('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ä¸ºä½ ç™»å½•...', 'success');
                setTimeout(() => { window.location.href = 'main.html'; }, 1500);
            } catch (error) {
                showMessage('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç™»å½•å‡½æ•°
        async function login() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;

            const email = name + '@xiaoyuanwang.com'; // åŒæ ·è§„åˆ™æ„é€ é‚®ç®±
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è¿›å…¥...', 'success');
                setTimeout(() => { window.location.href = 'main.html'; }, 1000);
            } catch (error) {
                showMessage('ç™»å½•å¤±è´¥: åå­—æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼Œè‹¥å·²ç™»å½•åˆ™è·³è½¬
        auth.onAuthStateChanged(user => {
            if (user) {
                window.location.href = 'main.html';
            }
        });
    </script>
</body>
</html>
