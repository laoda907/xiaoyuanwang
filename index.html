<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
<div class="auth-container">
    <h1>ğŸ« æ ¡å›­ç½‘</h1>
    <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

    <div class="form-container" id="loginForm">
        <h2>ç™»å½•</h2>
        <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
        <input type="password" id="loginPassword" placeholder="å¯†ç ">
        <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
        <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
    </div>

    <div class="form-container" id="registerForm" style="display:none;">
        <h2>æ³¨å†Œæ–°è´¦å·</h2>
        <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
        <input type="password" id="registerPassword" placeholder="å¯†ç (6-10ä½ï¼Œå­—æ¯å’Œæ•°å­—ç»„åˆ)">
        <button onclick="registerUser()">æ³¨å†Œ</button>
        <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">å¯†ç è¦æ±‚ï¼š6-10ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—</p>
    </div>

    <div id="message" class="message"></div>
</div>

<script>
/* ========= å®‰å…¨Base64å‡½æ•°ï¼ˆä¿®å¤ä¸­æ–‡ï¼‰========= */
function safeBtoa(str) {
    return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (_, p1) {
            return String.fromCharCode('0x' + p1);
        })
    );
}

function safeAtob(str) {
    try {
        return decodeURIComponent(
            atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
        );
    } catch (e) {
        console.error('è§£ç å¤±è´¥:', e);
        return null;
    }
}

/* ========= å®‰å…¨IPç¼–ç ï¼ˆä¿®å¤Firebaseè·¯å¾„é—®é¢˜ï¼‰========= */
function encodeIPForFirebase(ip) {
    // å°†IPä¸­çš„ç‚¹æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œç¡®ä¿Firebaseè·¯å¾„å®‰å…¨
    return ip.replace(/\./g, "_");
}

/* ========= å¯†ç éªŒè¯å‡½æ•° ========= */
function validatePassword(password) {
    // å¯†ç é•¿åº¦æ£€æŸ¥ï¼š6-10ä½
    if (password.length < 6 || password.length > 10) {
        return { valid: false, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6åˆ°10ä½ä¹‹é—´' };
    }
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«å­—æ¯å’Œæ•°å­—
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    
    if (!hasLetter || !hasNumber) {
        return { valid: false, message: 'å¯†ç å¿…é¡»åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—' };
    }
    
    // æ£€æŸ¥æ˜¯å¦åªåŒ…å«å­—æ¯å’Œæ•°å­—ï¼ˆå¯é€‰ï¼Œæ ¹æ®ä½ çš„è¦æ±‚ï¼‰
    const onlyLettersAndNumbers = /^[a-zA-Z0-9]+$/.test(password);
    if (!onlyLettersAndNumbers) {
        return { valid: false, message: 'å¯†ç åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—' };
    }
    
    return { valid: true, message: 'å¯†ç æ ¼å¼æ­£ç¡®' };
}

/* ========= Firebase é…ç½® ========= */
const firebaseConfig = {
    apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
    authDomain: "laoda907-22511.firebaseapp.com",
    databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "laoda907-22511",
    storageBucket: "laoda907-22511.firebasestorage.app",
    messagingSenderId: "176173610464",
    appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

let database;
firebase.initializeApp(firebaseConfig);
database = firebase.database();

/* ========= è·å–ç”¨æˆ·IP ========= */
async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('è·å–IPå¤±è´¥:', error);
        // å¤‡ç”¨æ–¹æ³•
        return 'unknown_ip_' + Math.random().toString(36).substr(2, 9);
    }
}

/* ========= å·¥å…·å‡½æ•° ========= */
function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
}
function showRegister() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    showMessage('', '');
}
function showLogin() {
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    showMessage('', '');
}

/* ========= æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ ========= */
async function checkIPRegistered(userIP) {
    try {
        const safeIP = encodeIPForFirebase(userIP);
        const ipRef = database.ref('ip_registrations/' + safeIP);
        const snapshot = await ipRef.once('value');
        return snapshot.exists();
    } catch (error) {
        console.error('æ£€æŸ¥IPå¤±è´¥:', error);
        return false;
    }
}

/* ========= æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ ========= */
async function checkUsernameExists(name) {
    try {
        // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„ç”¨æˆ·å
        const usersRef = database.ref('users');
        const snapshot = await usersRef.once('value');
        
        if (!snapshot.exists()) {
            return false;
        }
        
        const users = snapshot.val();
        for (let userId in users) {
            if (users[userId].name === name) {
                return true;
            }
        }
        return false;
    } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
        return false;
    }
}

/* ========= æ³¨å†Œ ========= */
async function registerUser() {
    const name = registerName.value.trim();
    const password = registerPassword.value;

    if (!name || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    if (name.length > 8) {
        alert('ç”¨æˆ·åä¸èƒ½è¶…è¿‡8ä¸ªå­—ç¬¦');
        return;
    }

    // éªŒè¯å¯†ç æ ¼å¼
    const passwordValidation = validatePassword(password);
    if (!passwordValidation.valid) {
        alert('å¯†ç é”™è¯¯ï¼š' + passwordValidation.message);
        registerPassword.focus();
        registerPassword.select();
        return;
    }

    showMessage('æ­£åœ¨æ£€æŸ¥ç”¨æˆ·å...', 'success');

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    const usernameExists = await checkUsernameExists(name);
    if (usernameExists) {
        alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ªåå­—');
        showMessage('', '');
        return;
    }

    // è·å–ç”¨æˆ·IP
    showMessage('æ­£åœ¨æ£€æŸ¥IP...', 'success');
    const userIP = await getUserIP();
    console.log('ç”¨æˆ·IP:', userIP);
    
    // æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
    const isIPRegistered = await checkIPRegistered(userIP);
    if (isIPRegistered) {
        alert('è¯¥IPåœ°å€å·²æ³¨å†Œè¿‡è´¦å·ï¼Œæ¯ä¸ªIPåªèƒ½æ³¨å†Œä¸€ä¸ªè´¦å·ï¼');
        showMessage('', '');
        return;
    }

    showMessage('æ­£åœ¨åˆ›å»ºè´¦å·...', 'success');

    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    const passwordHash = safeBtoa(password + '|' + Date.now()).split('').reverse().join('');

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: userIP
    };

    try {
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        await database.ref('users/' + userId).set({
            name,
            passwordHash,
            createdAt: new Date().toISOString(),
            userIP: userIP,
            lastLogin: new Date().toISOString()
        });
        
        // è®°å½•IPæ³¨å†Œä¿¡æ¯ï¼ˆä½¿ç”¨å®‰å…¨ç¼–ç çš„IPï¼‰
        const safeIP = encodeIPForFirebase(userIP);
        await database.ref('ip_registrations/' + safeIP).set({
            userId: userId,
            registeredAt: new Date().toISOString(),
            userName: name,
            originalIP: userIP  // ä¿å­˜åŸå§‹IPä»¥ä¾¿æŸ¥çœ‹
        });

        localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

        showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
        setTimeout(() => location.href = 'main.html', 1200);
        
    } catch (error) {
        console.error('æ³¨å†Œå¤±è´¥:', error);
        alert('æ³¨å†Œå¤±è´¥: ' + error.message);
        showMessage('', '');
    }
}

/* ========= ç™»å½• ========= */
async function loginUser() {
    const name = loginName.value.trim();
    const password = loginPassword.value;

    if (!name || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    showMessage('æ­£åœ¨ç™»å½•...', 'success');

    // é€šè¿‡æŸ¥è¯¢æ‰¾åˆ°ç”¨æˆ·ID
    let userId = null;
    let userData = null;
    
    const usersRef = database.ref('users');
    const snapshot = await usersRef.once('value');
    
    if (snapshot.exists()) {
        const users = snapshot.val();
        for (let id in users) {
            if (users[id].name === name) {
                userId = id;
                userData = users[id];
                break;
            }
        }
    }
    
    if (!userId) {
        alert('ç”¨æˆ·ä¸å­˜åœ¨');
        return;
    }

    // éªŒè¯å¯†ç 
    const decoded = safeAtob(userData.passwordHash.split('').reverse().join(''));
    if (!decoded || !decoded.startsWith(password)) {
        alert('å¯†ç é”™è¯¯');
        return;
    }

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: userData.userIP || 'unknown'
    };

    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    try {
        await database.ref('users/' + userId).update({
            lastLogin: new Date().toISOString()
        });
    } catch (error) {
        console.error('æ›´æ–°ç™»å½•æ—¶é—´å¤±è´¥:', error);
    }

    showMessage('ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸­...', 'success');
    setTimeout(() => location.href = 'main.html', 800);
}
</script>
</body>
</html>
