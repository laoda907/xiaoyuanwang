<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- ä½¿ç”¨ç¨³å®šç‰ˆ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="login()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="register()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // å…¨å±€é”™è¯¯æ•è·ï¼Œç¡®ä¿èƒ½çœ‹åˆ°ä»»ä½•åˆå§‹åŒ–é”™è¯¯
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
            const msgDiv = document.getElementById('message');
            if (msgDiv && event.error) {
                msgDiv.textContent = 'åŠ è½½é”™è¯¯: ' + (event.error.message || 'æœªçŸ¥é”™è¯¯');
                msgDiv.className = 'message error';
            }
        });

        // ========== Firebase é…ç½®ï¼ˆå·²å¡«å…¥ä½ çš„é¡¹ç›®ä¿¡æ¯ï¼‰==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };
        // ========== é…ç½®ç»“æŸ ==========

        // åˆå§‹åŒ– Firebase
        let auth, database;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
            showMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ¸…é™¤æç¤ºä¿¡æ¯
        function clearMessage() {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = '';
            msgDiv.className = 'message';
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
            console.log('æ¶ˆæ¯:', type, text);
        }

        // æ³¨å†Œå‡½æ•°
        async function register() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'æ³¨å†Œä¸­...';

            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;

            // æ¸…ç©ºä¹‹å‰çš„ä¿¡æ¯
            clearMessage();

            // å‰ç«¯éªŒè¯
            if (name.length < 1 || name.length > 8) {
                showMessage('åå­—é•¿åº¦éœ€ä¸º1-8ä¸ªå­—ï¼', 'error');
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
                return;
            }
            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½ï¼', 'error');
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
                return;
            }

            try {
                // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                showMessage('æ­£åœ¨æ£€æŸ¥ç”¨æˆ·å...', '');
                const nameSnapshot = await database.ref('usernames').child(name).once('value');
                if (nameSnapshot.exists()) {
                    showMessage('è¿™ä¸ªåå­—å·²ç»è¢«ä½¿ç”¨äº†ï¼Œè¯·æ¢ä¸€ä¸ªå§ï¼', 'error');
                    btn.disabled = false;
                    btn.textContent = 'æ³¨å†Œ';
                    return;
                }

                // 2. åˆ›å»ºç”¨æˆ·ï¼ˆç”¨â€œåå­—@xiaoyuanwang.comâ€æ¨¡æ‹Ÿé‚®ç®±ï¼‰
                showMessage('æ­£åœ¨åˆ›å»ºè´¦å·...', '');
                const email = name + '@xiaoyuanwang.com';
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // 3. ä¿å­˜ç”¨æˆ·åå’Œç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
                showMessage('æ­£åœ¨ä¿å­˜ä¿¡æ¯...', '');
                await database.ref('usernames').child(name).set(user.uid);
                await database.ref('users').child(user.uid).set({
                    name: name,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });

                // 4. æ³¨å†ŒæˆåŠŸ
                showMessage('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ä¸ºä½ ç™»å½•...', 'success');
                console.log('ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:', user.uid, name);
                
                // 1.5ç§’åè·³è½¬åˆ°ä¸»é¡µé¢
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1500);
                
            } catch (error) {
                // è¯¦ç»†é”™è¯¯å¤„ç†
                console.error('æ³¨å†Œè¯¦ç»†é”™è¯¯:', error.code, error.message, error);
                
                let errorMsg = 'æ³¨å†Œå¤±è´¥: ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œï¼';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'ç”¨æˆ·åæ ¼å¼æ— æ•ˆ';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ';
                } else {
                    errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                }
                
                showMessage(errorMsg, 'error');
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
            }
        }

        // ç™»å½•å‡½æ•°
        async function login() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';

            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;

            clearMessage();

            if (!name || !password) {
                showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
                btn.disabled = false;
                btn.textContent = 'è¿›å…¥æ ¡å›­';
                return;
            }

            const email = name + '@xiaoyuanwang.com';
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è¿›å…¥...', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showMessage('ç™»å½•å¤±è´¥: åå­—æˆ–å¯†ç é”™è¯¯', 'error');
                btn.disabled = false;
                btn.textContent = 'è¿›å…¥æ ¡å›­';
            }
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼Œè‹¥å·²ç™»å½•åˆ™è‡ªåŠ¨è·³è½¬
        if (auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨è·³è½¬:', user.uid);
                    window.location.href = 'main.html';
                }
            });
        }
    </script>
</body>
</html>
