<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- ä½¿ç”¨æ›´ç¨³å®šçš„ Firebase 7.24.0 ç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="registerUser()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== é…ç½®æ–‡ä»¶ï¼ˆä½ çš„ Firebase é…ç½®ï¼‰==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };
        // ========== é…ç½®ç»“æŸ ==========

        // åˆå§‹åŒ– Firebase
        let auth, database;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
            console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            showMessage("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ˜¾ç¤º/æ¸…é™¤æ¶ˆæ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        function clearMessage() {
            showMessage('', '');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        async function registerUser() {
            const btn = document.querySelector('#registerForm button');
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;

            // 1. åŸºç¡€éªŒè¯
            if (!name || name.length > 8) {
                showMessage('åå­—ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡8ä¸ªå­—', 'error');
                return;
            }
            if (!password || password.length < 6) {
                showMessage('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error');
                return;
            }

            // 2. é”å®šæŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            btn.disabled = true;
            btn.textContent = 'æ£€æŸ¥ç”¨æˆ·å...';
            clearMessage();

            try {
                // 3. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤ï¼ˆç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰
                btn.textContent = 'æ£€æŸ¥ä¸­...';
                const nameRef = database.ref('usernames/' + name);
                const snapshot = await nameRef.once('value');
                
                if (snapshot.exists()) {
                    showMessage('è¯¥åå­—å·²è¢«ä½¿ç”¨ï¼Œè¯·æ¢ä¸€ä¸ª', 'error');
                    btn.disabled = false;
                    btn.textContent = 'æ³¨å†Œ';
                    return;
                }

                // 4. åˆ›å»ºç”¨æˆ·è´¦å·ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿé‚®ç®±ï¼‰
                btn.textContent = 'åˆ›å»ºè´¦å·...';
                const email = name + '@xiaoyuan.site'; // ç®€åŒ–çš„é‚®ç®±æ ¼å¼
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;
                
                // 5. ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æ•°æ®åº“
                btn.textContent = 'ä¿å­˜ä¿¡æ¯...';
                const userData = {
                    name: name,
                    createdAt: new Date().toISOString()
                };
                
                // åŒæ—¶ä¿å­˜åˆ°ä¸¤ä¸ªåœ°æ–¹
                await Promise.all([
                    nameRef.set(userId), // è®°å½•ç”¨æˆ·åå·²è¢«å ç”¨
                    database.ref('users/' + userId).set(userData) // ä¿å­˜ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                ]);

                // 6. æ³¨å†ŒæˆåŠŸ
                showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                btn.textContent = 'æ³¨å†ŒæˆåŠŸï¼';
                
                // 3ç§’åè·³è½¬åˆ°ä¸»é¡µé¢
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 2000);

            } catch (error) {
                // 7. é”™è¯¯å¤„ç†
                console.error('æ³¨å†Œé”™è¯¯è¯¦æƒ…:', error);
                btn.disabled = false;
                btn.textContent = 'æ³¨å†Œ';
                
                let errorMsg = 'æ³¨å†Œå¤±è´¥: ';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMsg = 'è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œ';
                        break;
                    case 'auth/network-request-failed':
                        errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMsg = 'æš‚æœªå¼€æ”¾æ³¨å†Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        break;
                    case 'permission_denied':
                        errorMsg = 'æ•°æ®åº“æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                        break;
                    default:
                        errorMsg += error.message || 'æœªçŸ¥é”™è¯¯';
                }
                showMessage(errorMsg, 'error');
            }
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function loginUser() {
            const btn = document.querySelector('#loginForm button');
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!name || !password) {
                showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            clearMessage();

            try {
                const email = name + '@xiaoyuan.site';
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('ç™»å½•æˆåŠŸï¼æ­£åœ¨è¿›å…¥...', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                btn.disabled = false;
                btn.textContent = 'è¿›å…¥æ ¡å›­';
                showMessage('ç™»å½•å¤±è´¥ï¼šåå­—æˆ–å¯†ç é”™è¯¯', 'error');
            }
        }

        // è‡ªåŠ¨è·³è½¬ï¼šå¦‚æœå·²ç»ç™»å½•ï¼Œç›´æ¥å»ä¸»é¡µé¢
        if (auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    console.log('ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨è·³è½¬:', user.uid);
                    window.location.href = 'main.html';
                }
            });
        }
    </script>
</body>
</html>
