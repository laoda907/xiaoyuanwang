<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园网 - 登录</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
<div class="auth-container">
    <h1>🏫 校园网</h1>
    <p class="subtitle">连接每一个校园角落</p>

    <div class="form-container" id="loginForm">
        <h2>登录</h2>
        <input type="text" id="loginName" placeholder="你的名字" maxlength="8">
        <input type="password" id="loginPassword" placeholder="密码">
        <button onclick="loginUser()">进入校园</button>
        <p class="switch-text">还没有账号？ <a href="#" onclick="showRegister()">点此注册</a></p>
    </div>

    <div class="form-container" id="registerForm" style="display:none;">
        <h2>注册新账号</h2>
        <input type="text" id="registerName" placeholder="取个名字（最多8字）" maxlength="8">
        <input type="password" id="registerPassword" placeholder="设置密码">
        <button onclick="registerUser()">注册</button>
        <p class="switch-text">已有账号？ <a href="#" onclick="showLogin()">点此登录</a></p>
    </div>

    <div id="message" class="message"></div>
</div>

<script>
/* ========= 安全Base64函数（修复中文）========= */
function safeBtoa(str) {
    return btoa(
        encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (_, p1) {
            return String.fromCharCode('0x' + p1);
        })
    );
}

function safeAtob(str) {
    try {
        return decodeURIComponent(
            atob(str).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
        );
    } catch (e) {
        console.error('解码失败:', e);
        return null;
    }
}

/* ========= 用户名安全编码（修复检查问题）========= */
function encodeUsername(name) {
    // 创建一个安全的用户名编码，避免Firebase路径问题
    return 'name_' + btoa(encodeURIComponent(name)).replace(/[+/=]/g, '_');
}

/* ========= Firebase 配置 ========= */
const firebaseConfig = {
    apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
    authDomain: "laoda907-22511.firebaseapp.com",
    databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "laoda907-22511",
    storageBucket: "laoda907-22511.firebasestorage.app",
    messagingSenderId: "176173610464",
    appId: "1:176173610464:web:3ff86202f9b05f24b36785"
};

let database;
firebase.initializeApp(firebaseConfig);
database = firebase.database();

/* ========= 获取用户IP ========= */
async function getUserIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        console.error('获取IP失败:', error);
        // 备用方法
        return 'unknown_' + Math.random().toString(36).substr(2, 9);
    }
}

/* ========= 工具函数 ========= */
function showMessage(text, type) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + type;
}
function showRegister() {
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
    showMessage('', '');
}
function showLogin() {
    registerForm.style.display = 'none';
    loginForm.style.display = 'block';
    showMessage('', '');
}

/* ========= 检查IP是否已注册 ========= */
async function checkIPRegistered(userIP) {
    try {
        const ipRef = database.ref('ip_registrations/' + userIP);
        const snapshot = await ipRef.once('value');
        return snapshot.exists();
    } catch (error) {
        console.error('检查IP失败:', error);
        return false;
    }
}

/* ========= 检查用户名是否存在 ========= */
async function checkUsernameExists(name) {
    try {
        // 查询所有用户，检查是否有相同的用户名
        const usersRef = database.ref('users');
        const snapshot = await usersRef.once('value');
        
        if (snapshot.exists()) {
            const users = snapshot.val();
            for (let userId in users) {
                if (users[userId].name === name) {
                    return true;
                }
            }
        }
        return false;
    } catch (error) {
        console.error('检查用户名失败:', error);
        return true; // 出错时认为用户名存在，避免重复注册
    }
}

/* ========= 注册 ========= */
async function registerUser() {
    const name = registerName.value.trim();
    const password = registerPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    if (name.length > 8) {
        alert('用户名不能超过8个字符');
        return;
    }

    showMessage('正在注册...', 'success');

    // 获取用户IP
    const userIP = await getUserIP();
    console.log('用户IP:', userIP);
    
    // 检查IP是否已注册
    const isIPRegistered = await checkIPRegistered(userIP);
    if (isIPRegistered) {
        alert('该IP地址已注册过账号，每个IP只能注册一个账号！');
        showMessage('', '');
        return;
    }

    // 检查用户名是否存在
    const usernameExists = await checkUsernameExists(name);
    if (usernameExists) {
        alert('用户名已存在，请换一个名字');
        showMessage('', '');
        return;
    }

    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    const passwordHash = safeBtoa(password + '|' + Date.now()).split('').reverse().join('');

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: userIP
    };

    // 存储用户信息
    await database.ref('users/' + userId).set({
        name,
        passwordHash,
        createdAt: new Date().toISOString(),
        userIP: userIP,
        lastLogin: new Date().toISOString()
    });
    
    // 存储用户名到用户ID的映射（使用安全编码）
    const encodedName = encodeUsername(name);
    await database.ref('usernames/' + encodedName).set(userId);
    
    // 记录IP注册信息
    await database.ref('ip_registrations/' + userIP).set({
        userId: userId,
        registeredAt: new Date().toISOString(),
        userName: name
    });

    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    showMessage('🎉 注册成功，正在跳转...', 'success');
    setTimeout(() => location.href = 'main.html', 1200);
}

/* ========= 登录 ========= */
async function loginUser() {
    const name = loginName.value.trim();
    const password = loginPassword.value;

    if (!name || !password) {
        alert('请输入用户名和密码');
        return;
    }

    // 通过查询找到用户ID
    let userId = null;
    const usersRef = database.ref('users');
    const snapshot = await usersRef.once('value');
    
    if (snapshot.exists()) {
        const users = snapshot.val();
        for (let id in users) {
            if (users[id].name === name) {
                userId = id;
                break;
            }
        }
    }
    
    if (!userId) {
        alert('用户不存在');
        return;
    }

    const userSnap = await database.ref('users/' + userId).once('value');
    const user = userSnap.val();

    const decoded = safeAtob(user.passwordHash.split('').reverse().join(''));
    if (!decoded || !decoded.startsWith(password)) {
        alert('密码错误');
        return;
    }

    const sessionData = {
        userId,
        userName: name,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
        userIP: user.userIP || 'unknown'
    };

    localStorage.setItem('xiaoyuan_session', safeBtoa(JSON.stringify(sessionData)));

    // 更新最后登录时间
    await database.ref('users/' + userId).update({
        lastLogin: new Date().toISOString()
    });

    showMessage('登录成功，跳转中...', 'success');
    setTimeout(() => location.href = 'main.html', 800);
}
</script>
</body>
</html>
