<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="auth-container">
    <h1>ğŸ« æ ¡å›­ç½‘</h1>
    <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

    <div class="form-container" id="loginForm">
        <h2>ç™»å½•</h2>
        <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
        <input type="password" id="loginPassword" placeholder="å¯†ç ">
        <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
        <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
    </div>

    <div class="form-container" id="registerForm" style="display:none;">
        <h2>æ³¨å†Œæ–°è´¦å·</h2>
        <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
        <input type="password" id="registerPassword" placeholder="å¯†ç (6-10ä½ï¼Œå­—æ¯å’Œæ•°å­—ç»„åˆ)">
        <button onclick="registerUser()">æ³¨å†Œ</button>
        <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">å¯†ç è¦æ±‚ï¼š6-10ä½ï¼Œå¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—</p>
    </div>

    <div id="message" class="message"></div>
</div>

<!-- æ·»åŠ  Supabase å®¢æˆ·ç«¯ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// å…¨å±€é”™è¯¯å¤„ç†
window.onerror = (msg, url, line) => {
    alert("JSé”™è¯¯ï¼š" + msg + "\nè¡Œï¼š" + line);
    return false;
};

// ç«‹å³æ‰§è¡Œçš„å‡½æ•°ï¼Œç¡®ä¿å˜é‡åœ¨æŒ‰é’®ç‚¹å‡»å‰å°±å¯ç”¨
(function() {
    /* ========= Supabase å®¢æˆ·ç«¯åˆå§‹åŒ– ========= */
    window.supabase = window.supabase || supabase.createClient(
        "https://akqrebzfodejodgrtzyc.supabase.co",
        "sb_publishable_sCIqqs5zvkGT8ITvQNxQOQ_p2e2j5to"
    );
    
    /* ========= UTF-8 å®‰å…¨çš„ Base64 ç¼–ç /è§£ç ï¼ˆç»Ÿä¸€ç‰ˆæœ¬ï¼‰========= */
    window.safeBtoa = function(str) {
        return btoa(
            encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (_, p1) {
                return String.fromCharCode('0x' + p1);
            })
        );
    };

    window.safeAtob = function(str) {
        try {
            return decodeURIComponent(
                atob(str).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')
            );
        } catch (e) {
            console.error('è§£ç å¤±è´¥:', e);
            return null;
        }
    };

    /* ========= å¯†ç éªŒè¯å‡½æ•° ========= */
    window.validatePassword = function(password) {
        // å¯†ç é•¿åº¦æ£€æŸ¥ï¼š6-10ä½
        if (password.length < 6 || password.length > 10) {
            return { valid: false, message: 'å¯†ç é•¿åº¦å¿…é¡»åœ¨6åˆ°10ä½ä¹‹é—´' };
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«å­—æ¯å’Œæ•°å­—
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        
        if (!hasLetter || !hasNumber) {
            return { valid: false, message: 'å¯†ç å¿…é¡»åŒæ—¶åŒ…å«å­—æ¯å’Œæ•°å­—' };
        }
        
        // æ£€æŸ¥æ˜¯å¦åªåŒ…å«å­—æ¯å’Œæ•°å­—ï¼ˆå¯é€‰ï¼Œæ ¹æ®ä½ çš„è¦æ±‚ï¼‰
        const onlyLettersAndNumbers = /^[a-zA-Z0-9]+$/.test(password);
        if (!onlyLettersAndNumbers) {
            return { valid: false, message: 'å¯†ç åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—' };
        }
        
        return { valid: true, message: 'å¯†ç æ ¼å¼æ­£ç¡®' };
    };

    /* ========= è·å–ç”¨æˆ·IP ========= */
    window.getUserIP = async function() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error('è·å–IPå¤±è´¥:', error);
            // å¤‡ç”¨æ–¹æ³•
            return 'unknown_ip_' + Math.random().toString(36).substr(2, 9);
        }
    };

    /* ========= å·¥å…·å‡½æ•° ========= */
    window.showMessage = function(text, type) {
        const msg = document.getElementById('message');
        if (msg) {
            msg.textContent = text;
            msg.className = 'message ' + type;
        }
    };
    
    window.showRegister = function() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        showMessage('', '');
    };
    
    window.showLogin = function() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        showMessage('', '');
    };

    /* ========= æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ ========= */
    window.checkUsernameExists = async function(username) {
        try {
            const { data, error } = await window.supabase
                .from('users')
                .select('id')
                .eq('username', username)
                .limit(1);
                
            if (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
                return false;
            }
            
            return data && data.length > 0;
        } catch (error) {
            console.error('æ£€æŸ¥ç”¨æˆ·åå¤±è´¥:', error);
            return false;
        }
    };

    /* ========= æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ ========= */
    window.checkIPRegistered = async function(ip) {
        try {
            const { data, error } = await window.supabase
                .from('ip_registrations')
                .select('id')
                .eq('ip', ip)
                .limit(1);
                
            if (error) {
                console.error('æ£€æŸ¥IPå¤±è´¥:', error);
                return false;
            }
            
            return data && data.length > 0;
        } catch (error) {
            console.error('æ£€æŸ¥IPå¤±è´¥:', error);
            return false;
        }
    };

    /* ========= æ³¨å†Œ ========= */
    window.registerUser = async function() {
        const name = document.getElementById('registerName').value.trim();
        const password = document.getElementById('registerPassword').value;

        if (!name || !password) {
            alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        if (name.length > 8) {
            alert('ç”¨æˆ·åä¸èƒ½è¶…è¿‡8ä¸ªå­—ç¬¦');
            return;
        }

        // éªŒè¯å¯†ç æ ¼å¼
        const passwordValidation = window.validatePassword(password);
        if (!passwordValidation.valid) {
            alert('å¯†ç é”™è¯¯ï¼š' + passwordValidation.message);
            document.getElementById('registerPassword').focus();
            document.getElementById('registerPassword').select();
            return;
        }

        showMessage('æ­£åœ¨æ£€æŸ¥ç”¨æˆ·å...', 'success');

        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
        const usernameExists = await window.checkUsernameExists(name);
        if (usernameExists) {
            alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ªåå­—');
            showMessage('', '');
            return;
        }

        // è·å–ç”¨æˆ·IP
        showMessage('æ­£åœ¨æ£€æŸ¥IP...', 'success');
        const userIP = await window.getUserIP();
        console.log('ç”¨æˆ·IP:', userIP);
        
        // æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
        const isIPRegistered = await window.checkIPRegistered(userIP);
        if (isIPRegistered) {
            alert('è¯¥IPåœ°å€å·²æ³¨å†Œè¿‡è´¦å·ï¼Œæ¯ä¸ªIPåªèƒ½æ³¨å†Œä¸€ä¸ªè´¦å·ï¼');
            showMessage('', '');
            return;
        }

        showMessage('æ­£åœ¨åˆ›å»ºè´¦å·...', 'success');

        // ç”Ÿæˆç”¨æˆ·ID
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // åŠ å¯†å¯†ç ï¼ˆä¿æŒä¸åŸæœ‰é€»è¾‘ä¸€è‡´ï¼‰
        const passwordHash = window.safeBtoa(password + '|' + Date.now()).split('').reverse().join('');

        try {
            // å†™å…¥ç”¨æˆ·æ•°æ®åˆ° users è¡¨
            const { error: userError } = await window.supabase
                .from('users')
                .insert({
                    id: userId,
                    username: name,
                    password_hash: passwordHash,
                    ip: userIP,
                    created_at: new Date().toISOString(),
                    last_login: new Date().toISOString()
                });
                
            if (userError) {
                throw new Error('ç”¨æˆ·æ³¨å†Œå¤±è´¥: ' + userError.message);
            }
            
            // å†™å…¥IPæ³¨å†Œè®°å½•åˆ° ip_registrations è¡¨
            const { error: ipError } = await window.supabase
                .from('ip_registrations')
                .insert({
                    ip: userIP,
                    username: name,
                    created_at: new Date().toISOString()
                });
                
            if (ipError) {
                console.error('IPè®°å½•å¤±è´¥:', ipError);
                // ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸­æ–­æ³¨å†Œæµç¨‹
            }

            // åˆ›å»ºæœ¬åœ°session
            const sessionData = {
                userId,
                userName: name,
                expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
                userIP: userIP
            };

            localStorage.setItem('xiaoyuan_session', window.safeBtoa(JSON.stringify(sessionData)));

            showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
            setTimeout(() => location.href = 'main.html', 1200);
            
        } catch (error) {
            console.error('æ³¨å†Œå¤±è´¥:', error);
            alert('æ³¨å†Œå¤±è´¥: ' + error.message);
            showMessage('', '');
        }
    };

    /* ========= ç™»å½• ========= */
    window.loginUser = async function() {
        const name = document.getElementById('loginName').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!name || !password) {
            alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            return;
        }

        showMessage('æ­£åœ¨ç™»å½•...', 'success');

        try {
            // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
            const { data, error } = await window.supabase
                .from('users')
                .select('*')
                .eq('username', name)
                .limit(1);
                
            if (error) {
                throw new Error('æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ' + error.message);
            }
            
            if (!data || data.length === 0) {
                alert('ç”¨æˆ·ä¸å­˜åœ¨');
                return;
            }
            
            const userData = data[0];
            
            // éªŒè¯å¯†ç ï¼ˆä¿æŒåŸæœ‰åŠ å¯†æ–¹å¼ï¼‰
            const decoded = window.safeAtob(userData.password_hash.split('').reverse().join(''));
            if (!decoded || !decoded.startsWith(password)) {
                alert('å¯†ç é”™è¯¯');
                return;
            }

            // åˆ›å»ºæœ¬åœ°session
            const sessionData = {
                userId: userData.id,
                userName: name,
                expiry: Date.now() + 7 * 24 * 60 * 60 * 1000,
                userIP: userData.ip || 'unknown'
            };

            localStorage.setItem('xiaoyuan_session', window.safeBtoa(JSON.stringify(sessionData)));

            // æ›´æ–°æœ€åç™»å½•æ—¶é—´
            try {
                await window.supabase
                    .from('users')
                    .update({ last_login: new Date().toISOString() })
                    .eq('id', userData.id);
            } catch (updateError) {
                console.error('æ›´æ–°ç™»å½•æ—¶é—´å¤±è´¥:', updateError);
                // ä¸ä¸­æ–­ç™»å½•æµç¨‹
            }

            showMessage('ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸­...', 'success');
            setTimeout(() => location.href = 'main.html', 800);
            
        } catch (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            alert('ç™»å½•å¤±è´¥: ' + error.message);
            showMessage('', '');
        }
    };
})();
</script>
</body>
</html>
