// ========== æ³¨å†ŒåŠŸèƒ½ ==========
async function registerUser() {
    const name = document.getElementById('registerName').value.trim();
    const password = document.getElementById('registerPassword').value;
    
    // éªŒè¯
    if (!name || name.length > 8) {
        showMessage('åå­—ä¸èƒ½ä¸ºç©ºä¸”ä¸è¶…è¿‡8ä¸ªå­—', 'error');
        return;
    }
    if (!password || password.length < 6) {
        showMessage('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error');
        return;
    }
    
    // æ£€æŸ¥ç”¨æˆ·å
    const snapshot = await database.ref('usernames/' + name).once('value');
    if (snapshot.exists()) {
        showMessage('åå­—å·²è¢«ä½¿ç”¨', 'error');
        return;
    }
    
    // ç”Ÿæˆç”¨æˆ·ID
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // ğŸ” åŠ å¯†å¯†ç 
    const passwordHash = btoa(password + '|' + Date.now()).split('').reverse().join('');
    
    // ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
    const sessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    await database.ref('users/' + userId).set({
        name: name,
        passwordHash: passwordHash,
        sessionToken: sessionToken,
        createdAt: new Date().toISOString(),
        lastLogin: new Date().toISOString()
    });
    
    // è®°å½•ç”¨æˆ·å
    await database.ref('usernames/' + name).set(userId);
    
    // ğŸ”’ å®‰å…¨ä¿å­˜ä¼šè¯
    const sessionData = {
        userId: userId,
        userName: name,
        token: sessionToken,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
    };
    localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
    
    showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
    setTimeout(() => {
        window.location.href = 'main.html';
    }, 1500);
}

// ========== ç™»å½•åŠŸèƒ½ ==========
async function loginUser() {
    const name = document.getElementById('loginName').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!name || !password) {
        showMessage('è¯·è¾“å…¥åå­—å’Œå¯†ç ', 'error');
        return;
    }
    
    // æ‰¾ç”¨æˆ·ID
    const idSnapshot = await database.ref('usernames/' + name).once('value');
    if (!idSnapshot.exists()) {
        showMessage('ç”¨æˆ·ä¸å­˜åœ¨', 'error');
        return;
    }
    
    const userId = idSnapshot.val();
    
    // è·å–ç”¨æˆ·æ•°æ®
    const userSnapshot = await database.ref('users/' + userId).once('value');
    const userData = userSnapshot.val();
    
    if (!userData) {
        showMessage('ç”¨æˆ·æ•°æ®é”™è¯¯', 'error');
        return;
    }
    
    // ğŸ” éªŒè¯å¯†ç 
    try {
        const reversedHash = userData.passwordHash.split('').reverse().join('');
        const decoded = atob(reversedHash);
        const parts = decoded.split('|');
        if (parts[0] !== password) {
            throw new Error('å¯†ç ä¸åŒ¹é…');
        }
    } catch {
        showMessage('å¯†ç é”™è¯¯', 'error');
        return;
    }
    
    // ğŸ”‘ ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ
    const newSessionToken = btoa(userId + '|' + Date.now() + '|' + Math.random().toString(36));
    
    // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»¤ç‰Œ
    await database.ref('users/' + userId).update({
        sessionToken: newSessionToken,
        lastLogin: new Date().toISOString()
    });
    
    // ğŸ”’ ä¿å­˜å®‰å…¨ä¼šè¯
    const sessionData = {
        userId: userId,
        userName: name,
        token: newSessionToken,
        expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
    };
    localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
    
    showMessage('âœ… ç™»å½•æˆåŠŸï¼', 'success');
    setTimeout(() => {
        window.location.href = 'main.html';
    }, 1000);
}

// ========== è‡ªåŠ¨è·³è½¬ï¼šå¦‚æœå·²ç»ç™»å½• ==========
if (auth) {
    auth.onAuthStateChanged(user => {
        // æˆ‘ä»¬ä¸ä½¿ç”¨Firebase Authäº†ï¼Œä½†ä¿ç•™è¿™ä¸ªä»¥é˜²ä¸‡ä¸€
    });
}
