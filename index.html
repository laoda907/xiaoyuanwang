<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - ç™»å½•</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
</head>
<body>
    <div class="auth-container">
        <h1>ğŸ« æ ¡å›­ç½‘</h1>
        <p class="subtitle">è¿æ¥æ¯ä¸€ä¸ªæ ¡å›­è§’è½</p>

        <div class="form-container" id="loginForm">
            <h2>ç™»å½•</h2>
            <input type="text" id="loginName" placeholder="ä½ çš„åå­—" maxlength="8">
            <input type="password" id="loginPassword" placeholder="å¯†ç ">
            <button onclick="loginUser()">è¿›å…¥æ ¡å›­</button>
            <p class="switch-text">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showRegister()">ç‚¹æ­¤æ³¨å†Œ</a></p>
        </div>

        <div class="form-container" id="registerForm" style="display:none;">
            <h2>æ³¨å†Œæ–°è´¦å·</h2>
            <input type="text" id="registerName" placeholder="å–ä¸ªåå­—ï¼ˆæœ€å¤š8å­—ï¼‰" maxlength="8">
            <input type="password" id="registerPassword" placeholder="è®¾ç½®å¯†ç ">
            <button onclick="registerUser()">æ³¨å†Œ</button>
            <p class="switch-text">å·²æœ‰è´¦å·ï¼Ÿ <a href="#" onclick="showLogin()">ç‚¹æ­¤ç™»å½•</a></p>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // ========== Firebase é…ç½® ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };

        // åˆå§‹åŒ– Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            showMessage("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•", "error");
        }

        // è·å–ç”¨æˆ·IPåœ°å€
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.log('è·å–IPå¤±è´¥ï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ');
                return 'local_ip_' + Date.now();
            }
        }

        // IPç¼–ç æ–¹æ¡ˆ
        function encodeIPForFirebase(ip) {
            const parts = ip.split('.');
            if (parts.length === 4) {
                return 'ip_' + parts.join('_');
            } else {
                return 'ip_' + ip.replace(/[\.#\$\[\]\s]/g, '_');
            }
        }

        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearMessage();
        }
        
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearMessage();
        }

        // æ˜¾ç¤º/æ¸…é™¤æ¶ˆæ¯
        function showMessage(text, type) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = 'message ' + type;
        }
        
        function clearMessage() {
            showMessage('', '');
        }

        // ========== æ³¨å†ŒåŠŸèƒ½ ==========
        async function registerUser() {
            console.log('=== å¼€å§‹æ³¨å†Œ ===');
            
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            // éªŒè¯
            if (!name) {
                alert('è¯·è¾“å…¥åå­—');
                return;
            }
            if (name.length > 8) {
                alert('åå­—ä¸èƒ½è¶…è¿‡8ä¸ªå­—');
                return;
            }
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            if (password.length < 6) {
                alert('å¯†ç ä¸èƒ½å°‘äº6ä½');
                return;
            }
            
            showMessage('æ­£åœ¨æ³¨å†Œ...', 'success');
            
            try {
                // 1. è·å–å¹¶ç¼–ç IP
                const userIP = await getUserIP();
                console.log('åŸå§‹IP:', userIP);
                const encodedIP = encodeIPForFirebase(userIP);
                console.log('ç¼–ç åIPè·¯å¾„:', encodedIP);
                
                // 2. æ£€æŸ¥IPæ˜¯å¦å·²æ³¨å†Œ
                try {
                    const ipCheckSnapshot = await database.ref('ip_registrations/' + encodedIP).once('value');
                    if (ipCheckSnapshot.exists()) {
                        const existingUser = ipCheckSnapshot.val();
                        alert(`ä¸€ä¸ªIPåœ°å€åªèƒ½æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚\n\nè¿™ä¸ªIPå·²ç»æ³¨å†Œè¿‡è´¦å·ï¼š\nç”¨æˆ·åï¼š${existingUser.userName}\næ³¨å†Œæ—¶é—´ï¼š${existingUser.registeredAt}\n\nå¦‚æœä½ éœ€è¦æ³¨å†Œæ–°è´¦å·ï¼Œè¯·ï¼š\n1. ä½¿ç”¨å¦ä¸€ä¸ªç½‘ç»œ\n2. æˆ–è€…ç™»å½•åŸæœ‰è´¦å·`);
                        return;
                    }
                } catch (ipError) {
                    console.log('IPæ£€æŸ¥é”™è¯¯ï¼Œä½†ç»§ç»­æ³¨å†Œ:', ipError);
                }
                
                // 3. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
                const encodedName = encodeURIComponent(name);
                const nameSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (nameSnapshot.exists()) {
                    alert('åå­— "' + name + '" å·²è¢«ä½¿ç”¨ï¼Œè¯·æ¢ä¸€ä¸ªåå­—');
                    return;
                }
                
                // 4. ç”Ÿæˆç”¨æˆ·ID
                const userId = 'user_' + Date.now();
                
                // 5. ç®€å•å¯†ç åŠ å¯†ï¼ˆä¿®å¤ä¸­æ–‡æ”¯æŒï¼‰
                const passwordHash = btoa(encodeURIComponent(password + '|' + Date.now())).split('').reverse().join('');
                
                // 6. ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
                const sessionToken = btoa(userId + '|' + Date.now());
                
                // 7. ä¿å­˜åˆ°æ•°æ®åº“
                await database.ref('users/' + userId).set({
                    name: name,
                    encodedName: encodedName,
                    passwordHash: passwordHash,
                    sessionToken: sessionToken,
                    ipAddress: userIP,
                    encodedIP: encodedIP,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                
                await database.ref('usernames/' + encodedName).set(userId);
                await database.ref('ip_registrations/' + encodedIP).set({
                    userId: userId,
                    userName: name,
                    originalIP: userIP,
                    registeredAt: new Date().toISOString()
                });
                
                console.log('âœ… æ•°æ®åº“ä¿å­˜æˆåŠŸ');
                
                // 8. å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: sessionToken,
                    ip: userIP,
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                
                // 9. è·³è½¬åˆ°ä¸»é¡µ
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1500);
                
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                alert('æ³¨å†Œå¤±è´¥ï¼š' + error.message);
            }
        }

        // ========== ç™»å½•åŠŸèƒ½ ==========
        async function loginUser() {
            const name = document.getElementById('loginName').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!name || !password) {
                alert('è¯·è¾“å…¥åå­—å’Œå¯†ç ');
                return;
            }
            
            showMessage('æ­£åœ¨ç™»å½•...', 'success');
            
            try {
                // ç¼–ç ä¸­æ–‡ç”¨æˆ·å
                const encodedName = encodeURIComponent(name);
                
                // æ‰¾ç”¨æˆ·ID
                const idSnapshot = await database.ref('usernames/' + encodedName).once('value');
                if (!idSnapshot.exists()) {
                    alert('ç”¨æˆ·ä¸å­˜åœ¨');
                    return;
                }
                
                const userId = idSnapshot.val();
                
                // è·å–ç”¨æˆ·æ•°æ®
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    alert('ç”¨æˆ·æ•°æ®é”™è¯¯');
                    return;
                }
                
                // éªŒè¯å¯†ç ï¼ˆä¿®å¤ä¸­æ–‡æ”¯æŒï¼‰
                try {
                    const reversedHash = userData.passwordHash.split('').reverse().join('');
                    const decoded = atob(reversedHash);
                    const decodedStr = decodeURIComponent(decoded);
                    const parts = decodedStr.split('|');
                    if (parts[0] !== password) {
                        alert('å¯†ç é”™è¯¯');
                        return;
                    }
                } catch {
                    alert('å¯†ç é”™è¯¯');
                    return;
                }
                
                // ç”Ÿæˆæ–°ä¼šè¯ä»¤ç‰Œ
                const newSessionToken = btoa(userId + '|' + Date.now());
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»¤ç‰Œ
                await database.ref('users/' + userId).update({
                    sessionToken: newSessionToken,
                    lastLogin: new Date().toISOString()
                });
                
                // å®‰å…¨ä¿å­˜ä¼šè¯
                const sessionData = {
                    userId: userId,
                    userName: name,
                    token: newSessionToken,
                    ip: userData.ipAddress || 'unknown',
                    expiry: Date.now() + 7 * 24 * 60 * 60 * 1000
                };
                localStorage.setItem('xiaoyuan_session', btoa(JSON.stringify(sessionData)));
                
                showMessage('âœ… ç™»å½•æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    window.location.href = 'main.html';
                }, 1000);
                
            } catch (error) {
                console.error('ç™»å½•å‡ºé”™:', error);
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            const sessionStr = localStorage.getItem('xiaoyuan_session');
            if (sessionStr) {
                try {
                    const sessionData = JSON.parse(atob(sessionStr));
                    if (Date.now() < sessionData.expiry) {
                        window.location.href = 'main.html';
                    }
                } catch (e) {
                    console.log('ä¼šè¯æ•°æ®æ— æ•ˆ');
                }
            }
        });
    </script>
</body>
</html>
