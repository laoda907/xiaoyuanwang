<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - åå°ç®¡ç†é¢æ¿</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .admin-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .admin-logout:hover {
            background: #c0392b;
        }
        
        .admin-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        .admin-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e1e1e1;
            padding: 20px 0;
        }
        
        .admin-menu {
            list-style: none;
        }
        
        .admin-menu li {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .admin-menu li:hover {
            background: #f8f9fa;
        }
        
        .admin-menu li.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #2196f3;
        }
        
        .admin-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .admin-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .admin-section.active {
            display: block;
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
        }
        
        .stat-card.users {
            border-color: #3498db;
        }
        
        .stat-card.messages {
            border-color: #2ecc71;
        }
        
        .stat-card.online {
            border-color: #9b59b6;
        }
        
        .stat-card.forums {
            border-color: #f39c12;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e1e1e1;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
    
/* ç§»åŠ¨ç«¯æ¨ªå‘æ»‘åŠ¨ + å­—ä½“æ›´å° */
.table-wrapper {
    width: 100%;
    overflow-x: auto;
}
.data-table th, 
.data-table td {
    white-space: nowrap;
    font-size: 14px;
    max-width: none;
}

</style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="admin-header">
        <h1>ğŸ”§ æ ¡å›­ç½‘åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="admin-info">
            <span>ç®¡ç†å‘˜ï¼š<strong id="adminName">ç³»ç»Ÿç®¡ç†å‘˜</strong></span>
            <button onclick="logout()" class="admin-logout">é€€å‡ºç™»å½•</button>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="admin-sidebar">
            <ul class="admin-menu">
                <li class="active" onclick="showSection('dashboard')">
                    <span>ğŸ“Š</span> æ•°æ®æ¦‚è§ˆ
                </li>
                <li onclick="showSection('users')">
                    <span>ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†
                </li>
                <li onclick="showSection('messages')">
                    <span>ğŸ’¬</span> æ¶ˆæ¯ç®¡ç†
                </li>
                <li onclick="showSection('forums')">
                    <span>ğŸ“š</span> è®ºå›ç®¡ç†
                </li>
                <li onclick="showSection('bans')">
                    <span>ğŸš«</span> å°ç¦ç®¡ç†
                </li>
                <li onclick="showSection('settings')">
                    <span>âš™ï¸</span> ç³»ç»Ÿè®¾ç½®
                </li>
                <li onclick="showSection('logs')">
                    <span>ğŸ“‹</span> æ“ä½œæ—¥å¿—
                </li>
            </ul>
        </div>
        
        <!-- å†…å®¹åŒº -->
        <div class="admin-content">
            <!-- æ•°æ®æ¦‚è§ˆ -->
            <div id="dashboard" class="admin-section active">
                <h2 class="section-title">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div class="stat-card online">
                        <div class="stat-number" id="onlineUsers">0</div>
                        <div class="stat-label">å½“å‰åœ¨çº¿</div>
                    </div>
                    <div class="stat-card forums">
                        <div class="stat-number">3</div>
                        <div class="stat-label">è®ºå›æ•°é‡</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">ğŸ“ˆ å®æ—¶æ•°æ®</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-color: #1abc9c;">
                        <div class="stat-number" id="todayMessages">0</div>
                        <div class="stat-label">ä»Šæ—¥æ¶ˆæ¯</div>
                    </div>
                    <div class="stat-card" style="border-color: #e74c3c;">
                        <div class="stat-number" id="todayUsers">0</div>
                        <div class="stat-label">ä»Šæ—¥æ³¨å†Œ</div>
                    </div>
                    <div class="stat-card" style="border-color: #f39c12;">
                        <div class="stat-number" id="bannedUsers">0</div>
                        <div class="stat-label">å·²å°ç¦ç”¨æˆ·</div>
                    </div>
                    <div class="stat-card" style="border-color: #9b59b6;">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">âš¡ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="clearAllChats()">æ¸…ç©ºæ‰€æœ‰èŠå¤©</button>
                    <button class="btn btn-warning" onclick="backupData()">å¤‡ä»½æ•°æ®</button>
                    <button class="btn btn-primary" onclick="showSection('settings')">ä¿®æ”¹åå°å¯†ç </button>
                    <button class="btn btn-success" onclick="refreshStats()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users" class="admin-section">
                <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="userSearch" placeholder="æœç´¢ç”¨æˆ·IDã€ç”¨æˆ·å..." onkeyup="searchUsers()">
                </div>
                
                <div id="usersLoading" class="loading">åŠ è½½ç”¨æˆ·æ•°æ®ä¸­...</div>
                
                <div class="table-wrapper">
<table class="data-table" id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æœ€åç™»å½•</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersList">
                        <!-- ç”¨æˆ·æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
</div>
                
                <div id="noUsers" class="empty-state" style="display: none;">
                    <div>ğŸ‘¤</div>
                    <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                </div>
            </div>
            
            <!-- æ¶ˆæ¯ç®¡ç† -->
            <div id="messages" class="admin-section">
                <h2 class="section-title">ğŸ’¬ æ¶ˆæ¯ç®¡ç†</h2>
                
                <div style="margin-bottom: 20px;">
                    <select id="forumFilter" class="form-control" style="width: 200px; display: inline-block;" onchange="loadMessages()">
                        <option value="all">å…¨éƒ¨è®ºå›</option>
                        <option value="general">ç»¼åˆè®¨è®ºåŒº</option>
                        <option value="study">å­¦ä¹ äº¤æµ</option>
                        <option value="fun">ä¼‘é—²å¨±ä¹</option>
                    </select>
                    <input type="text" id="messageSearch" class="search-input" style="width: 300px; display: inline-block; margin-left: 10px;" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..." onkeyup="searchMessages()">
                </div>
                
                <div id="messagesLoading" class="loading">åŠ è½½æ¶ˆæ¯æ•°æ®ä¸­...</div>
                
                <table class="data-table" id="messagesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ç”¨æˆ·</th>
                            <th>è®ºå›</th>
                            <th>æ¶ˆæ¯å†…å®¹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="messagesList">
                        <!-- æ¶ˆæ¯æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noMessages" class="empty-state" style="display: none;">
                    <div>ğŸ’¬</div>
                    <p>æš‚æ— æ¶ˆæ¯æ•°æ®</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-danger" onclick="clearSelectedMessages()">åˆ é™¤é€‰ä¸­æ¶ˆæ¯</button>
                    <button class="btn btn-warning" onclick="clearForumMessages()">æ¸…ç©ºå½“å‰è®ºå›</button>
                </div>
            </div>
            
            <!-- è®ºå›ç®¡ç† -->
            <div id="forums" class="admin-section">
                <h2 class="section-title">ğŸ“š è®ºå›ç®¡ç†</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="forumGeneralCount">0</div>
                        <div class="stat-label">ç»¼åˆè®¨è®ºåŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('general')">æ¸…ç©º</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="forumStudyCount">0</div>
                        <div class="stat-label">å­¦ä¹ äº¤æµåŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('study')">æ¸…ç©º</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="forumFunCount">0</div>
                        <div class="stat-label">ä¼‘é—²å¨±ä¹åŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('fun')">æ¸…ç©º</button>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">ğŸ“Š è®ºå›ç»Ÿè®¡</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è®ºå›åç§°</th>
                            <th>æ¶ˆæ¯æ€»æ•°</th>
                            <th>ä»Šæ—¥æ¶ˆæ¯</th>
                            <th>åœ¨çº¿ç”¨æˆ·</th>
                            <th>ç®¡ç†æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="forumsStats">
                        <!-- è®ºå›ç»Ÿè®¡åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
            
            <!-- å°ç¦ç®¡ç† -->
            <div id="bans" class="admin-section">
                <h2 class="section-title">ğŸš« å°ç¦ç®¡ç†</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·ID</label>
                        <input type="text" id="banUserId" class="form-control" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·ID">
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="banUserName" class="form-control" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·å">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å°ç¦åŸå› </label>
                    <input type="text" id="banReason" class="form-control" placeholder="è¾“å…¥å°ç¦åŸå› ">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å°ç¦æ—¶é•¿</label>
                        <select id="banDuration" class="form-control">
                            <option value="1">1å°æ—¶</option>
                            <option value="24">24å°æ—¶</option>
                            <option value="168">7å¤©</option>
                            <option value="720">30å¤©</option>
                            <option value="permanent">æ°¸ä¹…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ“ä½œ</label>
                        <div>
                            <button class="btn btn-danger" onclick="banUser()">å°ç¦ç”¨æˆ·</button>
                            <button class="btn btn-warning" onclick="searchUserForBan()">æŸ¥æ‰¾ç”¨æˆ·</button>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">å·²å°ç¦ç”¨æˆ·</h3>
                <div id="bansLoading" class="loading">åŠ è½½å°ç¦æ•°æ®ä¸­...</div>
                
                <table class="data-table" id="bansTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å°ç¦åŸå› </th>
                            <th>å°ç¦æ—¶é—´</th>
                            <th>è§£å°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bansList">
                        <!-- å°ç¦æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noBans" class="empty-state" style="display: none;">
                    <div>âœ…</div>
                    <p>æš‚æ— å°ç¦è®°å½•</p>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings" class="admin-section">
                <h2 class="section-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                
                <div id="settingsAlert" class="alert" style="display: none;"></div>
                
                <div class="form-group">
                    <label>ç®¡ç†å‘˜å¯†é’¥</label>
                    <input type="text" id="newAdminKey" class="form-control" placeholder="è¾“å…¥æ–°çš„ç®¡ç†å‘˜å¯†é’¥">
                </div>
                
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="newAdminPassword" class="form-control" placeholder="è¾“å…¥æ–°çš„ç®¡ç†å‘˜å¯†ç ">
                </div>
                
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmAdminPassword" class="form-control" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                
                <button class="btn btn-primary" onclick="updateAdminSettings()">æ›´æ–°è®¾ç½®</button>
                
                <h3 style="margin: 30px 0 15px 0;">âš ï¸ å±é™©æ“ä½œ</h3>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <button class="btn btn-warning" onclick="resetAdminPassword()">é‡ç½®ä¸ºé»˜è®¤å¯†ç </button>
                    <button class="btn btn-primary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
            
            <!-- æ“ä½œæ—¥å¿— -->
            <div id="logs" class="admin-section">
                <h2 class="section-title">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
                
                <div id="logsLoading" class="loading">åŠ è½½æ“ä½œæ—¥å¿—ä¸­...</div>
                
                <table class="data-table" id="logsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ“ä½œç±»å‹</th>
                            <th>æ“ä½œå†…å®¹</th>
                            <th>æ“ä½œè€…</th>
                        </tr>
                    </thead>
                    <tbody id="logsList">
                        <!-- æ—¥å¿—æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noLogs" class="empty-state" style="display: none;">
                    <div>ğŸ“</div>
                    <p>æš‚æ— æ“ä½œæ—¥å¿—</p>
                </div>
                
                <button class="btn btn-warning" onclick="clearLogs()" style="margin-top: 20px;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¡®è®¤æ“ä½œ</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="confirmMessage" style="margin: 20px 0;"></div>
            <div style="text-align: right;">
                <button class="btn" onclick="closeModal()" style="margin-right: 10px;">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmActionBtn">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- æç¤ºæ¨¡æ€æ¡† -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æç¤º</div>
                <button class="modal-close" onclick="closeAlert()">&times;</button>
            </div>
            <div id="alertMessage" style="margin: 20px 0;"></div>
            <div style="text-align: right;">
                <button class="btn btn-primary" onclick="closeAlert()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const supabase = createClient(
            "https://akqrebzfodejodgrtzyc.supabase.co",
            "sb_publishable_sCIqqs5zvkGT8ITvQNxQOQ_p2e2j5to"
        );
        
        // å…¨å±€å˜é‡
        let database;
        let currentAction = null;
        let currentData = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
        });
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminAuth() {
            const sessionStr = localStorage.getItem('admin_session');
            if (!sessionStr) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            try {
                const sessionData = JSON.parse(atob(sessionStr));
                if (Date.now() > sessionData.expiry || !sessionData.isAdmin) {
                    localStorage.removeItem('admin_session');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                initAdminPanel();
                
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                localStorage.removeItem('admin_session');
                window.location.href = 'admin-login.html';
            }
        }
        
        // åˆå§‹åŒ–åå°é¢æ¿
        function initAdminPanel() {
            try {
                console.log('âœ… åå° Supabase åˆå§‹åŒ–æˆåŠŸ');
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                loadStats();
                
                // é»˜è®¤åŠ è½½ç”¨æˆ·ç®¡ç†
                loadUsers();
                
                // ç›‘å¬å®æ—¶æ•°æ®
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAlert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }
        
        // åˆ‡æ¢åŠŸèƒ½æ¨¡å—
        function showSection(sectionId) {
            // æ›´æ–°èœå•
            document.querySelectorAll('.admin-menu li').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(sectionId) {
                case 'dashboard':
                    loadStats();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'forums':
                    loadForumsStats();
                    break;
                case 'bans':
                    loadBans();
                    break;
                case 'logs':
                    loadLogs();
                    break;
            }
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                // åŠ è½½æ€»ç”¨æˆ·æ•°
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('id');
                const totalUsers = usersData ? usersData.length : 0;
                document.getElementById('totalUsers').textContent = totalUsers;
                
                // åŠ è½½æ€»æ¶ˆæ¯æ•°
                const { data: messagesData, error: messagesError } = await supabase
                    .from('messages')
                    .select('id');
                const totalMessages = messagesData ? messagesData.length : 0;
                document.getElementById('totalMessages').textContent = totalMessages;
                
                // åŠ è½½åœ¨çº¿ç”¨æˆ·
                const { data: onlineData, error: onlineError } = await supabase
                    .from('status')
                    .select('*')
                    .eq('online', true);
                const onlineCount = onlineData ? onlineData.length : 0;
                document.getElementById('onlineUsers').textContent = onlineCount;
                
                // åŠ è½½ä»Šæ—¥æ•°æ®
                const today = new Date().toISOString().split('T')[0];
                
                // ä»Šæ—¥æ¶ˆæ¯
                const { data: todayMessagesData, error: todayMessagesError } = await supabase
                    .from('messages')
                    .select('created_at')
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');
                const todayMsgCount = todayMessagesData ? todayMessagesData.length : 0;
                document.getElementById('todayMessages').textContent = todayMsgCount;
                
                // ä»Šæ—¥æ³¨å†Œç”¨æˆ·
                const { data: todayUsersData, error: todayUsersError } = await supabase
                    .from('users')
                    .select('created_at')
                    .gte('created_at', today + 'T00:00:00')
                    .lte('created_at', today + 'T23:59:59');
                const todayUserCount = todayUsersData ? todayUsersData.length : 0;
                document.getElementById('todayUsers').textContent = todayUserCount;
                
                // åŠ è½½å°ç¦ç”¨æˆ·æ•°
                const { data: bansData, error: bansError } = await supabase
                    .from('bans')
                    .select('id');
                document.getElementById('bannedUsers').textContent = bansData ? bansData.length : 0;
                
                // åŠ è½½æ´»è·ƒç”¨æˆ·ï¼ˆ24å°æ—¶å†…æœ‰ç™»å½•ï¼‰
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                const { data: activeUsersData, error: activeUsersError } = await supabase
                    .from('users')
                    .select('last_login')
                    .gte('last_login', oneDayAgo);
                document.getElementById('activeUsers').textContent = activeUsersData ? activeUsersData.length : 0;
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsers() {
            const loadingEl = document.getElementById('usersLoading');
            const tableEl = document.getElementById('usersTable');
            const listEl = document.getElementById('usersList');
            const emptyEl = document.getElementById('noUsers');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const { data: usersData, error: usersError } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                const { data: bansData, error: bansError } = await supabase
                    .from('bans')
                    .select('user_id');
                
                const bannedUserIds = bansData ? bansData.map(ban => ban.user_id) : [];
                
                if (!usersData || usersData.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                usersData.forEach(user => {
                    const isBanned = bannedUserIds.includes(user.id);
                    const statusBadge = isBanned ? 
                        `<span class="badge badge-danger">å·²å°ç¦</span>` : 
                        `<span class="badge badge-success">æ­£å¸¸</span>`;
                    
                    html += `
                        <tr>
                            <td><code>${user.id.substring(0, 12)}...</code></td>
                            <td>${escapeHtml(user.username || 'æœªçŸ¥')}</td>
                            <td>${formatTime(user.created_at)}</td>
                            <td>${formatTime(user.last_login)}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${isBanned ? 
                                    `<button class="btn btn-success" onclick="unbanUser('${user.id}')">è§£å°</button>` :
                                    `<button class="btn btn-danger" onclick="prepareBan('${user.id}')">å°ç¦</button>`
                                }
                                <button class="btn btn-warning" onclick="deleteUser('${user.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥');
            }
        }
        
        // æœç´¢ç”¨æˆ·
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // å‡†å¤‡å°ç¦ç”¨æˆ·
        function prepareBan(userId) {
            supabase.from('users').select('*').eq('id', userId).single().then(({ data: user, error }) => {
                if (user) {
                    document.getElementById('banUserId').value = userId;
                    document.getElementById('banUserName').value = user.username || '';
                    showSection('bans');
                }
            });
        }
        
        // å°ç¦ç”¨æˆ·
        async function banUser() {
            const userId = document.getElementById('banUserId').value.trim();
            const userName = document.getElementById('banUserName').value.trim();
            const reason = document.getElementById('banReason').value.trim() || 'è¿åç¤¾åŒºè§„åˆ™';
            const duration = document.getElementById('banDuration').value;
            
            if (!userId && !userName) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–ç”¨æˆ·å');
                return;
            }
            
            let targetUserId = userId;
            
            // å¦‚æœè¾“å…¥çš„æ˜¯ç”¨æˆ·åï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·ID
            if (!userId && userName) {
                try {
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('username', userName)
                        .single();
                    
                    if (!userData) {
                        showAlert('ç”¨æˆ·ä¸å­˜åœ¨');
                        return;
                    }
                    targetUserId = userData.id;
                } catch (error) {
                    showAlert('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥');
                    return;
                }
            }
            
            // è®¡ç®—è§£å°æ—¶é—´
            let unbanTime = null;
            if (duration !== 'permanent') {
                const hours = parseInt(duration);
                unbanTime = new Date(Date.now() + hours * 60 * 60 * 1000).toISOString();
            }
            
            const banData = {
                user_id: targetUserId,
                user_name: userName,
                reason: reason,
                banned_at: new Date().toISOString(),
                unban_at: unbanTime,
                banned_by: 'admin'
            };
            
            try {
                const { error } = await supabase.from('bans').insert([banData]);
                
                if (error) throw error;
                
                // è®°å½•æ—¥å¿—
                await logAction('å°ç¦ç”¨æˆ·', `å°ç¦ç”¨æˆ· ${userName} (${targetUserId})ï¼ŒåŸå› ï¼š${reason}`);
                
                showAlert(`ç”¨æˆ· ${userName} å·²è¢«å°ç¦`);
                clearBanForm();
                loadBans();
                loadUsers();
                
            } catch (error) {
                console.error('å°ç¦å¤±è´¥:', error);
                showAlert('å°ç¦ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // æŸ¥æ‰¾ç”¨æˆ·ç”¨äºå°ç¦
        async function searchUserForBan() {
            const userName = document.getElementById('banUserName').value.trim();
            if (!userName) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            try {
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('id, username')
                    .eq('username', userName)
                    .single();
                
                if (!userData) {
                    showAlert('ç”¨æˆ·ä¸å­˜åœ¨');
                    return;
                }
                
                document.getElementById('banUserId').value = userData.id;
                document.getElementById('banUserName').value = userData.username;
                
                showAlert(`æ‰¾åˆ°ç”¨æˆ·ï¼š${userData.username} (ID: ${userData.id.substring(0, 12)}...)`);
                
            } catch (error) {
                console.error('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥:', error);
                showAlert('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åŠ è½½å°ç¦åˆ—è¡¨
        async function loadBans() {
            const loadingEl = document.getElementById('bansLoading');
            const tableEl = document.getElementById('bansTable');
            const listEl = document.getElementById('bansList');
            const emptyEl = document.getElementById('noBans');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const { data: bansData, error: bansError } = await supabase
                    .from('bans')
                    .select('*')
                    .order('banned_at', { ascending: false });
                
                if (!bansData || bansData.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                bansData.forEach(ban => {
                    const unbanTime = ban.unban_at ? formatTime(ban.unban_at) : 'æ°¸ä¹…';
                    const isExpired = ban.unban_at && new Date(ban.unban_at) < new Date();
                    
                    html += `
                        <tr>
                            <td><code>${ban.user_id ? ban.user_id.substring(0, 12) + '...' : 'N/A'}</code></td>
                            <td>${escapeHtml(ban.user_name || 'æœªçŸ¥')}</td>
                            <td>${escapeHtml(ban.reason)}</td>
                            <td>${formatTime(ban.banned_at)}</td>
                            <td>${unbanTime} ${isExpired ? '<span class="badge badge-warning">å·²è¿‡æœŸ</span>' : ''}</td>
                            <td>
                                <button class="btn btn-success" onclick="unbanUser('${ban.user_id}')">è§£å°</button>
                                <button class="btn btn-danger" onclick="confirmAction('æ°¸ä¹…åˆ é™¤ç”¨æˆ·', 'deleteUser', '${ban.user_id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½å°ç¦åˆ—è¡¨å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½å°ç¦æ•°æ®å¤±è´¥');
            }
        }
        
        // è§£å°ç”¨æˆ·
        async function unbanUser(userId) {
            try {
                const { error } = await supabase
                    .from('bans')
                    .delete()
                    .eq('user_id', userId);
                
                if (error) throw error;
                
                // è®°å½•æ—¥å¿—
                await logAction('è§£å°ç”¨æˆ·', `è§£å°ç”¨æˆ· ${userId}`);
                
                showAlert('ç”¨æˆ·å·²è§£å°');
                loadBans();
                loadUsers();
                
            } catch (error) {
                console.error('è§£å°å¤±è´¥:', error);
                showAlert('è§£å°ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            try {
                // è·å–ç”¨æˆ·å
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', userId)
                    .single();
                    
                const userName = userData ? userData.username : 'æœªçŸ¥ç”¨æˆ·';
                
                // åˆ é™¤ç”¨æˆ·æ•°æ®
                await Promise.all([
                    supabase.from('users').delete().eq('id', userId),
                    supabase.from('bans').delete().eq('user_id', userId),
                    supabase.from('status').delete().eq('user_id', userId)
                ]);
                
                // è®°å½•æ—¥å¿—
                await logAction('åˆ é™¤ç”¨æˆ·', `åˆ é™¤ç”¨æˆ· ${userName} (${userId})`);
                
                showAlert('ç”¨æˆ·å·²åˆ é™¤');
                loadUsers();
                loadBans();
                loadStats();
                
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showAlert('åˆ é™¤ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åŠ è½½æ¶ˆæ¯æ•°æ®
        async function loadMessages() {
            const loadingEl = document.getElementById('messagesLoading');
            const tableEl = document.getElementById('messagesTable');
            const listEl = document.getElementById('messagesList');
            const emptyEl = document.getElementById('noMessages');
            const forumFilter = document.getElementById('forumFilter').value;
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                let query = supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (forumFilter !== 'all') {
                    query = query.eq('forum', forumFilter);
                }
                
                const { data: messagesData, error: messagesError } = await query;
                
                if (!messagesData || messagesData.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                messagesData.slice(0, 100).forEach(msg => {
                    html += `
                        <tr data-message-id="${msg.id}" data-forum="${msg.forum}">
                            <td>${formatTime(msg.created_at)}</td>
                            <td>${escapeHtml(msg.user_name || 'åŒ¿å')}</td>
                            <td>${getForumName(msg.forum)}</td>
                            <td>${escapeHtml(msg.text)}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteMessage('${msg.forum}', '${msg.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½æ¶ˆæ¯æ•°æ®å¤±è´¥');
            }
        }
        
        // æœç´¢æ¶ˆæ¯
        function searchMessages() {
            const searchTerm = document.getElementById('messageSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#messagesList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // åˆ é™¤æ¶ˆæ¯
        async function deleteMessage(forum, messageId) {
            try {
                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .eq('id', messageId);
                
                if (error) throw error;
                
                // è®°å½•æ—¥å¿—
                await logAction('åˆ é™¤æ¶ˆæ¯', `åˆ é™¤ ${getForumName(forum)} çš„æ¶ˆæ¯ ${messageId}`);
                
                showAlert('æ¶ˆæ¯å·²åˆ é™¤');
                loadMessages();
                loadStats();
                
            } catch (error) {
                console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
                showAlert('åˆ é™¤æ¶ˆæ¯å¤±è´¥');
            }
        }
        
        // æ¸…ç©ºè®ºå›æ¶ˆæ¯
        async function clearForum(forum) {
            const forumName = getForumName(forum);
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©º ${forumName} çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                try {
                    const { error } = await supabase
                        .from('messages')
                        .delete()
                        .eq('forum', forum);
                    
                    if (error) throw error;
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºè®ºå›', `æ¸…ç©º ${forumName} çš„æ‰€æœ‰æ¶ˆæ¯`);
                    
                    showAlert(`${forumName} å·²æ¸…ç©º`);
                    loadMessages();
                    loadForumsStats();
                    loadStats();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºè®ºå›å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºè®ºå›å¤±è´¥');
                }
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰èŠå¤©
        async function clearAllChats() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®ºå›çš„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                try {
                    const { error } = await supabase
                        .from('messages')
                        .delete()
                        .neq('id', -1);
                    
                    if (error) throw error;
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºæ‰€æœ‰èŠå¤©', 'æ¸…ç©ºæ‰€æœ‰è®ºå›çš„èŠå¤©è®°å½•');
                    
                    showAlert('æ‰€æœ‰èŠå¤©è®°å½•å·²æ¸…ç©º');
                    loadMessages();
                    loadForumsStats();
                    loadStats();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºæ‰€æœ‰èŠå¤©å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥');
                }
            }
        }
        
        // åŠ è½½è®ºå›ç»Ÿè®¡
        async function loadForumsStats() {
            try {
                const forums = ['general', 'study', 'fun'];
                let html = '';
                
                for (const forum of forums) {
                    // æ€»æ¶ˆæ¯æ•°
                    const { data: totalData, error: totalError } = await supabase
                        .from('messages')
                        .select('id')
                        .eq('forum', forum);
                    const totalMessages = totalData ? totalData.length : 0;
                    
                    // ä»Šæ—¥æ¶ˆæ¯æ•°
                    const today = new Date().toISOString().split('T')[0];
                    const { data: todayData, error: todayError } = await supabase
                        .from('messages')
                        .select('id')
                        .eq('forum', forum)
                        .gte('created_at', today + 'T00:00:00')
                        .lte('created_at', today + 'T23:59:59');
                    const todayMessages = todayData ? todayData.length : 0;
                    
                    // åœ¨çº¿ç”¨æˆ·æ•°
                    const { data: onlineData, error: onlineError } = await supabase
                        .from('status')
                        .select('*')
                        .eq('online', true)
                        .eq('forum', forum);
                    const onlineInForum = onlineData ? onlineData.length : 0;
                    
                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                    document.getElementById(`forum${forum.charAt(0).toUpperCase() + forum.slice(1)}Count`).textContent = totalMessages;
                    
                    html += `
                        <tr>
                            <td>${getForumName(forum)}</td>
                            <td>${totalMessages}</td>
                            <td>${todayMessages}</td>
                            <td>${onlineInForum}</td>
                            <td>
                                <button class="btn btn-danger" onclick="clearForum('${forum}')">æ¸…ç©ºæ¶ˆæ¯</button>
                            </td>
                        </tr>
                    `;
                }
                
                document.getElementById('forumsStats').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½è®ºå›ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ“ä½œæ—¥å¿—
        async function loadLogs() {
            const loadingEl = document.getElementById('logsLoading');
            const tableEl = document.getElementById('logsTable');
            const listEl = document.getElementById('logsList');
            const emptyEl = document.getElementById('noLogs');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const { data: logsData, error: logsError } = await supabase
                    .from('logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(50);
                
                if (!logsData || logsData.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                logsData.forEach(log => {
                    html += `
                        <tr>
                            <td>${formatTime(log.timestamp)}</td>
                            <td>${escapeHtml(log.action)}</td>
                            <td>${escapeHtml(log.details)}</td>
                            <td>${escapeHtml(log.operator || 'ç³»ç»Ÿ')}</td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥');
            }
        }
        
        // æ›´æ–°ç®¡ç†å‘˜è®¾ç½®
        async function updateAdminSettings() {
            const newKey = document.getElementById('newAdminKey').value.trim();
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            const alertEl = document.getElementById('settingsAlert');
            
            if (newPassword && newPassword !== confirmPassword) {
                alertEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                alertEl.className = 'alert alert-error';
                alertEl.style.display = 'block';
                return;
            }
            
            try {
                const updates = {};
                
                if (newKey) {
                    updates.admin_key = newKey;
                }
                
                if (newPassword) {
                    updates.admin_password = newPassword;
                }
                
                updates.last_modified = new Date().toISOString();
                
                const { error } = await supabase
                    .from('admin')
                    .update(updates)
                    .eq('id', 1);
                
                if (error) throw error;
                
                // è®°å½•æ—¥å¿—
                await logAction('æ›´æ–°è®¾ç½®', 'æ›´æ–°ç®¡ç†å‘˜è®¾ç½®');
                
                alertEl.textContent = 'è®¾ç½®å·²æ›´æ–°';
                alertEl.className = 'alert alert-success';
                alertEl.style.display = 'block';
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('newAdminKey').value = '';
                document.getElementById('newAdminPassword').value = '';
                document.getElementById('confirmAdminPassword').value = '';
                
            } catch (error) {
                console.error('æ›´æ–°è®¾ç½®å¤±è´¥:', error);
                alertEl.textContent = 'æ›´æ–°è®¾ç½®å¤±è´¥';
                alertEl.className = 'alert alert-error';
                alertEl.style.display = 'block';
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤å¯†ç 
        function resetAdminPassword() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¯†ç å—ï¼Ÿé‡ç½®åè¯·ä½¿ç”¨é»˜è®¤å¯†ç ç™»å½•ã€‚')) {
                document.getElementById('newAdminKey').value = 'admin2024';
                document.getElementById('newAdminPassword').value = 'xiaoyuan123';
                document.getElementById('confirmAdminPassword').value = 'xiaoyuan123';
                showAlert('å·²å¡«å…¥é»˜è®¤å¯†ç ï¼Œè¯·ç‚¹å‡»"æ›´æ–°è®¾ç½®"ä¿å­˜');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰
        async function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€èŠå¤©è®°å½•å’Œè®¾ç½®ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (confirm('æœ€åç¡®è®¤ï¼šä½ çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¾“å…¥"ç¡®è®¤åˆ é™¤"ç»§ç»­')) {
                    try {
                        // è¿™é‡Œå¯ä»¥æ·»åŠ å®Œæ•´çš„æ•°æ®æ¸…ç†é€»è¾‘
                        await Promise.all([
                            supabase.from('users').delete().neq('id', -1),
                            supabase.from('messages').delete().neq('id', -1),
                            supabase.from('bans').delete().neq('id', -1),
                            supabase.from('status').delete().neq('id', -1),
                            supabase.from('logs').delete().neq('id', -1)
                        ]);
                        
                        // è®°å½•æ—¥å¿—
                        await logAction('æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€èŠå¤©è®°å½•å’Œè®¾ç½®');
                        
                        showAlert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼Œç³»ç»Ÿå·²é‡ç½®');
                        loadStats();
                        
                    } catch (error) {
                        console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                        showAlert('æ¸…ç©ºæ•°æ®å¤±è´¥');
                    }
                }
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                // è·å–æ‰€æœ‰æ•°æ®
                const [usersRes, messagesRes, bansRes, statusRes, logsRes, adminRes] = await Promise.all([
                    supabase.from('users').select('*'),
                    supabase.from('messages').select('*'),
                    supabase.from('bans').select('*'),
                    supabase.from('status').select('*'),
                    supabase.from('logs').select('*'),
                    supabase.from('admin').select('*')
                ]);
                
                const data = {
                    users: usersRes.data || [],
                    messages: messagesRes.data || [],
                    bans: bansRes.data || [],
                    status: statusRes.data || [],
                    logs: logsRes.data || [],
                    admin: adminRes.data || []
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `æ ¡å›­ç½‘æ•°æ®å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                // è®°å½•æ—¥å¿—
                await logAction('å¯¼å‡ºæ•°æ®', 'å¯¼å‡ºæ‰€æœ‰æ•°æ®å¤‡ä»½');
                
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                showAlert('å¯¼å‡ºæ•°æ®å¤±è´¥');
            }
        }
        
        // å¤‡ä»½æ•°æ®
        function backupData() {
            exportData();
            showAlert('æ•°æ®å¤‡ä»½å·²å¼€å§‹ä¸‹è½½');
        }
        
        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿ')) {
                try {
                    const { error } = await supabase
                        .from('logs')
                        .delete()
                        .neq('id', -1);
                    
                    if (error) throw error;
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºæ—¥å¿—', 'æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—');
                    
                    showAlert('æ“ä½œæ—¥å¿—å·²æ¸…ç©º');
                    loadLogs();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºæ—¥å¿—å¤±è´¥');
                }
            }
        }
        
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshStats() {
            loadStats();
            showAlert('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
        }
        
        // è®¾ç½®å®æ—¶ç›‘å¬
        function setupRealtimeListeners() {
            // ç›‘å¬åœ¨çº¿ç”¨æˆ·å˜åŒ–
            const statusChannel = supabase
                .channel('realtime-status')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'status' },
                    () => {
                        // æ›´æ–°åœ¨çº¿äººæ•°
                        supabase
                            .from('status')
                            .select('*')
                            .eq('online', true)
                            .then(({ data, error }) => {
                                const onlineCount = data ? data.length : 0;
                                document.getElementById('onlineUsers').textContent = onlineCount;
                                
                                // å¦‚æœå½“å‰åœ¨è®ºå›ç®¡ç†é¡µé¢ï¼Œæ›´æ–°è®ºå›åœ¨çº¿äººæ•°
                                if (document.getElementById('forums').classList.contains('active')) {
                                    loadForumsStats();
                                }
                            });
                    }
                )
                .subscribe();
            
            // ç›‘å¬æ¶ˆæ¯å˜åŒ–
            const messagesChannel = supabase
                .channel('realtime-messages')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'messages' },
                    () => {
                        // å¦‚æœå½“å‰åœ¨æ¶ˆæ¯ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                        if (document.getElementById('messages').classList.contains('active')) {
                            loadMessages();
                        }
                        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                        if (document.getElementById('dashboard').classList.contains('active')) {
                            loadStats();
                        }
                    }
                )
                .subscribe();
            
            // ç›‘å¬ç”¨æˆ·å˜åŒ–
            const usersChannel = supabase
                .channel('realtime-users')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'users' },
                    () => {
                        // åˆ·æ–°ç”¨æˆ·ç›¸å…³çš„ç»Ÿè®¡æ•°æ®
                        if (document.getElementById('dashboard').classList.contains('active') || 
                            document.getElementById('users').classList.contains('active')) {
                            loadStats();
                            if (document.getElementById('users').classList.contains('active')) {
                                loadUsers();
                            }
                        }
                    }
                )
                .subscribe();
            
            // ç›‘å¬å°ç¦å˜åŒ–
            const bansChannel = supabase
                .channel('realtime-bans')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'bans' },
                    () => {
                        // åˆ·æ–°å°ç¦ç›¸å…³çš„ç»Ÿè®¡æ•°æ®
                        if (document.getElementById('dashboard').classList.contains('active') || 
                            document.getElementById('bans').classList.contains('active')) {
                            loadStats();
                            if (document.getElementById('bans').classList.contains('active')) {
                                loadBans();
                            }
                        }
                    }
                )
                .subscribe();
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        async function logAction(action, details) {
            try {
                const { error } = await supabase
                    .from('logs')
                    .insert([{
                        action: action,
                        details: details,
                        timestamp: new Date().toISOString(),
                        operator: 'ç®¡ç†å‘˜'
                    }]);
                    
                if (error) throw error;
            } catch (error) {
                console.error('è®°å½•æ—¥å¿—å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
        function confirmAction(message, action, data) {
            currentAction = action;
            currentData = data;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmActionBtn').onclick = executeAction;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ
        function executeAction() {
            if (currentAction && window[currentAction]) {
                window[currentAction](currentData);
            }
            closeModal();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentAction = null;
            currentData = null;
        }
        
        // æ˜¾ç¤ºæç¤º
        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        
        // å…³é—­æç¤º
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
        }
        
        // æ¸…ç©ºå°ç¦è¡¨å•
        function clearBanForm() {
            document.getElementById('banUserId').value = '';
            document.getElementById('banUserName').value = '';
            document.getElementById('banReason').value = '';
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('admin_session');
            window.location.href = 'admin-login.html';
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
        
        // å·¥å…·å‡½æ•°ï¼šè·å–è®ºå›åç§°
        function getForumName(forumId) {
            const names = {
                'general': 'ç»¼åˆè®¨è®ºåŒº',
                'study': 'å­¦ä¹ äº¤æµ',
                'fun': 'ä¼‘é—²å¨±ä¹'
            };
            return names[forumId] || forumId;
        }
        
        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // å°†å‡½æ•°æš´éœ²ç»™å…¨å±€
        window.showSection = showSection;
        window.searchUsers = searchUsers;
        window.prepareBan = prepareBan;
        window.banUser = banUser;
        window.searchUserForBan = searchUserForBan;
        window.unbanUser = unbanUser;
        window.deleteUser = deleteUser;
        window.loadMessages = loadMessages;
        window.searchMessages = searchMessages;
        window.deleteMessage = deleteMessage;
        window.clearForum = clearForum;
        window.clearAllChats = clearAllChats;
        window.updateAdminSettings = updateAdminSettings;
        window.resetAdminPassword = resetAdminPassword;
        window.clearAllData = clearAllData;
        window.exportData = exportData;
        window.backupData = backupData;
        window.clearLogs = clearLogs;
        window.refreshStats = refreshStats;
        window.confirmAction = confirmAction;
        window.closeModal = closeModal;
        window.executeAction = executeAction;
        window.showAlert = showAlert;
        window.closeAlert = closeAlert;
        window.clearBanForm = clearBanForm;
        window.logout = logout;
        window.logAction = logAction;
        
        // ä¸ºå…¼å®¹æ€§ä¿ç•™çš„å‡½æ•°ï¼ˆåŸä»£ç ä¸­æœ‰è°ƒç”¨ä½†æœªå®šä¹‰çš„ï¼‰
        window.clearSelectedMessages = function() {
            const selected = document.querySelectorAll('#messagesList input[type="checkbox"]:checked');
            if (selected.length === 0) {
                showAlert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selected.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
                // è¿™é‡Œå¯ä»¥å®ç°æ‰¹é‡åˆ é™¤é€»è¾‘
                showAlert('æ‰¹é‡åˆ é™¤åŠŸèƒ½å¾…å®ç°');
            }
        };
        
        window.clearForumMessages = function() {
            const forumFilter = document.getElementById('forumFilter').value;
            if (forumFilter === 'all') {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…·ä½“çš„è®ºå›');
                return;
            }
            clearForum(forumFilter);
        };
    </script>
</body>
                          </html>
