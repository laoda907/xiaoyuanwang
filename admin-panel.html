<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘ - åå°ç®¡ç†é¢æ¿</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .admin-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .admin-logout:hover {
            background: #c0392b;
        }
        
        .admin-container {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        .admin-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e1e1e1;
            padding: 20px 0;
        }
        
        .admin-menu {
            list-style: none;
        }
        
        .admin-menu li {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .admin-menu li:hover {
            background: #f8f9fa;
        }
        
        .admin-menu li.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #2196f3;
        }
        
        .admin-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .admin-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .admin-section.active {
            display: block;
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
        }
        
        .stat-card.users {
            border-color: #3498db;
        }
        
        .stat-card.messages {
            border-color: #2ecc71;
        }
        
        .stat-card.online {
            border-color: #9b59b6;
        }
        
        .stat-card.forums {
            border-color: #f39c12;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e1e1e1;
        }
        
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="admin-header">
        <h1>ğŸ”§ æ ¡å›­ç½‘åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="admin-info">
            <span>ç®¡ç†å‘˜ï¼š<strong id="adminName">ç³»ç»Ÿç®¡ç†å‘˜</strong></span>
            <button onclick="logout()" class="admin-logout">é€€å‡ºç™»å½•</button>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="admin-sidebar">
            <ul class="admin-menu">
                <li class="active" onclick="showSection('dashboard')">
                    <span>ğŸ“Š</span> æ•°æ®æ¦‚è§ˆ
                </li>
                <li onclick="showSection('users')">
                    <span>ğŸ‘¥</span> ç”¨æˆ·ç®¡ç†
                </li>
                <li onclick="showSection('messages')">
                    <span>ğŸ’¬</span> æ¶ˆæ¯ç®¡ç†
                </li>
                <li onclick="showSection('forums')">
                    <span>ğŸ“š</span> è®ºå›ç®¡ç†
                </li>
                <li onclick="showSection('bans')">
                    <span>ğŸš«</span> å°ç¦ç®¡ç†
                </li>
                <li onclick="showSection('settings')">
                    <span>âš™ï¸</span> ç³»ç»Ÿè®¾ç½®
                </li>
                <li onclick="showSection('logs')">
                    <span>ğŸ“‹</span> æ“ä½œæ—¥å¿—
                </li>
            </ul>
        </div>
        
        <!-- å†…å®¹åŒº -->
        <div class="admin-content">
            <!-- æ•°æ®æ¦‚è§ˆ -->
            <div id="dashboard" class="admin-section active">
                <h2 class="section-title">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card users">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                    </div>
                    <div class="stat-card messages">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div class="stat-card online">
                        <div class="stat-number" id="onlineUsers">0</div>
                        <div class="stat-label">å½“å‰åœ¨çº¿</div>
                    </div>
                    <div class="stat-card forums">
                        <div class="stat-number">3</div>
                        <div class="stat-label">è®ºå›æ•°é‡</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">ğŸ“ˆ å®æ—¶æ•°æ®</h3>
                <div class="stats-grid">
                    <div class="stat-card" style="border-color: #1abc9c;">
                        <div class="stat-number" id="todayMessages">0</div>
                        <div class="stat-label">ä»Šæ—¥æ¶ˆæ¯</div>
                    </div>
                    <div class="stat-card" style="border-color: #e74c3c;">
                        <div class="stat-number" id="todayUsers">0</div>
                        <div class="stat-label">ä»Šæ—¥æ³¨å†Œ</div>
                    </div>
                    <div class="stat-card" style="border-color: #f39c12;">
                        <div class="stat-number" id="bannedUsers">0</div>
                        <div class="stat-label">å·²å°ç¦ç”¨æˆ·</div>
                    </div>
                    <div class="stat-card" style="border-color: #9b59b6;">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">âš¡ å¿«é€Ÿæ“ä½œ</h3>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="clearAllChats()">æ¸…ç©ºæ‰€æœ‰èŠå¤©</button>
                    <button class="btn btn-warning" onclick="backupData()">å¤‡ä»½æ•°æ®</button>
                    <button class="btn btn-primary" onclick="showSection('settings')">ä¿®æ”¹åå°å¯†ç </button>
                    <button class="btn btn-success" onclick="refreshStats()">åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users" class="admin-section">
                <h2 class="section-title">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="userSearch" placeholder="æœç´¢ç”¨æˆ·IDã€ç”¨æˆ·å..." onkeyup="searchUsers()">
                </div>
                
                <div id="usersLoading" class="loading">åŠ è½½ç”¨æˆ·æ•°æ®ä¸­...</div>
                
                <table class="data-table" id="usersTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æœ€åç™»å½•</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersList">
                        <!-- ç”¨æˆ·æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noUsers" class="empty-state" style="display: none;">
                    <div>ğŸ‘¤</div>
                    <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                </div>
            </div>
            
            <!-- æ¶ˆæ¯ç®¡ç† -->
            <div id="messages" class="admin-section">
                <h2 class="section-title">ğŸ’¬ æ¶ˆæ¯ç®¡ç†</h2>
                
                <div style="margin-bottom: 20px;">
                    <select id="forumFilter" class="form-control" style="width: 200px; display: inline-block;" onchange="loadMessages()">
                        <option value="all">å…¨éƒ¨è®ºå›</option>
                        <option value="general">ç»¼åˆè®¨è®ºåŒº</option>
                        <option value="study">å­¦ä¹ äº¤æµ</option>
                        <option value="fun">ä¼‘é—²å¨±ä¹</option>
                    </select>
                    <input type="text" id="messageSearch" class="search-input" style="width: 300px; display: inline-block; margin-left: 10px;" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..." onkeyup="searchMessages()">
                </div>
                
                <div id="messagesLoading" class="loading">åŠ è½½æ¶ˆæ¯æ•°æ®ä¸­...</div>
                
                <table class="data-table" id="messagesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>ç”¨æˆ·</th>
                            <th>è®ºå›</th>
                            <th>æ¶ˆæ¯å†…å®¹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="messagesList">
                        <!-- æ¶ˆæ¯æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noMessages" class="empty-state" style="display: none;">
                    <div>ğŸ’¬</div>
                    <p>æš‚æ— æ¶ˆæ¯æ•°æ®</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-danger" onclick="clearSelectedMessages()">åˆ é™¤é€‰ä¸­æ¶ˆæ¯</button>
                    <button class="btn btn-warning" onclick="clearForumMessages()">æ¸…ç©ºå½“å‰è®ºå›</button>
                </div>
            </div>
            
            <!-- è®ºå›ç®¡ç† -->
            <div id="forums" class="admin-section">
                <h2 class="section-title">ğŸ“š è®ºå›ç®¡ç†</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="forumGeneralCount">0</div>
                        <div class="stat-label">ç»¼åˆè®¨è®ºåŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('general')">æ¸…ç©º</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="forumStudyCount">0</div>
                        <div class="stat-label">å­¦ä¹ äº¤æµåŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('study')">æ¸…ç©º</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="forumFunCount">0</div>
                        <div class="stat-label">ä¼‘é—²å¨±ä¹åŒºæ¶ˆæ¯</div>
                        <button class="btn btn-danger" style="margin-top: 10px;" onclick="clearForum('fun')">æ¸…ç©º</button>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">ğŸ“Š è®ºå›ç»Ÿè®¡</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>è®ºå›åç§°</th>
                            <th>æ¶ˆæ¯æ€»æ•°</th>
                            <th>ä»Šæ—¥æ¶ˆæ¯</th>
                            <th>åœ¨çº¿ç”¨æˆ·</th>
                            <th>ç®¡ç†æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="forumsStats">
                        <!-- è®ºå›ç»Ÿè®¡åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
            
            <!-- å°ç¦ç®¡ç† -->
            <div id="bans" class="admin-section">
                <h2 class="section-title">ğŸš« å°ç¦ç®¡ç†</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·ID</label>
                        <input type="text" id="banUserId" class="form-control" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·ID">
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="banUserName" class="form-control" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·å">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å°ç¦åŸå› </label>
                    <input type="text" id="banReason" class="form-control" placeholder="è¾“å…¥å°ç¦åŸå› ">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>å°ç¦æ—¶é•¿</label>
                        <select id="banDuration" class="form-control">
                            <option value="1">1å°æ—¶</option>
                            <option value="24">24å°æ—¶</option>
                            <option value="168">7å¤©</option>
                            <option value="720">30å¤©</option>
                            <option value="permanent">æ°¸ä¹…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ“ä½œ</label>
                        <div>
                            <button class="btn btn-danger" onclick="banUser()">å°ç¦ç”¨æˆ·</button>
                            <button class="btn btn-warning" onclick="searchUserForBan()">æŸ¥æ‰¾ç”¨æˆ·</button>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 15px 0;">å·²å°ç¦ç”¨æˆ·</h3>
                <div id="bansLoading" class="loading">åŠ è½½å°ç¦æ•°æ®ä¸­...</div>
                
                <table class="data-table" id="bansTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>ç”¨æˆ·ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>å°ç¦åŸå› </th>
                            <th>å°ç¦æ—¶é—´</th>
                            <th>è§£å°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="bansList">
                        <!-- å°ç¦æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noBans" class="empty-state" style="display: none;">
                    <div>âœ…</div>
                    <p>æš‚æ— å°ç¦è®°å½•</p>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings" class="admin-section">
                <h2 class="section-title">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                
                <div id="settingsAlert" class="alert" style="display: none;"></div>
                
                <div class="form-group">
                    <label>ç®¡ç†å‘˜å¯†é’¥</label>
                    <input type="text" id="newAdminKey" class="form-control" placeholder="è¾“å…¥æ–°çš„ç®¡ç†å‘˜å¯†é’¥">
                </div>
                
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="newAdminPassword" class="form-control" placeholder="è¾“å…¥æ–°çš„ç®¡ç†å‘˜å¯†ç ">
                </div>
                
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmAdminPassword" class="form-control" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                
                <button class="btn btn-primary" onclick="updateAdminSettings()">æ›´æ–°è®¾ç½®</button>
                
                <h3 style="margin: 30px 0 15px 0;">âš ï¸ å±é™©æ“ä½œ</h3>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                    <button class="btn btn-warning" onclick="resetAdminPassword()">é‡ç½®ä¸ºé»˜è®¤å¯†ç </button>
                    <button class="btn btn-primary" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
            
            <!-- æ“ä½œæ—¥å¿— -->
            <div id="logs" class="admin-section">
                <h2 class="section-title">ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
                
                <div id="logsLoading" class="loading">åŠ è½½æ“ä½œæ—¥å¿—ä¸­...</div>
                
                <table class="data-table" id="logsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ“ä½œç±»å‹</th>
                            <th>æ“ä½œå†…å®¹</th>
                            <th>æ“ä½œè€…</th>
                        </tr>
                    </thead>
                    <tbody id="logsList">
                        <!-- æ—¥å¿—æ•°æ®åŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                
                <div id="noLogs" class="empty-state" style="display: none;">
                    <div>ğŸ“</div>
                    <p>æš‚æ— æ“ä½œæ—¥å¿—</p>
                </div>
                
                <button class="btn btn-warning" onclick="clearLogs()" style="margin-top: 20px;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ç¡®è®¤æ“ä½œ</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="confirmMessage" style="margin: 20px 0;"></div>
            <div style="text-align: right;">
                <button class="btn" onclick="closeModal()" style="margin-right: 10px;">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirmActionBtn">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- æç¤ºæ¨¡æ€æ¡† -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æç¤º</div>
                <button class="modal-close" onclick="closeAlert()">&times;</button>
            </div>
            <div id="alertMessage" style="margin: 20px 0;"></div>
            <div style="text-align: right;">
                <button class="btn btn-primary" onclick="closeAlert()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase é…ç½® ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD_KwO_EJxUfAQ3WF98IRN_fua6VXAWTe4",
            authDomain: "laoda907-22511.firebaseapp.com",
            databaseURL: "https://laoda907-22511-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "laoda907-22511",
            storageBucket: "laoda907-22511.firebasestorage.app",
            messagingSenderId: "176173610464",
            appId: "1:176173610464:web:3ff86202f9b05f24b36785"
        };
        
        // å…¨å±€å˜é‡
        let database;
        let currentAction = null;
        let currentData = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAuth();
        });
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminAuth() {
            const sessionStr = localStorage.getItem('admin_session');
            if (!sessionStr) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            try {
                const sessionData = JSON.parse(atob(sessionStr));
                if (Date.now() > sessionData.expiry || !sessionData.isAdmin) {
                    localStorage.removeItem('admin_session');
                    window.location.href = 'admin-login.html';
                    return;
                }
                
                initAdminPanel();
                
            } catch (error) {
                console.error('éªŒè¯å¤±è´¥:', error);
                localStorage.removeItem('admin_session');
                window.location.href = 'admin-login.html';
            }
        }
        
        // åˆå§‹åŒ–åå°é¢æ¿
        function initAdminPanel() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('âœ… åå° Firebase åˆå§‹åŒ–æˆåŠŸ');
                
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                loadStats();
                
                // é»˜è®¤åŠ è½½ç”¨æˆ·ç®¡ç†
                loadUsers();
                
                // ç›‘å¬å®æ—¶æ•°æ®
                setupRealtimeListeners();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAlert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }
        
        // åˆ‡æ¢åŠŸèƒ½æ¨¡å—
        function showSection(sectionId) {
            // æ›´æ–°èœå•
            document.querySelectorAll('.admin-menu li').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('li').classList.add('active');
            
            // æ˜¾ç¤ºå¯¹åº”å†…å®¹
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(sectionId) {
                case 'dashboard':
                    loadStats();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'forums':
                    loadForumsStats();
                    break;
                case 'bans':
                    loadBans();
                    break;
                case 'logs':
                    loadLogs();
                    break;
            }
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                // åŠ è½½æ€»ç”¨æˆ·æ•°
                const usersSnapshot = await database.ref('users').once('value');
                const totalUsers = usersSnapshot.numChildren();
                document.getElementById('totalUsers').textContent = totalUsers;
                
                // åŠ è½½æ€»æ¶ˆæ¯æ•°
                let totalMessages = 0;
                const forums = ['general', 'study', 'fun'];
                for (const forum of forums) {
                    const forumSnapshot = await database.ref(`forums/${forum}/messages`).once('value');
                    totalMessages += forumSnapshot.numChildren();
                }
                document.getElementById('totalMessages').textContent = totalMessages;
                
                // åŠ è½½åœ¨çº¿ç”¨æˆ·
                const onlineSnapshot = await database.ref('status').once('value');
                let onlineCount = 0;
                onlineSnapshot.forEach(child => {
                    if (child.val().online) onlineCount++;
                });
                document.getElementById('onlineUsers').textContent = onlineCount;
                
                // åŠ è½½ä»Šæ—¥æ•°æ®
                const today = new Date().toISOString().split('T')[0];
                let todayMsgCount = 0;
                let todayUserCount = 0;
                
                // ä»Šæ—¥æ¶ˆæ¯
                for (const forum of forums) {
                    const forumSnapshot = await database.ref(`forums/${forum}/messages`).once('value');
                    forumSnapshot.forEach(child => {
                        const msgTime = child.val().timestamp;
                        if (msgTime && msgTime.includes(today)) {
                            todayMsgCount++;
                        }
                    });
                }
                document.getElementById('todayMessages').textContent = todayMsgCount;
                
                // ä»Šæ—¥æ³¨å†Œç”¨æˆ·
                usersSnapshot.forEach(child => {
                    const userTime = child.val().createdAt;
                    if (userTime && userTime.includes(today)) {
                        todayUserCount++;
                    }
                });
                document.getElementById('todayUsers').textContent = todayUserCount;
                
                // åŠ è½½å°ç¦ç”¨æˆ·æ•°
                const bansSnapshot = await database.ref('bans').once('value');
                document.getElementById('bannedUsers').textContent = bansSnapshot.numChildren();
                
                // åŠ è½½æ´»è·ƒç”¨æˆ·ï¼ˆ24å°æ—¶å†…æœ‰ç™»å½•ï¼‰
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
                let activeCount = 0;
                usersSnapshot.forEach(child => {
                    const lastLogin = child.val().lastLogin;
                    if (lastLogin && lastLogin > oneDayAgo) {
                        activeCount++;
                    }
                });
                document.getElementById('activeUsers').textContent = activeCount;
                
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsers() {
            const loadingEl = document.getElementById('usersLoading');
            const tableEl = document.getElementById('usersTable');
            const listEl = document.getElementById('usersList');
            const emptyEl = document.getElementById('noUsers');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const usersSnapshot = await database.ref('users').once('value');
                const bansSnapshot = await database.ref('bans').once('value');
                const bans = {};
                
                bansSnapshot.forEach(child => {
                    bans[child.key] = child.val();
                });
                
                if (usersSnapshot.numChildren() === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                usersSnapshot.forEach(child => {
                    const user = child.val();
                    const isBanned = bans[child.key];
                    const statusBadge = isBanned ? 
                        `<span class="badge badge-danger">å·²å°ç¦</span>` : 
                        `<span class="badge badge-success">æ­£å¸¸</span>`;
                    
                    html += `
                        <tr>
                            <td><code>${child.key.substring(0, 12)}...</code></td>
                            <td>${escapeHtml(user.name || 'æœªçŸ¥')}</td>
                            <td>${formatTime(user.createdAt)}</td>
                            <td>${formatTime(user.lastLogin)}</td>
                            <td>${statusBadge}</td>
                            <td>
                                ${isBanned ? 
                                    `<button class="btn btn-success" onclick="unbanUser('${child.key}')">è§£å°</button>` :
                                    `<button class="btn btn-danger" onclick="prepareBan('${child.key}')">å°ç¦</button>`
                                }
                                <button class="btn btn-warning" onclick="deleteUser('${child.key}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥');
            }
        }
        
        // æœç´¢ç”¨æˆ·
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // å‡†å¤‡å°ç¦ç”¨æˆ·
        function prepareBan(userId) {
            database.ref('users/' + userId).once('value').then(snapshot => {
                const user = snapshot.val();
                document.getElementById('banUserId').value = userId;
                document.getElementById('banUserName').value = user.name || '';
                showSection('bans');
            });
        }
        
        // å°ç¦ç”¨æˆ·
        async function banUser() {
            const userId = document.getElementById('banUserId').value.trim();
            const userName = document.getElementById('banUserName').value.trim();
            const reason = document.getElementById('banReason').value.trim() || 'è¿åç¤¾åŒºè§„åˆ™';
            const duration = document.getElementById('banDuration').value;
            
            if (!userId && !userName) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–ç”¨æˆ·å');
                return;
            }
            
            let targetUserId = userId;
            
            // å¦‚æœè¾“å…¥çš„æ˜¯ç”¨æˆ·åï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·ID
            if (!userId && userName) {
                try {
                    const encodedName = encodeURIComponent(userName);
                    const snapshot = await database.ref('usernames/' + encodedName).once('value');
                    if (!snapshot.exists()) {
                        showAlert('ç”¨æˆ·ä¸å­˜åœ¨');
                        return;
                    }
                    targetUserId = snapshot.val();
                } catch (error) {
                    showAlert('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥');
                    return;
                }
            }
            
            // è®¡ç®—è§£å°æ—¶é—´
            let unbanTime = null;
            if (duration !== 'permanent') {
                const hours = parseInt(duration);
                unbanTime = new Date(Date.now() + hours * 60 * 60 * 1000).toISOString();
            }
            
            const banData = {
                userId: targetUserId,
                userName: userName,
                reason: reason,
                bannedAt: new Date().toISOString(),
                unbanAt: unbanTime,
                bannedBy: 'admin'
            };
            
            try {
                await database.ref('bans/' + targetUserId).set(banData);
                
                // è®°å½•æ—¥å¿—
                await logAction('å°ç¦ç”¨æˆ·', `å°ç¦ç”¨æˆ· ${userName} (${targetUserId})ï¼ŒåŸå› ï¼š${reason}`);
                
                showAlert(`ç”¨æˆ· ${userName} å·²è¢«å°ç¦`);
                clearBanForm();
                loadBans();
                loadUsers();
                
            } catch (error) {
                console.error('å°ç¦å¤±è´¥:', error);
                showAlert('å°ç¦ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // æŸ¥æ‰¾ç”¨æˆ·ç”¨äºå°ç¦
        async function searchUserForBan() {
            const userName = document.getElementById('banUserName').value.trim();
            if (!userName) {
                showAlert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            try {
                const encodedName = encodeURIComponent(userName);
                const snapshot = await database.ref('usernames/' + encodedName).once('value');
                if (!snapshot.exists()) {
                    showAlert('ç”¨æˆ·ä¸å­˜åœ¨');
                    return;
                }
                
                const userId = snapshot.val();
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const user = userSnapshot.val();
                
                document.getElementById('banUserId').value = userId;
                document.getElementById('banUserName').value = user.name;
                
                showAlert(`æ‰¾åˆ°ç”¨æˆ·ï¼š${user.name} (ID: ${userId.substring(0, 12)}...)`);
                
            } catch (error) {
                console.error('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥:', error);
                showAlert('æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åŠ è½½å°ç¦åˆ—è¡¨
        async function loadBans() {
            const loadingEl = document.getElementById('bansLoading');
            const tableEl = document.getElementById('bansTable');
            const listEl = document.getElementById('bansList');
            const emptyEl = document.getElementById('noBans');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const snapshot = await database.ref('bans').once('value');
                
                if (snapshot.numChildren() === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                snapshot.forEach(child => {
                    const ban = child.val();
                    const unbanTime = ban.unbanAt ? formatTime(ban.unbanAt) : 'æ°¸ä¹…';
                    const isExpired = ban.unbanAt && new Date(ban.unbanAt) < new Date();
                    
                    html += `
                        <tr>
                            <td><code>${ban.userId.substring(0, 12)}...</code></td>
                            <td>${escapeHtml(ban.userName)}</td>
                            <td>${escapeHtml(ban.reason)}</td>
                            <td>${formatTime(ban.bannedAt)}</td>
                            <td>${unbanTime} ${isExpired ? '<span class="badge badge-warning">å·²è¿‡æœŸ</span>' : ''}</td>
                            <td>
                                <button class="btn btn-success" onclick="unbanUser('${ban.userId}')">è§£å°</button>
                                <button class="btn btn-danger" onclick="confirmAction('æ°¸ä¹…åˆ é™¤ç”¨æˆ·', 'deleteUser', '${ban.userId}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½å°ç¦åˆ—è¡¨å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½å°ç¦æ•°æ®å¤±è´¥');
            }
        }
        
        // è§£å°ç”¨æˆ·
        async function unbanUser(userId) {
            try {
                await database.ref('bans/' + userId).remove();
                
                // è®°å½•æ—¥å¿—
                await logAction('è§£å°ç”¨æˆ·', `è§£å°ç”¨æˆ· ${userId}`);
                
                showAlert('ç”¨æˆ·å·²è§£å°');
                loadBans();
                loadUsers();
                
            } catch (error) {
                console.error('è§£å°å¤±è´¥:', error);
                showAlert('è§£å°ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            try {
                // è·å–ç”¨æˆ·å
                const userSnapshot = await database.ref('users/' + userId).once('value');
                const user = userSnapshot.val();
                const userName = user ? user.name : 'æœªçŸ¥ç”¨æˆ·';
                
                // åˆ é™¤ç”¨æˆ·æ•°æ®
                await Promise.all([
                    database.ref('users/' + userId).remove(),
                    database.ref('usernames/' + encodeURIComponent(userName)).remove(),
                    database.ref('bans/' + userId).remove(),
                    database.ref('status/' + userId).remove()
                ]);
                
                // è®°å½•æ—¥å¿—
                await logAction('åˆ é™¤ç”¨æˆ·', `åˆ é™¤ç”¨æˆ· ${userName} (${userId})`);
                
                showAlert('ç”¨æˆ·å·²åˆ é™¤');
                loadUsers();
                loadBans();
                loadStats();
                
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showAlert('åˆ é™¤ç”¨æˆ·å¤±è´¥');
            }
        }
        
        // åŠ è½½æ¶ˆæ¯æ•°æ®
        async function loadMessages() {
            const loadingEl = document.getElementById('messagesLoading');
            const tableEl = document.getElementById('messagesTable');
            const listEl = document.getElementById('messagesList');
            const emptyEl = document.getElementById('noMessages');
            const forumFilter = document.getElementById('forumFilter').value;
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const forums = forumFilter === 'all' ? ['general', 'study', 'fun'] : [forumFilter];
                let allMessages = [];
                
                for (const forum of forums) {
                    const snapshot = await database.ref(`forums/${forum}/messages`).once('value');
                    snapshot.forEach(child => {
                        allMessages.push({
                            id: child.key,
                            forum: forum,
                            ...child.val()
                        });
                    });
                }
                
                // æŒ‰æ—¶é—´æ’åº
                allMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (allMessages.length === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let html = '';
                allMessages.slice(0, 100).forEach(msg => { // æœ€å¤šæ˜¾ç¤º100æ¡
                    html += `
                        <tr data-message-id="${msg.id}" data-forum="${msg.forum}">
                            <td>${formatTime(msg.timestamp)}</td>
                            <td>${escapeHtml(msg.userName || 'åŒ¿å')}</td>
                            <td>${getForumName(msg.forum)}</td>
                            <td>${escapeHtml(msg.text)}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteMessage('${msg.forum}', '${msg.id}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½æ¶ˆæ¯æ•°æ®å¤±è´¥');
            }
        }
        
        // æœç´¢æ¶ˆæ¯
        function searchMessages() {
            const searchTerm = document.getElementById('messageSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#messagesList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // åˆ é™¤æ¶ˆæ¯
        async function deleteMessage(forum, messageId) {
            try {
                await database.ref(`forums/${forum}/messages/${messageId}`).remove();
                
                // è®°å½•æ—¥å¿—
                await logAction('åˆ é™¤æ¶ˆæ¯', `åˆ é™¤ ${getForumName(forum)} çš„æ¶ˆæ¯ ${messageId}`);
                
                showAlert('æ¶ˆæ¯å·²åˆ é™¤');
                loadMessages();
                loadStats();
                
            } catch (error) {
                console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
                showAlert('åˆ é™¤æ¶ˆæ¯å¤±è´¥');
            }
        }
        
        // æ¸…ç©ºè®ºå›æ¶ˆæ¯
        async function clearForum(forum) {
            const forumName = getForumName(forum);
            
            if (confirm(`ç¡®å®šè¦æ¸…ç©º ${forumName} çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                try {
                    await database.ref(`forums/${forum}/messages`).remove();
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºè®ºå›', `æ¸…ç©º ${forumName} çš„æ‰€æœ‰æ¶ˆæ¯`);
                    
                    showAlert(`${forumName} å·²æ¸…ç©º`);
                    loadMessages();
                    loadForumsStats();
                    loadStats();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºè®ºå›å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºè®ºå›å¤±è´¥');
                }
            }
        }
        
        // åŠ è½½è®ºå›ç»Ÿè®¡
        async function loadForumsStats() {
            try {
                const forums = ['general', 'study', 'fun'];
                let html = '';
                
                for (const forum of forums) {
                    const snapshot = await database.ref(`forums/${forum}/messages`).once('value');
                    const totalMessages = snapshot.numChildren();
                    
                    // ä»Šæ—¥æ¶ˆæ¯æ•°
                    const today = new Date().toISOString().split('T')[0];
                    let todayMessages = 0;
                    snapshot.forEach(child => {
                        const msgTime = child.val().timestamp;
                        if (msgTime && msgTime.includes(today)) {
                            todayMessages++;
                        }
                    });
                    
                    // åœ¨çº¿ç”¨æˆ·æ•°
                    const onlineSnapshot = await database.ref('status').once('value');
                    let onlineInForum = 0;
                    onlineSnapshot.forEach(child => {
                        if (child.val().online && child.val().forum === forum) {
                            onlineInForum++;
                        }
                    });
                    
                    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                    document.getElementById(`forum${forum.charAt(0).toUpperCase() + forum.slice(1)}Count`).textContent = totalMessages;
                    
                    html += `
                        <tr>
                            <td>${getForumName(forum)}</td>
                            <td>${totalMessages}</td>
                            <td>${todayMessages}</td>
                            <td>${onlineInForum}</td>
                            <td>
                                <button class="btn btn-danger" onclick="clearForum('${forum}')">æ¸…ç©ºæ¶ˆæ¯</button>
                            </td>
                        </tr>
                    `;
                }
                
                document.getElementById('forumsStats').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½è®ºå›ç»Ÿè®¡å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ“ä½œæ—¥å¿—
        async function loadLogs() {
            const loadingEl = document.getElementById('logsLoading');
            const tableEl = document.getElementById('logsTable');
            const listEl = document.getElementById('logsList');
            const emptyEl = document.getElementById('noLogs');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            listEl.innerHTML = '';
            
            try {
                const snapshot = await database.ref('admin/logs').once('value');
                
                if (snapshot.numChildren() === 0) {
                    loadingEl.style.display = 'none';
                    emptyEl.style.display = 'block';
                    return;
                }
                
                let logs = [];
                snapshot.forEach(child => {
                    logs.push({
                        id: child.key,
                        ...child.val()
                    });
                });
                
                // æŒ‰æ—¶é—´æ’åº
                logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '';
                logs.slice(0, 50).forEach(log => {
                    html += `
                        <tr>
                            <td>${formatTime(log.timestamp)}</td>
                            <td>${escapeHtml(log.action)}</td>
                            <td>${escapeHtml(log.details)}</td>
                            <td>${escapeHtml(log.operator || 'ç³»ç»Ÿ')}</td>
                        </tr>
                    `;
                });
                
                listEl.innerHTML = html;
                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';
                
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                loadingEl.style.display = 'none';
                showAlert('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰èŠå¤©
        async function clearAllChats() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®ºå›çš„èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                try {
                    await Promise.all([
                        database.ref('forums/general/messages').remove(),
                        database.ref('forums/study/messages').remove(),
                        database.ref('forums/fun/messages').remove()
                    ]);
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºæ‰€æœ‰èŠå¤©', 'æ¸…ç©ºæ‰€æœ‰è®ºå›çš„èŠå¤©è®°å½•');
                    
                    showAlert('æ‰€æœ‰èŠå¤©è®°å½•å·²æ¸…ç©º');
                    loadMessages();
                    loadForumsStats();
                    loadStats();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºæ‰€æœ‰èŠå¤©å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥');
                }
            }
        }
        
        // æ›´æ–°ç®¡ç†å‘˜è®¾ç½®
        async function updateAdminSettings() {
            const newKey = document.getElementById('newAdminKey').value.trim();
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            const alertEl = document.getElementById('settingsAlert');
            
            if (newPassword && newPassword !== confirmPassword) {
                alertEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                alertEl.className = 'alert alert-error';
                alertEl.style.display = 'block';
                return;
            }
            
            try {
                const updates = {};
                const adminConfigRef = database.ref('admin/config');
                const snapshot = await adminConfigRef.once('value');
                const currentConfig = snapshot.val() || {};
                
                if (newKey) {
                    updates.adminKey = newKey;
                }
                
                if (newPassword) {
                    updates.adminPassword = newPassword;
                }
                
                updates.lastModified = new Date().toISOString();
                
                await adminConfigRef.update(updates);
                
                // è®°å½•æ—¥å¿—
                await logAction('æ›´æ–°è®¾ç½®', 'æ›´æ–°ç®¡ç†å‘˜è®¾ç½®');
                
                alertEl.textContent = 'è®¾ç½®å·²æ›´æ–°';
                alertEl.className = 'alert alert-success';
                alertEl.style.display = 'block';
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('newAdminKey').value = '';
                document.getElementById('newAdminPassword').value = '';
                document.getElementById('confirmAdminPassword').value = '';
                
            } catch (error) {
                console.error('æ›´æ–°è®¾ç½®å¤±è´¥:', error);
                alertEl.textContent = 'æ›´æ–°è®¾ç½®å¤±è´¥';
                alertEl.className = 'alert alert-error';
                alertEl.style.display = 'block';
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤å¯†ç 
        function resetAdminPassword() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤å¯†ç å—ï¼Ÿé‡ç½®åè¯·ä½¿ç”¨é»˜è®¤å¯†ç ç™»å½•ã€‚')) {
                document.getElementById('newAdminKey').value = 'admin2024';
                document.getElementById('newAdminPassword').value = 'xiaoyuan123';
                document.getElementById('confirmAdminPassword').value = 'xiaoyuan123';
                showAlert('å·²å¡«å…¥é»˜è®¤å¯†ç ï¼Œè¯·ç‚¹å‡»"æ›´æ–°è®¾ç½®"ä¿å­˜');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆå±é™©æ“ä½œï¼‰
        async function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€èŠå¤©è®°å½•å’Œè®¾ç½®ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (confirm('æœ€åç¡®è®¤ï¼šä½ çœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¾“å…¥"ç¡®è®¤åˆ é™¤"ç»§ç»­')) {
                    try {
                        // è¿™é‡Œå¯ä»¥æ·»åŠ å®Œæ•´çš„æ•°æ®æ¸…ç†é€»è¾‘
                        await database.ref().remove();
                        
                        // è®°å½•æ—¥å¿—
                        await logAction('æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€èŠå¤©è®°å½•å’Œè®¾ç½®');
                        
                        showAlert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼Œç³»ç»Ÿå·²é‡ç½®');
                        loadStats();
                        
                    } catch (error) {
                        console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                        showAlert('æ¸…ç©ºæ•°æ®å¤±è´¥');
                    }
                }
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            try {
                const snapshot = await database.ref().once('value');
                const data = snapshot.val();
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `æ ¡å›­ç½‘æ•°æ®å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                // è®°å½•æ—¥å¿—
                await logAction('å¯¼å‡ºæ•°æ®', 'å¯¼å‡ºæ‰€æœ‰æ•°æ®å¤‡ä»½');
                
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                showAlert('å¯¼å‡ºæ•°æ®å¤±è´¥');
            }
        }
        
        // å¤‡ä»½æ•°æ®
        function backupData() {
            exportData();
            showAlert('æ•°æ®å¤‡ä»½å·²å¼€å§‹ä¸‹è½½');
        }
        
        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—å—ï¼Ÿ')) {
                try {
                    await database.ref('admin/logs').remove();
                    
                    // è®°å½•æ—¥å¿—
                    await logAction('æ¸…ç©ºæ—¥å¿—', 'æ¸…ç©ºæ‰€æœ‰æ“ä½œæ—¥å¿—');
                    
                    showAlert('æ“ä½œæ—¥å¿—å·²æ¸…ç©º');
                    loadLogs();
                    
                } catch (error) {
                    console.error('æ¸…ç©ºæ—¥å¿—å¤±è´¥:', error);
                    showAlert('æ¸…ç©ºæ—¥å¿—å¤±è´¥');
                }
            }
        }
        
        // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        function refreshStats() {
            loadStats();
            showAlert('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
        }
        
        // è®¾ç½®å®æ—¶ç›‘å¬
        function setupRealtimeListeners() {
            // ç›‘å¬åœ¨çº¿ç”¨æˆ·å˜åŒ–
            database.ref('status').on('value', snapshot => {
                let onlineCount = 0;
                snapshot.forEach(child => {
                    if (child.val().online) onlineCount++;
                });
                document.getElementById('onlineUsers').textContent = onlineCount;
                
                // å¦‚æœå½“å‰åœ¨è®ºå›ç®¡ç†é¡µé¢ï¼Œæ›´æ–°è®ºå›åœ¨çº¿äººæ•°
                if (document.getElementById('forums').classList.contains('active')) {
                    loadForumsStats();
                }
            });
            
            // ç›‘å¬æ¶ˆæ¯å˜åŒ–
            ['general', 'study', 'fun'].forEach(forum => {
                database.ref(`forums/${forum}/messages`).on('value', snapshot => {
                    // å¦‚æœå½“å‰åœ¨æ¶ˆæ¯ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                    if (document.getElementById('messages').classList.contains('active')) {
                        loadMessages();
                    }
                    // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                    if (document.getElementById('dashboard').classList.contains('active')) {
                        loadStats();
                    }
                });
            });
        }
        
        // è®°å½•æ“ä½œæ—¥å¿—
        async function logAction(action, details) {
            try {
                const logRef = database.ref('admin/logs').push();
                await logRef.set({
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString(),
                    operator: 'ç®¡ç†å‘˜'
                });
            } catch (error) {
                console.error('è®°å½•æ—¥å¿—å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
        function confirmAction(message, action, data) {
            currentAction = action;
            currentData = data;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmActionBtn').onclick = executeAction;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ
        function executeAction() {
            if (currentAction && window[currentAction]) {
                window[currentAction](currentData);
            }
            closeModal();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentAction = null;
            currentData = null;
        }
        
        // æ˜¾ç¤ºæç¤º
        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').style.display = 'flex';
        }
        
        // å…³é—­æç¤º
        function closeAlert() {
            document.getElementById('alertModal').style.display = 'none';
        }
        
        // æ¸…ç©ºå°ç¦è¡¨å•
        function clearBanForm() {
            document.getElementById('banUserId').value = '';
            document.getElementById('banUserName').value = '';
            document.getElementById('banReason').value = '';
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('admin_session');
            window.location.href = 'admin-login.html';
        }
        
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN');
        }
        
        // å·¥å…·å‡½æ•°ï¼šè·å–è®ºå›åç§°
        function getForumName(forumId) {
            const names = {
                'general': 'ç»¼åˆè®¨è®ºåŒº',
                'study': 'å­¦ä¹ äº¤æµ',
                'fun': 'ä¼‘é—²å¨±ä¹'
            };
            return names[forumId] || forumId;
        }
        
        // å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
                  </html>
